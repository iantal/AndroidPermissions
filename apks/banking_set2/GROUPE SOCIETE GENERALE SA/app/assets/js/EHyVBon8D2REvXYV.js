Class.ns("Bankingapp.functions.billpayment.billerselection");$().loadJavaScript("/js/GbyLuVz1r2rbR3xe.js");$().loadJavaScript("/js/PUwXzF4S9SpqK3t6.js");$().loadJavaScript("/js/CIFtopMXfGaAbp6U.js");$().loadJavaScript("/js/1hyf9OWY93mTBudZ.js");Bankingapp.functions.billpayment.billerselection.BillerSelection=Class.extend(Bankingapp.framework.View,{container:null,showProgressIndicator:true,progressIndicatorStepCount:5,progressIndicatorCurrentStep:1,billerListMapKeyName:null,lastItemCount:0,layoutRender:function(){this.container=$("<div>",{id:"billerSelectionMainContainer","class":"list maincontainer"});if(this.showProgressIndicator){this.container.append(new Bankingapp.ui.ProgressIndicator(this.progressIndicatorStepCount,this.progressIndicatorCurrentStep));}this.selectCompanyTitle=new Bankingapp.ui.Label(resolve("bankingapp_brd_function_billpayment_billerselection_title"),{"class":"pagetitle separator textcenter"});this.container.append(this.selectCompanyTitle);var a=["billerCompanyName","billerSubAgentAccount","billerSubAgentName"];this.search=new Bankingapp.ui.SearchField({searchConfig:{propertyArray:a,triggerdelay:500,errorTriggerdelay:1000,validation:{whitelist:false}}});this.search.bind("search",$.proxy(this.handleSearchResult,this));this.search.bind("clear",$.proxy(this.handleClearResult,this));this.container.append(this.search);this.emptyResultMessageContainer=$("<div>",{id:"emptyResultMessageContainer","class":"emptyResultMessageContainer"});this.container.append(this.emptyResultMessageContainer);debugLog("val: ",this.search.val());return this.container;},run:function(){this.billerListMapKeyName="BILLPAYMENT_BILLERLIST_"+getFunctionAttribute("BILLPAYMENT_SOURCEACCOUNT").currency;var a=getFunctionAttribute(this.billerListMapKeyName);debugLog("BILLPAYMENT_SOURCEACCOUNT",getFunctionAttribute("BILLPAYMENT_SOURCEACCOUNT"));if((a===null)||(a===undefined)){var b={BillerCategoryListRequest:{BillPaymentSourceAccountNumber:getFunctionAttribute("BILLPAYMENT_SOURCEACCOUNT").accountNumber}};debugLog("request",b);Bankingapp.framework.Application.callService("/billpayment/getBillerList",b,$.proxy(this.handleBillerListResult,this));}else{this.handleBillerListResult(a);}},handleBillerListResult:function(a){if((getFunctionAttribute(this.billerListMapKeyName)===null)||(getFunctionAttribute(this.billerListMapKeyName)===undefined)){setFunctionAttribute(this.billerListMapKeyName,a);}this.search.input.lastText="dummytext";this.search.setListData(a);this.search.input.hintClass=$.encoder.encodeForHTMLAttribute("class",this.search.input.hintClass,true);this.search.input.data("hint",$.trim($.encoder.encodeForHTML(resolve("bankingapp_brd_function_billpayment_billerselection_search_hint"))));this.search.input.addHint();this.search.input.blur($.proxy(this.search.input.addHint,this.search.input));this.search.input.focus($.proxy(this.search.input.removeHint,this.search.input));},refreshBillerList:function(d){this.lastItemCount=0;$("#fel").remove();this.renderResultMessage(d);debugLog("refreshBillerList inputList",d);$("#billerSelectionContainer").remove();var b=this.transformToExpandableList(d);debugLog("transformResult:",b);this.billerSelectionContainer=$("<div>",{id:"billerSelectionContainer","class":"list maincontainer"});for(var c in b){this.lastItemCount=this.lastItemCount+1;var e=$("<div>",{id:"billerSelectionItemContainer"+this.lastItemCount,"class":"list maincontainer"});var a=new Bankingapp.ui.Label(b[c].billerCategoryName,{"class":"listtitle"});if((b[c].billerCompanyList===null)||(b[c].billerCompanyList===undefined)){b[c].billerCompanyList=[];}var f=new Bankingapp.ui.ExpandableList({listData:b[c].billerCompanyList,secondLevelListName:"billerSubAgentList",itemRenderer:Bankingapp.functions.billpayment.billerselection.BillerSelectionItem,secondLevelItemRenderer:Bankingapp.functions.billpayment.billerselection.BillerSelectionItemSecondLevel});f.clickEventHandler=function(){};f.unbind("itemClick");f.bind("itemClick",$.proxy(this.itemClickHandler,this));if(this.lastItemCount==b.length){e.unbind("click");e.clickEventHandler=function(){};e.bind("click",$.proxy(this.listClickHandler,this));}e.append(a);e.append(f);this.billerSelectionContainer.append(e);}this.container.append(this.billerSelectionContainer);this.container.append($("<div>",{id:"fel"}));},listClickHandler:function(b,c,a){setTimeout(function(){$("html, body").animate({scrollTop:$("#fel").offset().top},500);},300);},itemClickHandler:function(a,b){debugLog("item clicked",b);setFunctionAttribute("BILLPAYMENT_SUBAGENTID",b.billerSubAgentId);setFunctionAttribute("BILLPAYMENT_SUBAGENTNAME",b.billerSubAgentName);removeFunctionAttribute(Functions.transferfunds.TransferUtils.BILLPAYMENTRANSFER_FORMDATA);removeFunctionAttribute(Functions.transferfunds.TransferUtils.BILLPAYMENTRANSFER_FORECAST_REQUEST);removeFunctionAttribute(Functions.transferfunds.TransferUtils.BILLPAYMENTRANSFER_FORECAST_REPLY);removeFunctionAttribute(Functions.transferfunds.TransferUtils.BILLPAYMENTRANSFER_SIGN_CREDENTIAL);removeFunctionAttribute(Functions.transferfunds.TransferUtils.BILLPAYMENTRANSFER_SIGN_REPLY);loadView("view://brd/bankingapp/function/billpayment/adddetails",{BILLPAYMENT_SUBAGENTID:b.billerSubAgentId});},handleSearchResult:function(b,a){debugLog("handleSearchResult");this.refreshBillerList(a.array);},handleClearResult:function(b,a){debugLog("handleClearResult");debugLog(a);this.refreshBillerList(a.array);},transformToExpandableList:function(d){var b={};for(var p in d){var h=d[p].billerCategoryName;var s=null;if((b[h]!=null)&&(b[h]!=undefined)){s=b[h];}else{s=new Array();}var m={};m.billerCompanyName=d[p].billerCompanyName;m.billerSubAgentName=d[p].billerSubAgentName;m.billerSubAgentAccount=d[p].billerSubAgentAccount;m.billerSubAgentId=d[p].billerSubAgentId;s.push(m);b[h]=s;}debugLog("categoryMap",b);var q=new Array();for(var p in b){var a={};for(var o in b[p]){var t=b[p][o].billerCompanyName;var c=b[p][o].billerSubAgentName;var f=b[p][o].billerSubAgentAccount;var e=b[p][o].billerSubAgentId;var l=null;if((a[t]!=null)&&(a[t]!=undefined)){l=a[t];}else{l=new Array();}var m={};m.billerSubAgentName=c;m.billerSubAgentAccount=f;m.billerSubAgentId=e;l.push(m);a[t]=l;}var n=new Array();for(var g in a){var r={};r.billerCompanyName=g;r.billerSubAgentList=a[g];n.push(r);}var k={};k.billerCategoryName=p;k.billerCompanyList=n;q.push(k);}debugLog("billerCategoryArray:",q);return q;},renderResultMessage:function(a){$("#noResultMessage").remove();if(a.length===0){$("#emptyResultMessageContainer").append($("<div>",{id:"noResultMessage","class":"noResultMessage"}).append(resolve("bankingapp_brd_function_billpayment_billerselection_search_noresult")));}}});Bankingapp.framework.Application.setView(Bankingapp.functions.billpayment.billerselection.BillerSelection);