$().loadJavaScript("/js/1hyf9OWY93mTBudZ.js");$().loadJavaScript("/js/CF0WiFs1SjIy0Szl.js");$().loadJavaScript("/js/0A4YRnFx1DbUd3zN.js");$().loadJavaScript("/js/AZPz8vN1TNFqZWpw.js");Class.ns("Bankingapp.functions.transferfunds.qrpayment");Bankingapp.functions.transferfunds.qrpayment.TheOneWithTheSignButton=Class.extend(Bankingapp.framework.View,{showProgressIndicator:true,progressIndicatorStepCount:Functions.transferfunds.TransferUtils.QRTRANSFER_STEPCOUNT,progressIndicatorCurrentStep:4,container:null,formData:null,signBlock:null,type_resourcePre:"bankingapp_brd_function_accountinfo_accounttype_",groupcontainer:null,dateFormatPatternResourceKey:resolve("bankingapp_brd_function_qrpayment_further_details_formdata_dateformat"),layoutRender:function(){this.container=$("<div>",{id:"forecastCt","class":"maincontainer internaltransfer transactiondetails"});if(this.showProgressIndicator){this.container.append(new Bankingapp.ui.ProgressIndicator(this.progressIndicatorStepCount,this.progressIndicatorCurrentStep));}this.groupcontainer=$("<div>",{"class":"paymentdetail groupcontainer"});return this.container;},errorMessageHandler:function(b,a){Bankingapp.framework.event.ServiceMessageHandler.errorMessageHandler(b,a);this.signBlock.remove();this.signBlock=new Bankingapp.ui.ManualSignBlock({signMode:Functions.transferfunds.TransferUtils.SIGNMODE,tokenSubmitResourceKey:"bankingapp_brd_function_qrpayment_signpage_signtransactionbutton",submitButtonResourceKey:"bankingapp_brd_function_qrpayment_signpage_signtransactionbutton"});this.signBlock.bind("formSubmitted",$.proxy(this.submitHandler,this));this.container.append(this.signBlock);},run:function(){Bankingapp.framework.Application.unBind("onErrorMessageReceived");$("body").bind("onErrorMessageReceived",$.proxy(this.errorMessageHandler,this));Bankingapp.framework.event.BrdServiceMessageHandler.handleMessages();var e=getFunctionAttribute(Functions.transferfunds.TransferUtils.QRTRANSFER_FORECAST_REPLY);this.formData=getFunctionAttribute(Functions.transferfunds.TransferUtils.QRTRANSFER_FORMDATA);debugLog("this.formData");debugLog(this.formData);var d=getFunctionAttribute("QRPAYMENT_SOURCEACCOUNT");this.container.append(new Bankingapp.functions.util.component.TransactionSummary({summaryData:{upperTitle:d.accountName,upperText:resolve("bankingapp_brd_function_qrpayment_signpage_accountandcurrency",{"0":d.accountType,"1":d.currency}),amount:-e.authorizationData.amount,currency:e.authorizationData.currency,lowerTitle:this.formData.forecastRequest.beneficiaryName,lowerText:this.formData.forecastRequest.targetAccount,creditDebitFlag:"D"}}));var c=this.formData.forecastRequest.description;if(c!=null&&c!=undefined&&c!=""){this.groupcontainer.append(new Bankingapp.ui.OutputField(resolve("bankingapp_brd_function_qrpayment_signpage_description"),this.formData.forecastRequest.description));}var b=$().dateParserWithoutTimezone(this.formData.forecastRequest.valueDate);this.groupcontainer.append(new Bankingapp.ui.OutputField(resolve("bankingapp_brd_function_qrpayment_signpage_date"),b.dateFormat(this.dateFormatPatternResourceKey)));if(Functions.transferfunds.TransferUtils.isCrossOverCurrencyAndOwnBank(d.currency,this.formData.forecastRequest.currency,this.formData.qrData.targetAccountNumber)){this.groupcontainer.append(new Bankingapp.ui.OutputField(resolve("bankingapp_brd_function_qrpayment_amount_in_target_currency"),(new Bankingapp.functions.util.component.Amount({currency:e.forecastReply.fXAmountData.toCurrency,amount:e.forecastReply.fXAmountData.toAmount,decorate:true})).value));this.groupcontainer.append(new Bankingapp.ui.OutputField(resolve("bankingapp_brd_function_qrpayment_fxrate"),e.forecastReply.fXAmountData.fXRate));}if(Functions.transferfunds.TransferUtils.isTrezTargetAccount(this.formData.qrData.targetAccountNumber)){this.groupcontainer.append(new Bankingapp.ui.OutputField(resolve("bankingapp_brd_function_qrpayment_cuicnp"),e.forecastReply.cUI_CNP));}var a=this.formData.forecastRequest.referenceNumber;if(a!=null&&a!=undefined&&a!=""){this.groupcontainer.append(new Bankingapp.ui.OutputField(resolve("bankingapp_brd_function_qrpayment_signpage_referencenumber"),this.formData.forecastRequest.referenceNumber));}this.container.append(this.groupcontainer);this.signBlock=new Bankingapp.ui.ManualSignBlock({signMode:Functions.transferfunds.TransferUtils.SIGNMODE,tokenSubmitResourceKey:"bankingapp_brd_function_qrpayment_signpage_signtransactionbutton",submitButtonResourceKey:"bankingapp_brd_function_qrpayment_signpage_signtransactionbutton"});this.signBlock.bind("formSubmitted",$.proxy(this.submitHandler,this));this.container.append(this.signBlock);},submitHandler:function(){setFunctionAttribute(Functions.transferfunds.TransferUtils.QRTRANSFER_SIGN_CREDENTIAL,this.signBlock.getCredential());Bankingapp.framework.Application.callService("/qrtransfer/perform",{PerformTransactionOperationRequest:{credential:getFunctionAttribute(Functions.transferfunds.TransferUtils.QRTRANSFER_SIGN_CREDENTIAL),book:true,sign:true,fingerPrint:this.signBlock.getIsFingerprint()}},$.proxy(this.handleSignResult,this));},handleSignResult:function(a){debugLog("sign result");debugLog(a);setFunctionAttribute(Functions.transferfunds.TransferUtils.QRTRANSFER_SIGN_REPLY,a);loadView("view://brd/bankingapp/function/transferfunds/qrpayment/resultpage",null);}});Bankingapp.framework.Application.setView(Bankingapp.functions.transferfunds.qrpayment.TheOneWithTheSignButton);