Class.ns("Bankingapp.functions.receivemoney.requestmoney");$().loadJavaScript("/js/1hyf9OWY93mTBudZ.js");Bankingapp.functions.receivemoney.requestmoney.PartnerSelect=Class.extend(Bankingapp.framework.View,{container:null,containerLabel:null,amountField:null,descriptionField:null,valueDateButton:null,groupContainer:null,partners:null,transactionItem:null,remainingAmount:null,formData:null,forecastRequest:null,currency:null,phoneNumberListResourceKey:"bankingapp_brd_function_requestmoney_phone_numberlist",showProgressIndicator:true,progressIndicatorStepCount:3,progressIndicatorCurrentStep:1,layoutRender:function(){this.formData=getFunctionAttribute(Functions.transferfunds.TransferUtils.REQUESTMONEYTRANSFER_FORMDATA);this.currency=this.formData.targetAccount.currency;this.container=$("<div>",{id:"partnerSelectMainContainer","class":"maincontainer"});this.containerLabel=$("<div>",{id:"labelContainer","class":"list maincontainer"});this.splitPartnerLabel=new Bankingapp.ui.Label(resolve("bankingapp_brd_function_requestmoney_partnerselect_label"),{"class":"pagetitle separator"});this.containerLabel.append(this.splitPartnerLabel);this.container.append(this.containerLabel);this.containerButton=$("<div>",{id:"selectContactButtonContainer","class":"buttonholdercontainer"});this.selectContactButton=new Bankingapp.ui.SubmitButton(resolve("bankingapp_brd_function_requestmoney_partnerselect_selectcontact_button"),{id:"selectContactButton","class":"selectContactButton"});this.selectContactButton.bind("buttonClick",$.proxy(this.selectContactHandler,this));this.containerButton.append(this.selectContactButton);this.container.append(this.containerButton);this.groupContainer=$("<div>",{"class":"groupcontainer"});this.partnerField=new Bankingapp.ui.InputField(resolve("bankingapp_brd_function_requestmoney_partnerselect_beneficiaryname_field"),{id:"partnerName",name:"partnerName",type:"text",value:(this.formData.partnerName?this.formData.partnerName:""),validation:{required:true,maxlength:150}});this.groupContainer.append(this.partnerField);this.phoneNumberField=new Bankingapp.ui.InputField(resolve("bankingapp_brd_function_requestmoney_partnerselect_phonenumber_field"),{id:"phoneNumberField",name:"phoneNumberField",type:"text",value:(this.formData.phoneNumber?this.formData.phoneNumber:""),inputMaskPattern:/[+\d]/,validation:{required:true,maxlength:200,whitelist:false}});this.groupContainer.append(this.phoneNumberField);this.currencyField=new Bankingapp.ui.InputField(resolve("bankingapp_brd_function_requestmoney_partnerselect_currency_field"),{id:"currencyField",name:"currencyField",type:"text",value:(this.currency?this.currency:""),validation:{maxlength:200,}});this.currencyField.disable();this.groupContainer.append(this.currencyField);this.amountField=new Bankingapp.ui.InputField(resolve("bankingapp_brd_function_requestmoney_partnerselect_amount_field"),{id:"amount",name:"amount",type:Functions.transferfunds.TransferUtils.getAmountInputFieldType(),value:(this.formData.amount?this.formData.amount:""),inputMaskPattern:/[0-9.,\+\-]/,validation:{whitelist:false,required:true,min:1,max:999999999999,number:true,maxlength:12}});this.groupContainer.append(this.amountField);this.descriptionField=new Bankingapp.ui.InputField(resolve("bankingapp_brd_function_requestmoney_partnerselect_description_field"),{id:"descriptionField",name:"descriptionField",type:"text",value:(this.formData.description?this.formData.description:""),validation:{required:false,maxlength:150}});this.groupContainer.append(this.descriptionField);var a=new Date();this.valueDateButton=new Bankingapp.ui.ComplexButton([a.dateFormat(resolve("bankingapp_common_dateFormatPattern_per"))],{id:"valueDateButton","class":"calendar"});this.valueDateButton.bind("buttonClick",$.proxy(this.valueDateButtonClickHandler,this));this.groupContainer.append(new Bankingapp.ui.LabeledComponent({labelText:resolve("bankingapp_function_transferfunds_valuedate"),valueComponent:this.valueDateButton}));this.containerButton=$("<div>",{id:"addContactButtonContainer","class":"buttonholdercontainer"});this.form=new Bankingapp.ui.Form({id:"transferDetailsForm",submitHandler:$.proxy(this.submitHandler,this),businessValidationHandler:$.proxy(this.businessValidator,this),"class":"transfer-details-form"});this.form.append(this.groupContainer);this.form.append(new Bankingapp.ui.SubmitButton(resolve("bankingapp_brd_function_requestmoney_continue_button"),{"class":"submit"}));this.container.append(this.form);return this.container;},run:function(){if(this.formData.valueDate&&this.valueDateButton){this.displayValueDate(this.formData.valueDate);}else{this.formData.valueDate=new Date();debugLog("run valueDate: "+this.formData.valueDate);}},businessValidator:function(){var h=this.formData.valueDate;var e=new Date();e=e.setHours(0,0,0,0);if(h<e){debugLog("date validation: ");debugLog("valuedate: "+h+" today: "+e);showError(resolve("bankingapp_function_domestictransfer_date_past_error"));return false;}var d=false;var f=getFunctionAttribute(Functions.transferfunds.TransferUtils.REQUESTMONEYTRANSFER_INITDATA);if(f&&f.validPhoneNumberPrefixes){var b=f.validPhoneNumberPrefixes.split(",");var j=this.phoneNumberField.val();var g=null;var k=null;if(j.indexOf("+")==0){if(j.length==12&&j.substring(1,3)=="40"){g=j.substring(3,5);k=j.substring(5,12);d=true;}}else{if(j.indexOf("00")==0){if(j.length==13&&j.substring(2,4)=="40"){g=j.substring(4,6);k=j.substring(6,13);d=true;}}else{if(j.indexOf("0")==0){if(j.length==10){g=j.substring(1,3);k=j.substring(3,10);d=true;}}}}if(d){d=false;for(var c=0;c<b.length;c++){var a=b[c];if(a==g){d=true;break;}}}if(!d){showError(resolve("bankingapp_brd_function_requestmoney_phone_validation"));return false;}this.phoneNumberField.setValue("+40"+g+k);}return true;},submitHandler:function(){var a=null;if(this.formData.valueDate){if(jQuery.type(this.formData.valueDate)==="date"){a=$().formatDateForRequest(this.formData.valueDate);}else{a=this.formData.valueDate;}}this.forecastRequest={targetAccount:this.formData.targetAccount.accountNumber,partnerName:this.partnerField.val(),phoneNumber:this.phoneNumberField.val(),amount:this.amountField.val(),currency:this.currency,description:this.descriptionField.val(),valueDate:a};$.extend(this.formData,{amount:this.forecastRequest.amount,currency:this.forecastRequest.currency,partnerName:this.forecastRequest.partnerName,phoneNumber:this.forecastRequest.phoneNumber,description:this.forecastRequest.description,valueDate:this.forecastRequest.valueDate});setFunctionAttribute(Functions.transferfunds.TransferUtils.REQUESTMONEYTRANSFER_FORMDATA,this.formData);setFunctionAttribute(Functions.transferfunds.TransferUtils.REQUESTMONEYTRANSFER_FORECAST_REQUEST,this.forecastRequest);callService({serviceName:"/requestmoney/forecast",request:{RequestMoneyTransferRequest:this.forecastRequest},callback:Bankingapp.framework.Application.proxy(this.handleForecastRequest,this,true)});},selectContactHandler:function(){showContactPicker(Bankingapp.framework.Application.proxy(this.showContactPickerCallback,this,true));},showContactPickerCallback:function(a){this.partnerField.setValue(this.joinNames(a.name));if(a.phoneNumbers.length>1){var d=[];for(var b=0;b<a.phoneNumbers.length;b++){var c=this.formPhoneNumber(a.phoneNumbers[b].phoneNumber);if(c){d.push(c);}}showListPicker(resolve(this.phoneNumberListResourceKey),d,Bankingapp.framework.Application.proxy(this.showListPickerCallback,this,true));}else{var c=this.formPhoneNumber(a.phoneNumbers[0].phoneNumber);if(c){this.phoneNumberField.setValue(c);}}},showListPickerCallback:function(a){this.phoneNumberField.setValue(a);},formPhoneNumber:function(a){var b=undefined;if(a){b=a.replace(/-/g,"").replace(/\//g,"").replace(/\s/g,"");if(b.indexOf("(072)")==0){b=b.replace("(072)","+4072");}b=b.replace("(","").replace(")","");}return b;},joinNames:function(b){var a=(b.prefix?b.prefix+" ":"")+(b.firstName?b.firstName+" ":"")+(b.middleName?b.middleName+" ":"")+(b.lastName?b.lastName+" ":"")+(b.suffix?b.suffix+" ":"");return a.trim();},valueDateButtonClickHandler:function(b,a){showDatePicker(Bankingapp.framework.Application.proxy(this.datePickerHandler,this,true));},datePickerHandler:function(a){debugLog("datepickhandler valueDate: "+a);this.formData.valueDate=a;this.displayValueDate(a);},displayValueDate:function(a){$("#valueDateButton").find(".row0").text(a.dateFormat(resolve("bankingapp_common_dateFormatPattern")));},handleForecastRequest:function(a){setFunctionAttribute(Functions.transferfunds.TransferUtils.REQUESTMONEYTRANSFER_FORECAST_REPLY,a);loadView("view://brd/bankingapp/function/receivemoney/requestmoney/forecast",null);},});Bankingapp.framework.Application.setView(Bankingapp.functions.receivemoney.requestmoney.PartnerSelect);