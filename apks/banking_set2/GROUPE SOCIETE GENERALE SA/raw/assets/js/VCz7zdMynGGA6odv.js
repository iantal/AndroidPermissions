$().loadJavaScript("/js/cNGJpPRjrlEySoCA.js");$().loadJavaScript("/js/1hyf9OWY93mTBudZ.js");$().loadJavaScript("/js/pJlSmt5Kok7E2Ukr.js");$().loadJavaScript("/js/3P7bJV5LvaZ3Os8W.js");Class.ns("Bankingapp.functions.receivemoney.bringyourmoney");Bankingapp.functions.receivemoney.bringyourmoney.TransactionDetails=Class.extend(Bankingapp.framework.View,{progressIndicatorStepCount:Functions.transferfunds.TransferUtils.BRINGYOURMONEY_STEPCOUNT_1,formDataFunctionAttributeId:Functions.transferfunds.TransferUtils.BRINGYOURMONEY_FORMDATA,initDataFunctionAttributeId:Functions.transferfunds.TransferUtils.BRINGYOURMONEY_INITDATA,mpiDataFunctionAttributeId:Functions.transferfunds.TransferUtils.BRINGYOURMONEY_MPIDATA,progressIndicatorCurrentStep:1,showPageInstructions:true,showProgressIndicator:true,containerId:"detailsCt",containerClass:"internaltransfer maincontainer bringyourmoney-transferdetails",form:null,formId:"transferDetailsForm",formClass:"transfer-details-form",groupContainer:null,groupContainerClass:"groupcontainer",submitButtonLabelResourceKey:"bankingapp_brd_function_bringyourmoney_transferdetails_continue",submitButtonClass:"submit",pageInstructionsClass:"pagetitle separator left",pageInstructionsResourceKey:"bankingapp_brd_function_bringyourmoney_transferdetails_information_label",currencyResourceKey:"bankingapp_brd_function_bringyourmoney_transferdetails_currency",currencyPopupResourceKey:"bankingapp_brd_function_bringyourmoney_currency_popup_title",customerNameFieldResourceKey:"bankingapp_brd_function_bringyourmoney_transferdetails_customername",amountResourceKey:"bankingapp_brd_function_bringyourmoney_transferdetails_amount",targetAccountFieldResourceKey:"bankingapp_brd_function_bringyourmoney_transferdetails_targetaccount",comboClass:"selectComboContainer combo inputfirst",emptyStringResourceKey:"bankingapp_brd_function_bringyourmoney_select",formData:null,layoutRender:function(){this.initData=getFunctionAttribute(this.initDataFunctionAttributeId);this.mpiData=getFunctionAttribute(this.mpiDataFunctionAttributeId);this.formData=getFunctionAttribute(this.formDataFunctionAttributeId);if((this.formData==undefined)||(this.formData==null)){debugLog("formdata is not defined ...");this.formData={};}else{if(this.formData.progressIndicatorCurrentStep!=undefined&&this.formData.progressIndicatorCurrentStep!=null){this.progressIndicatorCurrentStep=this.formData.progressIndicatorCurrentStep+2;debugLog("new progressIndicatorCurrentStep: "+this.progressIndicatorCurrentStep);this.progressIndicatorStepCount=Functions.transferfunds.TransferUtils.BRINGYOURMONEY_STEPCOUNT_2;}if(this.formData.savedCardId!=undefined&&this.formData.savedCardId!=null){debugLog("savedCardId: "+this.formData.savedCardId);this.savedCardId=this.formData.savedCardId;}}this.container=$("<div>",{id:this.containerId,"class":this.containerClass});if(this.showProgressIndicator){this.container.append(new Bankingapp.ui.ProgressIndicator(this.progressIndicatorStepCount,this.progressIndicatorCurrentStep));}if(this.showPageInstructions){this.container.append(new Bankingapp.ui.Label(resolve(this.pageInstructionsResourceKey),{"class":this.pageInstructionsClass}));}this.form=new Bankingapp.ui.Form({id:this.formId,submitHandler:$.proxy(this.submitHandler,this),businessValidationHandler:$.proxy(this.businessValidator,this),"class":this.formClass});this.groupContainer=$("<div>",{"class":this.groupContainerClass});this.groupContainerMPIFrequency=$("<div>",{"class":this.groupContainerClass});this.frequencyField=new Bankingapp.ui.InputField({labelText:resolve("bankingapp_brd_function_bringyourmoney_mpi_frequency"),inputRenderer:Bankingapp.ui.SelectButton,required:true,inputConfig:{id:"frequencySelect",value:null,emptyString:resolve(this.emptyStringResourceKey),popupName:resolve(this.currencyPopupResourceKey)},baseInputContainerClass:this.comboClass});this.groupContainerMPIFrequency.append(this.frequencyField);this.frequencyField.getInputComponent().bind("afterSelect",$.proxy(this.onSelectFrequency,this));var a=new Date();a.setYear(a.getFullYear()+1);var b=a.dateFormat(resolve("bankingapp_brd_function_bringyourmoney_mpi_frequencyexpirydate_format"));this.frequencyExpiryDate=new Bankingapp.ui.ComplexButton([b],{id:"frequencyExpiryDate","class":"calendar"});this.frequencyExpiryDate.bind("buttonClick",$.proxy(this.frequencyExpiryDateClickHandler,this));this.groupContainerMPIFrequency.append(new Bankingapp.ui.LabeledComponent({labelText:(resolve("bankingapp_brd_function_bringyourmoney_mpi_frequencyexpirydate")+resolve("bankingapp_component_inputfield_requiredsign")),valueComponent:this.frequencyExpiryDate}));this.frequencyExpiryDateValue=new Date().dateFormat(resolve("bankingapp_brd_function_bringyourmoney_mpi_frequencyexpirydate_format"));this.recurrenceCheckbox=new Bankingapp.functions.util.component.DisclaimerCheckbox1({labelText:resolve("bankingapp_brd_function_bringyourmoney_mpi_frequency_checkbox"),"class":"checkWithoutLabel"});this.recurrenceCheckbox.bind("checkboxClick1",$.proxy(this.recurrenceCheckBoxClickHandler,this));this.groupContainerMPIFrequency.hide();if(this.formData.isRecurring&&this.formData.isRecurring==true){this.recurrenceCheckbox.disable();}else{this.recurrenceCheckbox.enable();}this.saveCardCheckbox=new Bankingapp.functions.util.component.DisclaimerCheckbox1({labelText:resolve("bankingapp_brd_function_bringyourmoney_mpi_savecard_checkbox"),"class":"checkWithoutLabel"});this.saveCardCheckbox.bind("checkboxClick1",$.proxy(this.saveCardCheckboxClickHandler,this));this.renderForm();this.renderSubmitButton();if(this.formData.savedCardId!=undefined&&this.formData.savedCardId!=null){this.saveCardCheckbox.disable();this.saveCardCheckbox.setValue(false);this.saveCardCheckbox.updateClass();this.submitButton.enable();}else{this.saveCardCheckbox.enable();this.saveCardCheckbox.setValue(false);this.saveCardCheckbox.updateClass();}return this.container;},renderForm:function(){debugLog("Transfer details renderForm ...");this.form.append(this.groupContainer);this.form.append(this.recurrenceCheckbox);this.form.append(this.groupContainerMPIFrequency);this.form.append(this.saveCardCheckbox);this.container.append(this.form);this.initData=getFunctionAttribute(this.initDataFunctionAttributeId);debugLog("TransferDetails, customer name: "+this.initData.customerName);return this.container;},run:function(){debugLog("run ...");this.customerNameField=new Bankingapp.ui.InputField(resolve(this.customerNameFieldResourceKey),{id:"customerNameField",name:"customerNameField",type:"text",value:this.initData.customerName,required:true,readonly:true,validation:{required:true,whitelist:false,maxlength:200}});this.groupContainer.append(this.customerNameField);var b=this.formData.targetAccount.accountNumber;debugLog("account number: "+b);this.targetAccountField=new Bankingapp.ui.InputField({labelText:resolve(this.targetAccountFieldResourceKey),inputRenderer:Bankingapp.ui.SelectButton,required:true,inputConfig:{id:"bym-targetAccountSelect",value:null,emptyString:resolve(this.emptyStringResourceKey),showList:function(c){debugLog("hacked showList ...");goToPreviousView("view://brd/bankingapp/function/receivemoney/bringyourmoney/targetaccountselection");}},baseInputContainerClass:this.comboClass,validation:{required:true,whitelist:false,maxlength:200}});this.groupContainer.append(this.targetAccountField);this.targetAccountField.getInputComponent().setDatas([b]);this.targetAccountField.setValue(b);this.targetAccountField.enable();this.amountField=new Bankingapp.ui.InputField(resolve(this.amountResourceKey),{id:"amount",name:"amount",type:Functions.transferfunds.TransferUtils.getAmountInputFieldType(),value:"",inputMaskPattern:/[0-9.,\+\-]/,validation:{whitelist:false,required:true,min:0,max:999999999999,number:true,maxlength:12}});this.groupContainer.append(this.amountField);this.currencyField=new Bankingapp.ui.InputField({labelText:resolve(this.currencyResourceKey),inputRenderer:Bankingapp.ui.SelectButton,required:true,inputConfig:{id:"currencySelect",value:null,emptyString:resolve(this.emptyStringResourceKey),popupName:resolve(this.currencyPopupResourceKey)},baseInputContainerClass:this.comboClass});this.groupContainer.append(this.currencyField);this.currencyField.getInputComponent().bind("afterSelect",$.proxy(this.onSelectCurrency,this));var a=this;this.currencyList=null;this.currencies=[];if((this.initData!=undefined)&&this.initData!=null&&this.initData.currencies!=undefined&&this.initData.currencies!=null){this.currencyList=this.initData.currencies;$.each(this.currencyList,function(c,d){debugLog("value: "+d.currencyCode);if($.inArray(d.currencyCode,a.currencies)==-1){a.currencies.push(d.currencyCode);debugLog("added ...");}});}debugLog(this.currencies);this.currencyField.getInputComponent().setDatas(this.currencies);this.currencyField.setValue(this.currencies[0]);if(this.currencies.length==1){this.currencyField.disable();}else{debugLog("enable currency field ...");this.currencyField.enable();if(this.formData.savedCurrency!=undefined&&this.formData.savedCurrency!=null){this.currencyField.setValue(this.formData.savedCurrency);}}this.frequencyList=null;this.frequencies=[];if((this.initData!=undefined)&&this.initData!=null&&this.initData.frequencies!=undefined&&this.initData.frequencies!=null){this.frequencyList=this.initData.frequencies;$.each(this.frequencyList,function(c,d){debugLog("value: "+d.frequencyName);if($.inArray(d.frequencyName,a.frequencies)==-1){a.frequencies.push(d.frequencyName);debugLog("added ...");}});}debugLog(this.frequencies);this.frequencyField.getInputComponent().setDatas(this.frequencies);this.frequencyField.setValue(this.frequencies[0]);if(this.frequencies.length==1){this.frequencyField.disable();}else{debugLog("enable currency field ...");this.frequencyField.enable();}debugLog("run ready, "+this.container.html());},onSelectCurrency:function(){debugLog("onSelectCurrency ...");},onSelectFrequency:function(){debugLog("onSelectFrequency ... ");},submitHandler:function(){debugLog("submitHandler ...");if(!this.businessValidator()){debugLog("The form is not valid!");return;}this.callForecast();},businessValidator:function(){if(this.currencyField.val()==undefined||this.currencyField.val()==""){return false;}if(this.recurrenceCheckbox.val()==true){var b=this.frequencyField.val();var a=null;debugLog("selectedVal: "+b);if(b){$.each(this.frequencyList,function(c,d){debugLog("value: "+d.frequencyName);if(d.frequencyName==b){debugLog("found code: "+d.frequencyCode);a=d.frequencyCode;}});if(a==null){debugLog("The frequency is null!");return false;}}else{debugLog("There is no selected value for frequency!");return false;}}return true;},renderSubmitButton:function(){var a={labelResourceKey:this.submitButtonLabelResourceKey,"class":this.submitButtonClass};this.submitButton=new Bankingapp.ui.SubmitButton(resolve(a.labelResourceKey),{"class":a["class"]});this.submitButton.disable();this.form.append(this.submitButton);},frequencyExpiryDateClickHandler:function(b,a){showDatePicker(Bankingapp.framework.Application.proxy(this.afterFrequencyDatePickerHandler,this,true));},afterFrequencyDatePickerHandler:function(a){var c=$().dateParserWithoutTime(a);var b=$().dateParserWithoutTime(new Date());b=$().setTimeOfDate(b,0,0,0,0);if(c>=b){this.frequencyExpiryDateValue=c.dateFormat(resolve("bankingapp_brd_function_bringyourmoney_mpi_frequencyexpirydate_format"));$("#frequencyExpiryDate").find(".row0").text(this.frequencyExpiryDateValue);debugLog("frequencyExpiryDate: "+c.dateFormat(resolve("bankingapp_brd_function_bringyourmoney_mpi_frequencyexpirydate_format")));}else{debugLog("the date is not valid!");}},recurrenceCheckBoxClickHandler:function(){debugLog("recurrenceCheckBoxClickHandler ... "+this.recurrenceCheckbox.val());if(this.recurrenceCheckBoxClickHandlerValue==this.recurrenceCheckbox.val()){debugLog("workaround, preventing the multiple events ...");return;}this.recurrenceCheckBoxClickHandlerValue=this.recurrenceCheckbox.val();if(this.recurrenceCheckbox.val()==true){this.groupContainerMPIFrequency.show();this.saveCardCheckbox.setValue(true);this.saveCardCheckbox.updateClass();this.saveCardCheckbox.disable();this.submitButton.enable();showCustomPopUp(resolve("bankingapp_brd_function_bringyourmoney_mpi_recurrence_infotitle"),resolve("bankingapp_brd_function_bringyourmoney_mpi_recurrence_info1")+resolve("bankingapp_brd_function_bringyourmoney_mpi_recurrence_info2")+resolve("bankingapp_brd_function_bringyourmoney_mpi_recurrence_info3")+resolve("bankingapp_brd_function_bringyourmoney_mpi_recurrence_info4"),resolve("bankingapp_brd_function_bringyourmoney_mpi_recurrence_infobutton"));}else{this.groupContainerMPIFrequency.hide();this.saveCardCheckbox.enable();}},saveCardCheckboxClickHandler:function(){debugLog("saveCardCheckboxClickHandler ... "+this.saveCardCheckbox.val());if(this.saveCardCheckbox.val()==true){this.submitButton.enable();}else{this.submitButton.disable();}},getRecurFreq:function(){var b=this.frequencyField.val();var a=30;debugLog("selectedVal: "+b);if(b){$.each(this.frequencyList,function(c,d){debugLog("value: "+d.frequencyName);if(d.frequencyName==b){debugLog("found code: "+d.frequencyCode);a=d.frequencyCode;}});}else{debugLog("There is not selected value for frequency!");}return a;},randomString:function(c){var d="";var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var b=0;b<c;b++){d+=a.charAt(Math.floor(Math.random()*a.length));}return d;},callForecast:function(){var b=new Date();var a=new Date();var d=new Date(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate(),a.getUTCHours(),a.getUTCMinutes(),a.getUTCSeconds(),a.getUTCMilliseconds());debugLog("valueDate: "+d.toString());var c={AMOUNT:$().amountFormatter(this.amountField.val())+"",CURRENCY:this.currencyField.val()+"",TransactionID:null,TERMINAL:this.initData.terminal?this.initData.terminal:"0",TRTYPE:this.initData.trType?this.initData.trType:"0",CardID:this.formData.savedCardId?this.formData.savedCardId:"",TargetAccount:this.formData.targetAccount.accountNumber,Client_id:this.initData.clientId+"",Save_card:(this.saveCardCheckbox.val()==true?1:0)+"",Recur_freq:null,Recur_exp:null,BFNAME:this.initData.firstName,BLNAME:this.initData.lastName,TIMESTAMP:d.dateFormat("YmdHis"),NONCE:this.randomString(32)};if(this.recurrenceCheckbox.val()==true){c.Recur_freq=this.getRecurFreq();c.Recur_exp=Date.parseDate(this.frequencyExpiryDateValue,resolve("bankingapp_brd_function_bringyourmoney_mpi_frequencyexpirydate_format")).dateFormat("Ymd");}if(this.mpiData==undefined||this.mpiData==null){this.mpiData={};}$.extend(this.mpiData,c);$.extend(this.formData,{valueDate:d,selectedDate:b});debugLog("selectedDate: "+b);setFunctionAttribute(this.mpiDataFunctionAttributeId,this.mpiData);setFunctionAttribute(this.formDataFunctionAttributeId,this.formData);if(b){if(jQuery.type(b)==="date"){b=$().formatDateForRequest(b);}}this.forecastRequest={sourceAccount:"",targetAccount:this.formData.targetAccount.accountNumber,targetAccountCurrency:this.formData.targetAccount.currency,targetAccountHolderName:this.formData.targetAccount.ownerName,amount:this.amountField.val(),currency:this.currencyField.val(),cardId:this.formData.savedCardId?this.formData.savedCardId:"",cardHolderName:this.initData.customerName,cardType:this.formData.savedCardType,expire:this.mpiData.card_expiration_date,maskedCardNumber:this.mpiData.card_number?Functions.transferfunds.TransferUtils.maskCardNumber(Functions.transferfunds.TransferUtils.formatCardNumber(this.mpiData.card_number)):"",recurrence:this.recurrenceCheckbox.val(),recurrenceFrequency:this.getRecurFreq(),recurrenceExpiry:this.frequencyExpiryDateValue?Date.parseDate(this.frequencyExpiryDateValue,resolve("bankingapp_brd_function_bringyourmoney_mpi_frequencyexpirydate_format")):null,recurrenceExpiryString:this.frequencyExpiryDateValue?Date.parseDate(this.frequencyExpiryDateValue,resolve("bankingapp_brd_function_bringyourmoney_mpi_frequencyexpirydate_format")).dateFormat("Y-m-d"):null,saveCard:this.saveCardCheckbox.val(),timestamp:d.dateFormat("YmdHis"),description:this.initData.description,valueDate:b};setFunctionAttribute(Functions.transferfunds.TransferUtils.BRINGYOURMONEY_FORECAST_REQUEST,this.forecastRequest);callService({serviceName:"/bringyourmoney/forecast",request:{BringYourMoneyTransferRequest:this.forecastRequest},callback:Bankingapp.framework.Application.proxy(this.handleForecastRequest,this,true)});},handleForecastRequest:function(a){setFunctionAttribute(Functions.transferfunds.TransferUtils.BRINGYOURMONEY_FORECAST_REPLY,a);this.mpiData.TransactionID=this.extendTransactionId(a.transactionId+"");setFunctionAttribute(this.mpiDataFunctionAttributeId,this.mpiData);loadView("view://brd/bankingapp/function/receivemoney/bringyourmoney/sign");},handleSignResult:function(a){setFunctionAttribute(Functions.transferfunds.TransferUtils.BRINGYOURMONEY_SIGN_REPLY,a);loadView("view://brd/bankingapp/function/receivemoney/bringyourmoney/result");},extendTransactionId:function(b){var a="0000000000";if(b!=undefined&&b!=null){a=a.substring(b.length+"")+b;}return a;}});Bankingapp.framework.Application.setView(Bankingapp.functions.receivemoney.bringyourmoney.TransactionDetails);