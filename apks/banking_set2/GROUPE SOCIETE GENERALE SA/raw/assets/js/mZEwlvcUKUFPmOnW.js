Class.ns("Bankingapp.functions.receivemoney.splitthebill");$().loadJavaScript("/js/EY30pmSnIMcajXPT.js");$().loadJavaScript("/js/snosUZyjouIYavJ2.js");$().loadJavaScript("/js/5oOijdXSIAJvz3mU.js");$().loadJavaScript("/js/1hyf9OWY93mTBudZ.js");Bankingapp.functions.receivemoney.splitthebill.SplitSumm=Class.extend(Bankingapp.framework.View,{container:null,chartContainer:null,textContainer:null,groupContainer:null,descriptionField:null,valueDateButton:null,containerButton:null,containerSplitList:null,colors:null,contentWidth:0,showProgressIndicator:true,progressIndicatorStepCount:3,progressIndicatorCurrentStep:1,splitTransactionItem:null,remainingAmount:null,splitPartners:null,splitTheBillInit:null,dateFormatPattern:resolve("bankingapp_common_dateFormatPattern_per"),layoutRender:function(){Bankingapp.framework.event.ButtonHandler.setButtonHandler("BACK",$.proxy(this.backBtnHandler,this));Bankingapp.framework.event.BrdServiceMessageHandler.handleMessages();this.container=$("<div>",{id:"splitSummMainContainer","class":"maincontainer"});if(this.showProgressIndicator){this.container.append(new Bankingapp.ui.ProgressIndicator(this.progressIndicatorStepCount,this.progressIndicatorCurrentStep));}this.chartContainer=$("<div>",{id:"chartContainer",style:"background:#efefef","class":"maincontainer",align:"center"});this.container.append(this.chartContainer);this.textContainer=$("<div>",{id:"addText"});this.container.append(this.textContainer);this.containerSplitList=$("<div>",{id:"splitListContainer","class":"list maincontainer"});this.container.append(this.containerSplitList);this.groupContainer=$("<div>",{"class":"groupcontainer"});this.containerButton=$("<div>",{id:"splitPartnerButtonContainer","class":"buttonholdercontainer"});this.addPartnerButton=new Bankingapp.ui.ComplexButton(resolve("bankingapp_brd_function_splitbill_splitsumm_addpartner_button"),{id:"addPartnerButton","class":"addPartnerButton"});this.addPartnerButton.bind("buttonClick",$.proxy(this.addPartnerHandler,this));this.splitBillButton=new Bankingapp.ui.SubmitButton(resolve("bankingapp_brd_function_splitbill_splitsumm_splitthebill_button"),{id:"splitBillButton","class":"splitBillButton"});this.containerButton.append(this.addPartnerButton);this.containerButton.append(this.splitBillButton);this.descriptionField=new Bankingapp.ui.InputField(resolve("bankingapp_brd_function_requestmoney_partnerselect_description_field"),{id:"descriptionField",name:"descriptionField",type:"text",value:(getFunctionAttribute("SPLITBILL_FORMDATA_DESCRIPTION")&&getFunctionAttribute("SPLITBILL_FORMDATA_DESCRIPTION").trim()!=resolve("bankingapp_component_inputfield_optionaltext"))?getFunctionAttribute("SPLITBILL_FORMDATA_DESCRIPTION"):"",validation:{required:false,maxlength:150}});this.groupContainer.append(this.descriptionField);var a=getFunctionAttribute("SPLITBILL_FORMDATA_DATE")?new Date(getFunctionAttribute("SPLITBILL_FORMDATA_DATE")):new Date();setFunctionAttribute("SPLITBILL_FORMDATA_VALUEDATE",$().formatDateForRequest(a));this.valueDateButton=new Bankingapp.ui.ComplexButton([a.dateFormat(resolve("bankingapp_common_dateFormatPattern_per"))],{id:"valueDateButton","class":"calendar"});this.valueDateButton.bind("buttonClick",$.proxy(this.valueDateButtonClickHandler,this));this.groupContainer.append(new Bankingapp.ui.LabeledComponent({labelText:resolve("bankingapp_function_transferfunds_valuedate"),valueComponent:this.valueDateButton}));this.form=new Bankingapp.ui.Form({id:"partnerSelectForm",submitHandler:$.proxy(this.submitHandler,this),businessValidationHandler:$.proxy(this.businessValidator,this),"class":"partner-select-form"});this.form.append(this.groupContainer);this.form.append(this.containerButton);this.container.append(this.form);return this.container;},businessValidator:function(){var a=new Date();a=a.setHours(0,0,0,0);var b=getFunctionAttribute("SPLITBILL_FORMDATA_VALUEDATE");if(Date.parse(b)<a){debugLog("date validation: ");debugLog("valuedate: "+b+" today: "+a);showError(resolve("bankingapp_function_domestictransfer_date_past_error"));return false;}if(this.splitPartners==undefined||this.splitPartners==null||this.splitPartners.length==0){showError(resolve("bankingapp_brd_function_splitbill_splitsumm_partner_error"));return false;}return true;},submitHandler:function(){setFunctionAttribute("SPLITBILL_FORMDATA_DESCRIPTION",this.descriptionField.val());for(var a=0;a<this.splitPartners.length;++a){delete this.splitPartners[a].splitPartnerCurrency;delete this.splitPartners[a].color;}this.forecastRequest={targetAccount:this.splitTransactionItem.customerAccount,totalAmount:this.splitTransactionItem.amount,currency:this.splitTransactionItem.currency,beneficiaryName:this.splitTransactionItem.beneficiaryName,description:getFunctionAttribute("SPLITBILL_FORMDATA_DESCRIPTION"),valueDate:getFunctionAttribute("SPLITBILL_FORMDATA_VALUEDATE"),splitPartners:this.splitPartners};Bankingapp.framework.Application.callService("/splitbilltransfer/forecast",{SplitBillTransferRequest:this.forecastRequest},$.proxy(this.handleForecastRequest,this));},handleForecastRequest:function(a){setFunctionAttribute(Functions.transferfunds.TransferUtils.SPLITBILL_FORECAST_REPLY,a);loadView("view://brd/bankingapp/function/receivemoney/splitthebill/forecast",null);},run:function(){this.splitTheBillInit=getFunctionAttribute("splitTheBillInit");this.colors=this.splitTheBillInit.partnerColors.split(",");this.remainingAmount=getFunctionAttribute("remainingAmount");this.splitTransactionItem=getFunctionAttribute(Functions.transferfunds.TransferUtils.SPLITBILL_FORMDATA).transactionItem;Bankingapp.framework.event.ButtonHandler.setButtonHandler("BACK",$.proxy(this.backBtnHandler,this));this.loadPartnerList();},backBtnHandler:function(a){debugLog("ZLIDAK: remove attribute");removeFunctionAttribute("remainingAmount");removeFunctionAttribute("splitPartners");setFunctionAttribute("SplitBillNavigateFrom","splitsummpage");goToPreviousView("view://brd/bankingapp/function/receivemoney/splitthebill/history");},splitBillHandler:function(){loadView("view://brd/bankingapp/function/receivemoney/splitthebill/forecast",null);},loadPartnerList:function(){this.splitPartners=getFunctionAttribute("splitPartners");this.partnerList=new Bankingapp.ui.List({baseClass:"list",listData:[],itemRenderer:Bankingapp.ui.SplitListItem,activeProperty:true,itemConfig:{baseClass:"accountListItem",partnerName:"partnerName",splitPartnerAmount:"amount",splitPartnerCurrency:"splitPartnerCurrency"}});var c=[];if(this.splitPartners!=undefined&&this.splitPartners!=null&&this.splitPartners.length>0){var a=0;for(var b=0;b<this.splitPartners.length;++b){a+=this.splitPartners[b].amount;c.push(this.splitPartners[b].amount);if(b<this.colors.length){this.splitPartners[b].color=this.colors[b];}}if(this.remainingAmount!=0){c.push(parseFloat((this.splitTransactionItem.amount-a).toFixed(2)));}this.partnerList.appendItems(this.splitPartners);this.partnerList.bind("itemClick",$.proxy(this.clickHandler,this));this.containerSplitList.append(this.partnerList);}this.renderHighchart(c);},clickHandler:function(b,a){setFunctionAttribute("partnerFunction","remove");setFunctionAttribute("selectedPartner",a);loadView("view://brd/bankingapp/function/receivemoney/splitthebill/partnerselect",null);},addPartnerHandler:function(a,b){setFunctionAttribute("SPLITBILL_FORMDATA_DESCRIPTION",this.descriptionField.val());removeFunctionAttribute("selectedPartner");if(this.remainingAmount==0){showError(resolve("bankingapp_brd_function_splitbill_splitsumm_amountmaximum_error"));return false;}if(this.splitPartners!=undefined&&this.splitPartners!=null&&this.splitPartners.length>0&&this.splitTheBillInit.maxNumOfPartners==this.splitPartners.length){showError(resolve("bankingapp_brd_function_splitbill_splitsumm_partnermaximum_error"));return false;}setFunctionAttribute("partnerFunction","add");loadView("view://brd/bankingapp/function/receivemoney/splitthebill/partnerselect",null);},renderHighchart:function(e){var b=this.splitTransactionItem.amount;if(e.length==0){e.push(b);}Highcharts.theme={colors:this.colors};Highcharts.setOptions(Highcharts.theme);var a="";var c=Bankingapp.framework.currency.CurrencyDataProvider.getCurrencyData(this.splitTransactionItem.currency);if(c!=undefined&&c!=null&&c.symbol!=undefined&&c.symbol!=null){a=c.symbol;}var d=this.splitTransactionItem.beneficiaryName!=null?this.splitTransactionItem.beneficiaryName:"";$(function(){function f(g){var k="";var j="";var h=false;for(i=0;i<g.length;i++){if(g[i]==" "&&i>20&&h==false){h=true;continue;}if(h){j+=g[i];}else{k+=g[i];}}if(j.length>20){return'<span style="font-size: 12px;">'+k+"</span><br>"+f(j);}else{return'<span style="font-size: 12px;">'+k+'</span><br><span style="font-size: 12px;">'+j+"</span>";}}$("#chartContainer").highcharts({chart:{plotBackgroundColor:null,plotBorderWidth:0,plotShadow:false,selectionMarkerFill:"white"},title:{text:'<span style="font-size: 32px;">'+b.toFixed(2)+" "+a+"</span><br><br>"+f(d),align:"center",margin:"20%",verticalAlign:"middle",y:0},plotOptions:{pie:{allowPointSelect:false,states:{hover:{enabled:false}},dataLabels:{enabled:false,distance:0,style:{fontWeight:"bold",color:"white",textShadow:"0px 1px 2px black"}},startAngle:-180,endAngle:180,center:["50%","50%"]}},credits:{enabled:false},tooltip:{enabled:false},series:[{type:"pie",name:"Split the bill",innerSize:"80%",data:e}]});});},roundDecimal:function(b,a){return Math.round(b*Math.pow(10,a))/Math.pow(10,a);},valueDateButtonClickHandler:function(b,a){showDatePicker(Bankingapp.framework.Application.proxy(this.datePickerHandler,this,true));},datePickerHandler:function(a){setFunctionAttribute("SPLITBILL_FORMDATA_DATE",a);setFunctionAttribute("SPLITBILL_FORMDATA_VALUEDATE",$().formatDateForRequest(a));this.displayValueDate(a);},displayValueDate:function(a){$("#valueDateButton").find(".row0").text(a.dateFormat(resolve("bankingapp_common_dateFormatPattern")));}});Bankingapp.framework.Application.setView(Bankingapp.functions.receivemoney.splitthebill.SplitSumm);