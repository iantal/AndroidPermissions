$().loadJavaScript("/js/1hyf9OWY93mTBudZ.js");Class.ns("Bankingapp.functions.receivemoney.bringyourmoney");Bankingapp.functions.receivemoney.bringyourmoney.Sign=Class.extend(Bankingapp.framework.View,{dateFormatPattern:resolve("bankingapp_common_dateFormatPattern_per"),progressIndicatorStepCount:Functions.transferfunds.TransferUtils.BRINGYOURMONEY_STEPCOUNT_1,formDataFunctionAttributeId:Functions.transferfunds.TransferUtils.BRINGYOURMONEY_FORMDATA,initDataFunctionAttributeId:Functions.transferfunds.TransferUtils.BRINGYOURMONEY_INITDATA,mpiDataFunctionAttributeId:Functions.transferfunds.TransferUtils.BRINGYOURMONEY_MPIDATA,progressIndicatorCurrentStep:2,showPageInstructions:true,showProgressIndicator:true,containerId:"detailsCt",containerClass:"internaltransfer maincontainer bringyourmoney-sign",groupContainer:null,groupContainerClass:"groupcontainer",pageInstructionsClass:"pagetitle separator left",pageInstructionsResourceKey:"bankingapp_brd_function_bringyourmoney_sign_information_label",submitButtonLabelResourceKey:"bankingapp_brd_function_bringyourmoney_sign_submitbutton",submitButtonClass:"submit",emptyStringResourceKey:"bankingapp_brd_function_bringyourmoney_select",formData:null,romcardIframeId:"romcard-frame",blankURL:"data:text/html;charset=utf-8,"+encodeURI("<html><head></head><body></body></html>"),$this:null,layoutRender:function(){this.creationDate=(new Date()).dateFormat("YmdHis");debugLog("layoutRender ... creationDate: "+this.creationDate);$this=this;Bankingapp.framework.Application.bind("onButtonPressed",$.proxy(this.onButtonPressed,this));this.initData=getFunctionAttribute(this.initDataFunctionAttributeId);this.mpiData=getFunctionAttribute(this.mpiDataFunctionAttributeId);this.formData=getFunctionAttribute(this.formDataFunctionAttributeId);if((this.formData==undefined)||(this.formData==null)){debugLog("formdata is not defined ...");this.formData={};}else{if(this.formData.progressIndicatorCurrentStep!=undefined&&this.formData.progressIndicatorCurrentStep!=null){this.progressIndicatorCurrentStep=this.formData.progressIndicatorCurrentStep+3;debugLog("new progressIndicatorCurrentStep: "+this.progressIndicatorCurrentStep);this.progressIndicatorStepCount=Functions.transferfunds.TransferUtils.BRINGYOURMONEY_STEPCOUNT_2;}}this.container=$("<div>",{id:this.containerId,"class":this.containerClass});this.progressIndicatorItem=new Bankingapp.ui.ProgressIndicator(this.progressIndicatorStepCount,this.progressIndicatorCurrentStep);if(this.showProgressIndicator){this.container.append(this.progressIndicatorItem);}this.romcardFrame=$("<iframe>",{src:this.blankURL,id:this.romcardIframeId,name:this.romcardIframeId,frameborder:0,"class":"bym-romcard-frame",style:"width: 100%; height: 95%;",scrolling:"yes"});this.romcardFrame.appendTo(this.container);this.romcardFrame.bind("load",$.proxy(this.romcardFrameLoad,this));debugLog("layoutRender ready!");return this.container;},run:function(){debugLog("run ... ");var a=getSessionAttribute("ROMCARD_MPI_URL");debugLog("romcardUrl: "+a);if(a!=undefined&&a!=null){this.postToIframeDirect(this.mpiData,a,this.romcardIframeId);}else{debugLog("The romcardUrl is not defined!");}debugLog("run ready ",this.container.html());},handleSignResult:function(a){setFunctionAttribute(Functions.transferfunds.TransferUtils.BRINGYOURMONEY_SIGN_REPLY,a);loadView("view://brd/bankingapp/function/receivemoney/bringyourmoney/result");},romcardFrameLoad:function(d){debugLog("romcardFrameLoad ...");showLoadingPopup();var b=document.getElementById(this.romcardIframeId);debugLog("iframe loaded ...");var i=b.contentWindow.location.href;debugLog("navigationUrl: "+i);if(i!=undefined&&i!=null&&i!=this.blankURL){if(this.validateUrl(i)===false){debugLog("The url is not available in whitelist (romcardFrameLoad): "+i);var a={};a.mpiResponseString="The url is not available in whitelist: "+i;this.handleFailure(a);b.src=this.blankURL;b.remove();return;}}var e=b.contentDocument.body.innerHTML;debugLog("content: "+e);var a={};a.mpiResponseString=("Url: "+i+", content: "+e).replace(new RegExp("(<([^>]+)>)","ig"),"");var h=b.contentDocument.title;if(h.indexOf("400")>=0||h.indexOf("401")>=0||h.indexOf("403")>=0||h.indexOf("404")>=0||h.indexOf("500")>=0||h.indexOf("502")>=0||h.indexOf("503")>=0||h.indexOf("504")>=0){a.mpiResponseString=("Title: "+h).replace(new RegExp("(<([^>]+)>)","ig"),"");this.handleFailure(a);}var g=getSessionAttribute("ROMCARD_MPI_URL");var f=g.split("/");if(e.indexOf("resultMessage")>=0||e.indexOf("errorCode")>=0){debugLog("navigationUrl.indexOf(reply) >= 0"+i.indexOf("reply")>=0);debugLog("navigationContent.indexOf(resultMessage) >= 0"+e.indexOf("resultMessage")>=0);debugLog("navigationContent.indexOf(errorCode) >= 0"+e.indexOf("errorCode")>=0);b.src=this.blankURL;b.remove();debugLog("loading stopped! "+i);a={};try{a=$.parseJSON(e.substring(e.indexOf("{")));debugLog("The response is JSON");}catch(c){debugLog("The response is not a JSON, trying to parse the previous pattern");}a.mpiResponseString=("Url: "+i+", content: "+e).replace(new RegExp("(<([^>]+)>)","ig"),"");if(a!=undefined&&a!=null){debugLog("mpiResponse is not null!");this.formData.mpiErrorCode=a.errorCode;if(a.CARD_MASKED!=undefined&&a.CARD_MASKED!=null){this.formData.maskedCardNumber=a.CARD_MASKED;}setFunctionAttribute(this.formDataFunctionAttributeId,this.formData);if(a.ResultCode!=undefined&&a.ResultCode!=null){if(a.ResultCode=="1"){debugLog("Success response ...");if(a.cardNumber==undefined||a.cardNumber==null||a.cardNumber==""){a.cardNumber=this.formData.savedMaskedCardNumber?this.formData.savedMaskedCardNumber:"";}Bankingapp.framework.Application.callService("/bringyourmoney/perform",{BringYourMoneyStatusUpdateRequest:{mpiResponseString:a.mpiResponseString,status:a.status,errorCode:a.errorCode,cardNumber:this.formData.maskedCardNumber,token:a.token,nonce:a.nonce,sign:a.sign}},$.proxy(this.handleSignResult,this));}else{debugLog("Error response, mpiResponse.ResultCode == 0: "+(a.ResultCode=="0"));this.handleFailure(a);}}else{debugLog("Error response ...");this.handleFailure(a);}}else{debugLog("Error response, no mpi response ...");this.handleFailure(a);}}else{setTimeout(function(){hideLoadingPopup();},1000);if(i.indexOf(f[2])>=0){debugLog("Romcard MPI page ... os: "+getDeviceInformation().os);if(getDeviceInformation().os.toLowerCase()!="ios"){setWebViewScale(0);}debugLog("Share css with Romcard MPI ...");this.applyStyle();}else{debugLog("3D secure page ...");if(getDeviceInformation().os.toLowerCase()!="ios"){if(e.indexOf("t_middle")>=0){debugLog("applying t_middle hack ...");setWebViewScale(500);this.applyZoomStyle();}else{if(e.indexOf('<div style="border: 1px solid #666666; width:')>=0&&i.indexOf("ing.ro")>=0){debugLog("applying ING hack ...");setWebViewScale(600);}else{debugLog("no need to apply zoom hack ...");}}}}}if(i.indexOf(f[2])>=0){this.progressIndicatorCurrentStep=this.progressIndicatorStepCount-2;}else{this.progressIndicatorCurrentStep=this.progressIndicatorStepCount-1;}console.log("progressIndicatorCurrentStep udpated, "+this.progressIndicatorCurrentStep);var j=new Bankingapp.ui.ProgressIndicator(this.progressIndicatorStepCount,this.progressIndicatorCurrentStep);this.progressIndicatorItem.replaceWith(j);this.progressIndicatorItem=j;},postToIframeDirect:function(e,c,g){debugLog("postToIframeDirect, "+c);var d=this;this.romcardUrl=c;this.romcardData=e;if(e.NONCE!=undefined&&e.NONCE!=null){debugLog("data.NONCE :"+e.NONCE);if(Bankingapp.functions.receivemoney.bringyourmoney.Sign.NONCE==undefined||Bankingapp.functions.receivemoney.bringyourmoney.Sign.NONCE==null){Bankingapp.functions.receivemoney.bringyourmoney.Sign.NONCE=e.NONCE;debugLog("The data will be posted to the IFRAME (1): "+Bankingapp.functions.receivemoney.bringyourmoney.Sign.NONCE);}else{if(Bankingapp.functions.receivemoney.bringyourmoney.Sign.NONCE==e.NONCE){debugLog("The data is already posted to the iframe, "+Bankingapp.functions.receivemoney.bringyourmoney.Sign.NONCE);return;}else{debugLog("The data will be posted to the IFRAME (2): "+Bankingapp.functions.receivemoney.bringyourmoney.Sign.NONCE);}}}var h="romcardPostToIframe";if(this.validateUrl(c)===false){debugLog("The url is not available in whitelist: "+c);var b={};b.mpiResponseString="The url is not available in whitelist: "+c;this.handleFailure(b);romcardIframe.src=this.blankURL;romcardIframe.remove();return;}this.postForm=$("<form>",{action:c,method:"post",target:this.romcardIframeId,id:h});this.container.append(this.postForm);d.cumulatedValues="";$.each(this.romcardData,function(j,i){debugLog("append: "+j+": "+i);if(i==undefined||i==null||i==""){d.cumulatedValues+="-";}else{d.cumulatedValues+=i.length+i;}d.postForm.append($("<input>",{type:"hidden",name:j,value:i}));});d.cumulatedValues=this.cumulateRequest(this.romcardData);debugLog("cumulatedValues: "+this.cumulatedValues);var a=getSessionAttribute("ROMCARD_MPI_SECURE_KEY");debugLog("secureKey: "+a);var f="";if(a!=undefined&&a!=null){calculateRFC2104HMAC(this.cumulatedValues,a,Bankingapp.framework.Application.proxy(this.handleHmacResult1,this,true));debugLog("hashValue: "+f);}else{debugLog("The secure key is not available!");}debugLog("postToIframeDirect ready!");},handleHmacResult1:function(a){debugLog("handleHmacResult1 ...");this.postForm.append($("<input>",{type:"hidden",name:"P_SIGN",value:a}));this.postForm.append($("<input>",{type:"hidden",name:"Lang",value:getLocale()}));this.postForm.submit().remove();},postToIframe:function(e,c,g){debugLog("postToIframe, "+c);var d=this;if(this.validateUrl(c)===false){debugLog("The url is not available in whitelist: "+c);var b={};b.mpiResponseString="The url is not available in whitelist: "+c;this.handleFailure(b);romcardIframe.src=this.blankURL;romcardIframe.remove();return;}this.romcardUrl=c;this.romcardData=e;d.cumulatedValues="";$.each(this.romcardData,function(i,h){debugLog("append: "+i+": "+h);if(h==undefined||h==null||h==""){d.cumulatedValues+="-";}else{d.cumulatedValues+=h.length+h;}});debugLog("cumulatedValues: "+this.cumulatedValues);var a=getSessionAttribute("ROMCARD_MPI_SECURE_KEY");debugLog("secureKey: "+a);var f="";if(a!=undefined&&a!=null){calculateRFC2104HMAC(this.cumulatedValues,a,Bankingapp.framework.Application.proxy(this.handleHmacResult,this,true));debugLog("calculateRFC2104HMAC ready!");}else{debugLog("The secure key is not available!");}debugLog("postToIframe ready!");},handleHmacResult:function(b){debugLog("handleHmacResult");debugLog("handleHmacResult, hashValue: "+b);var a=this;this.romcardData.P_SIGN=b;this.romcardData.Lang=getLocale();setTimeout(function(){$.post(a.romcardUrl,a.romcardData,function(c){debugLog("result: "+c);a.romcardFrame=$("<iframe>",{src:"data:text/html;charset=utf-8,"+encodeURI(c),id:a.romcardIframeId,name:a.romcardIframeId,frameborder:0,"class":"bym-romcard-frame",style:"width: 100%; height: 95%;",scrolling:"yes"});a.romcardFrame.appendTo(a.container);a.romcardFrame.bind("load",$.proxy(a.romcardFrameLoad,a));a.applyStyle();debugLog("html"+a.container.html());}).error(function(){console.log("Error in posting data!");var c={};c.mpiResponseString=("post failure, url: "+a.romcardUrl);a.handleFailure(c);});},500);debugLog("postToIframe submitted!");},validateUrl:function(c){var d=false;var b=getSessionAttribute("ROMCARD_MPI_WHITELIST");if(b==undefined||b==null||b.trim()==""){debugLog("There is no whitelist parameter!");return true;}if(c.indexOf("data:text/html;charset=utf-8")>=0){debugLog("packed html content, it is not url");d=true;}else{if(b!=undefined&&b!=null){var a=b.split(";");$.each(a,function(e,f){debugLog("validate: "+f);if(c.indexOf(f)>=0){debugLog("found match in whitelist: "+f);d=true;}});}else{debugLog("There are no white list urls defined.");d=true;}}debugLog("valid: "+d);return d;},handleFailure:function(a){if(a.CARD_MASKED==undefined||a.CARD_MASKED==null||a.CARD_MASKED==""){a.CARD_MASKED=this.formData.savedMaskedCardNumber?this.formData.savedMaskedCardNumber:"";}callService({serviceName:"/bringyourmoney/handleFailure",request:{BringYourMoneyStatusUpdateRequest:{mpiResponseString:a.mpiResponseString,status:a.status,errorCode:a.errorCode,cardNumber:this.formData.maskedCardNumber,token:a.token,nonce:a.nonce,sign:a.sign}},callback:Bankingapp.framework.Application.proxy(this.handleSignResult,this,true)});},parseReplyPage:function(c){var a=c.replace(new RegExp("\\=\\&gt\\;","ig"),":").replace(new RegExp("([a-z]*\\(\\d*\\))","ig"),"").replace(new RegExp("\\[","ig"),";").replace(new RegExp("\\]","ig"),"").replace(new RegExp("=>","ig"),":");var b=a.split(";");var d={};b.forEach(function(f){debugLog(f);var e=f.replace(new RegExp('\\"',"g"),"").split(":");if(e!=undefined&&e!=null&&e[0]!=undefined&&e[1]!=undefined){d[e[0].trim()]=e[1].trim();}});return d;},applyStyle:function(){$("#"+this.romcardIframeId).contents().find("head").append(this.loadCss(getCurrentSkin(),"common","style.agg"+$().getCssSuffix()+".css"));$("#"+this.romcardIframeId).contents().find("head").append(this.loadCss(getCurrentSkin(),getDeviceInformation().os,"style.agg"+$().getCssSuffix()+".css"));},loadCss:function(e,d,b,g){var f=getContextRoot()+"/app-skins/"+e+"/"+d.toLowerCase()+"/"+$().getResolution()+"/css/"+b;debugLog("css: "+f);var a=this.readTextFile(f);var c=$("<style>",{text:a});return c;},applyZoomStyle:function(){var a=$("<style>",{text:"t_middle {width: 500px;}"});$("#"+this.romcardIframeId).contents().find("head").append(a);},applyZoomStyle1stDiv:function(b){var a=$("<style>",{text:"body div:first-child { width: 420px; }}"});$("#"+this.romcardIframeId).contents().find("head").append(a);},readTextFile:function(a){debugLog("file: "+a);var c="";var b=new XMLHttpRequest();b.open("GET",a,false);b.onreadystatechange=function(){if(b.readyState===4){if(b.status===200||b.status==0){c=b.responseText;}}};b.send(null);debugLog("resource content: "+c);return c;},cumulateRequest:function(b){var a="";a+=this.getCumulatedValue(b.AMOUNT);a+=this.getCumulatedValue(b.CURRENCY);a+=this.getCumulatedValue(b.TransactionID);a+=this.getCumulatedValue(b.TERMINAL);a+=this.getCumulatedValue(b.TRTYPE);a+=this.getCumulatedValue(b.CardID);a+=this.getCumulatedValue(b.TargetAccount);a+=this.getCumulatedValue(b.Client_id);a+=this.getCumulatedValue(b.Save_card);a+=this.getCumulatedValue(b.Recur_freq);a+=this.getCumulatedValue(b.Recur_exp);a+=this.getCumulatedValue(b.BFNAME);a+=this.getCumulatedValue(b.BLNAME);a+=this.getCumulatedValue(b.TIMESTAMP);a+=this.getCumulatedValue(b.NONCE);return a;},getCumulatedValue:function(a){if(a==undefined||a==null||a==""){return"-";}else{return a.length+a;}},onButtonPressed:function(a){debugLog("hardware button pressed: "+a);callService({serviceName:"/bringyourmoney/cancelTransaction",request:{},callback:Bankingapp.framework.Application.proxy(this.onCancelTransaction,this,true)});}});Bankingapp.framework.Application.setView(Bankingapp.functions.receivemoney.bringyourmoney.Sign);