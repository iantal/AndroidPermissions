$().loadJavaScript("/js/cNGJpPRjrlEySoCA.js");$().loadJavaScript("/js/1hyf9OWY93mTBudZ.js");Class.ns("Functions.transferfunds.domestictransfer");Functions.transferfunds.domestictransfer.TransferDetails=Class.extend(Bankingapp.framework.View,{container:null,containerId:"domesticTransferDetailsMainContainer",containerClass:"domestictransfer maincontainer",showProgressIndicator:true,progressIndicatorStepCount:5,progressIndicatorCurrentStep:3,showPageInstructions:true,pageInstructionsClass:"pagetitle separator",pageInstructionsResourceKey:"bankingapp_function_transferfunds_detailsinstructions",form:null,formId:"transferDetailsForm",formClass:"transfer-details-form",groupContainer:null,groupContainerClass:"groupcontainer",valueDateButton:null,formData:null,forecastRequest:null,currency:null,amountField:null,descriptionField:null,cuiCnpField:null,referenceField:null,feeType:null,layoutRender:function(){this.formData=getFunctionAttribute(Functions.transferfunds.TransferUtils.DOMESTICTRANSFER_FORMDATA);this.container=$("<div>",{id:this.containerId,"class":this.containerClass});this.container.append(new Bankingapp.ui.ProgressIndicator(this.progressIndicatorStepCount,this.progressIndicatorCurrentStep));this.container.append(new Bankingapp.ui.Label(resolve(this.pageInstructionsResourceKey),{"class":this.pageInstructionsClass}));this.form=new Bankingapp.ui.Form({id:this.formId,submitHandler:$.proxy(this.submitHandler,this),businessValidationHandler:$.proxy(this.businessValidator,this),"class":this.formClass});this.groupContainer=$("<div>",{"class":this.groupContainerClass});this.form.append(this.groupContainer);this.container.append(this.form);var b=this.getCurrencyData();this.currency=new Bankingapp.ui.InputField({labelText:resolve("bankingapp_function_domestictransfer_currency"),inputRenderer:Bankingapp.ui.SelectButton,inputConfig:{id:"currencySelect",value:null,emptyString:resolve("bankingapp_function_domestictransfer_select"),popupName:"Currency",datas:b},baseInputContainerClass:"selectComboContainer combo inputfirst"});this.currency.getInputComponent().bind("afterSelect",$.proxy(this.afterSelectCurrency,this));this.currency.setValue(b[0]);if(b.length==1){this.currency.disable();}this.groupContainer.append(this.currency);this.amountField=new Bankingapp.ui.InputField(resolve("bankingapp_function_domestictransfer_amount"),{id:"amount",name:"amount",type:Functions.transferfunds.TransferUtils.getAmountInputFieldType(),value:(this.formData.amount?this.formData.amount:""),inputMaskPattern:/[0-9.,\+\-]/,validation:{whitelist:false,required:true,min:0,max:999999999999,number:true,maxlength:12}});this.groupContainer.append(this.amountField);var a=this.formData.targetAccount.indexOf("TREZ")!=-1;if(a){this.descriptionField=new Bankingapp.ui.InputField(resolve("bankingapp_function_domestictransfer_description"),{id:"description",name:"description",type:"text",value:(this.formData.description?this.formData.description:""),validation:{whitelist:false,maxlength:140}});}else{this.descriptionField=new Bankingapp.ui.InputField(resolve("bankingapp_function_domestictransfer_description"),{id:"description",name:"description",type:"text",value:(this.formData.description?this.formData.description:""),validation:{whitelist:false,maxlength:200}});}this.groupContainer.append(this.descriptionField);if(Functions.transferfunds.TransferUtils.isTrezTargetAccount(this.formData.targetAccount)){this.cuiCnpField=new Bankingapp.ui.InputField(resolve("bankingapp_function_domestictransfer_cuicnp"),{id:"cUI_CNP",name:"cUI_CNP",type:"text",validation:{required:true},inputMaskPattern:/[ A-Za-z0-9]/,validation:{whitelist:false,maxlength:16},value:a?"":getFunctionAttribute(Functions.transferfunds.TransferUtils.DOMESTICTRANSFER_INITDATA).cUI_CNP});this.groupContainer.append(this.cuiCnpField);}var c=new Date();this.valueDateButton=new Bankingapp.ui.ComplexButton([c.dateFormat(resolve("bankingapp_common_dateFormatPattern_per"))],{id:"valueDateButton","class":"calendar"});this.valueDateButton.bind("buttonClick",$.proxy(this.valueDateButtonClickHandler,this));this.groupContainer.append(new Bankingapp.ui.LabeledComponent({labelText:resolve("bankingapp_function_transferfunds_valuedate"),valueComponent:this.valueDateButton}));if(Functions.transferfunds.TransferUtils.isCorporateUser()){$.Validation.setResource("whitelist","bankingapp_error_referencenumber_notvalid");$.Validation.setResource("required","bankingapp_error_referencenumber_empty");this.referenceField=new Bankingapp.ui.InputField(resolve("bankingapp_function_domestictransfer_reference"),{id:"reference",name:"reference",type:"text",value:(this.formData.referenceNumber?this.formData.referenceNumber:""),validation:{whitelist:true,required:true,maxlength:Functions.transferfunds.TransferUtils.REFERENCE_FIELD_MAXLENGTH}});this.groupContainer.append(this.referenceField);}this.feeType=new Bankingapp.ui.InputField({labelText:resolve("bankingapp_function_domestictransfer_feetype"),inputRenderer:Bankingapp.ui.SelectButton,inputConfig:{id:"feeTypeSelect",value:null,emptyString:resolve("bankingapp_function_domestictransfer_select"),popupName:"Commission Fee",datas:[resolve("bankingapp_function_domestictransfer_feetype_SHA"),resolve("bankingapp_function_domestictransfer_feetype_OUR"),resolve("bankingapp_function_domestictransfer_feetype_BEN")]},baseInputContainerClass:"selectComboContainer combo inputfirst"});this.groupContainer.append(this.feeType);if(!Functions.transferfunds.TransferUtils.isFeeTypeShown(this.currency.val(),this.formData.targetAccount)){this.feeType.hide();}this.form.append(new Bankingapp.ui.SubmitButton(resolve("bankingapp_function_transferfunds_continue"),{"class":"sumbit"}));return this.container;},afterSelectCurrency:function(b,a){if(Functions.transferfunds.TransferUtils.isFeeTypeShown(a.selected,this.formData.targetAccount)){this.feeType.show();}else{this.feeType.hide();}},updateFeeData:function(a){var b=this;this.feeType.getInputComponent().clearValue();if(Functions.transferfunds.TransferUtils.isFeeTypeShown(this.currencySelectValue?this.currencySelectValue:this.currency.val(),this.formData.targetAccount)){this.feeType.show();if((a!=undefined)&&a!=null){this.fees=[];this.feeList=a;$.each(this.feeList,function(c,d){debugLog("value: "+d.feeTypeKey);if($.inArray(d.feeTypeKey,b.fees)==-1){b.fees.push(resolve(d.feeTypeKey));debugLog("added, "+resolve(d.feeTypeKey));}});}debugLog(this.fees);this.feeType.getInputComponent().setDatas(this.fees);}else{this.feeType.hide();}},getCurrencyData:function(){var a=[];if($.inArray(this.formData.sourceAccount.currency,a)==-1){a.push(this.formData.sourceAccount.currency);}if($.inArray(this.formData.targetAccountCurrency,a)==-1){a.push(this.formData.targetAccountCurrency);}return a;},run:function(){if(this.formData.valueDate&&this.valueDateButton){this.displayValueDate(this.formData.valueDate);}else{this.formData.valueDate=new Date();console.log("run valueDate: "+this.formData.valueDate);}},valueDateButtonClickHandler:function(b,a){showDatePicker(Bankingapp.framework.Application.proxy(this.datePickerHandler,this,true));},datePickerHandler:function(a){console.log("datepickhandler valueDate: "+a);this.formData.valueDate=a;this.displayValueDate(a);},displayValueDate:function(a){$("#valueDateButton").find(".row0").text(a.dateFormat(resolve("bankingapp_common_dateFormatPattern")));},submitHandler:function(){debugLog("submitHandler ...");var b=this;this.forecastRequest=this.formData.forecastRequest;this.forecastRequest.description=this.descriptionField.val();this.forecastRequest.amount=this.amountField.val();if(Functions.transferfunds.TransferUtils.isCorporateUser()){this.forecastRequest.referenceNumber=this.referenceField.val();}this.forecastRequest.currency=this.currency.val();this.forecastRequest.feeType=null;if(Functions.transferfunds.TransferUtils.isFeeTypeShown(this.currency.val(),this.formData.targetAccount)){debugLog("submitHandler, isFeeTypeShown ...");if(this.feeType.val()==resolve("bankingapp_function_domestictransfer_feetype_SHA")){this.forecastRequest.feeType="SHA";}else{if(this.feeType.val()==resolve("bankingapp_function_domestictransfer_feetype_OUR")){this.forecastRequest.feeType="OUR";}else{if(this.feeType.val()==resolve("bankingapp_function_domestictransfer_feetype_BEN")){this.forecastRequest.feeType="BEN";}}}debugLog("feeType: "+this.forecastRequest.feeType);}if(this.formData.valueDate){if(jQuery.type(this.formData.valueDate)==="date"){this.forecastRequest.valueDate=$().formatDateForRequest(this.formData.valueDate);}else{this.forecastRequest.valueDate=this.formData.valueDate;}}if(Functions.transferfunds.TransferUtils.isTrezTargetAccount(this.formData.targetAccount)){this.forecastRequest.cUI_CNP=this.cuiCnpField.val();}else{this.forecastRequest.cUI_CNP=null;}$.extend(this.formData,{description:this.forecastRequest.description,amount:this.forecastRequest.amount,valueDate:this.forecastRequest.valueDate,currency:this.forecastRequest.currency,referenceNumber:this.forecastRequest.referenceNumber,feeType:this.forecastRequest.feeType,cUI_CNP:this.forecastRequest.cUI_CNP});setFunctionAttribute(Functions.transferfunds.TransferUtils.DOMESTICTRANSFER_FORMDATA,this.formData);setFunctionAttribute(Functions.transferfunds.TransferUtils.DOMESTICTRANSFER_FORECAST_REQUEST,this.forecastRequest);if(this.forecastRequest.requestMoneyTransactionId||this.forecastRequest.splitBillTransactionId){console.log("  >>>>>>   splitbill or request money draft ...");var a={DomesticTransferRequest:getFunctionAttribute(Functions.transferfunds.TransferUtils.DOMESTICTRANSFER_FORECAST_REQUEST),TransactionId:this.formData.domesticTransactionId};callService({serviceName:"/domestictransfer/draftForecast",request:{DraftDomesticTransferRequest:a},callback:Bankingapp.framework.Application.proxy(this.handleForecastRequest,this,true)});}else{console.log("  >>>>>>   normal ...");callService({serviceName:"/domestictransfer/forecast",request:{DomesticTransferRequest:getFunctionAttribute(Functions.transferfunds.TransferUtils.DOMESTICTRANSFER_FORECAST_REQUEST)},callback:Bankingapp.framework.Application.proxy(this.handleForecastRequest,this,true)});}},handleForecastRequest:function(a){setFunctionAttribute(Functions.transferfunds.TransferUtils.DOMESTICTRANSFER_FORECAST_REPLY,a);loadView("view://brd/bankingapp/function/transferfunds/domestictransfer/sign",null);},businessValidator:function(){var d=getFunctionAttribute(Functions.transferfunds.TransferUtils.PAYMENT_VALUEDATE_MAXDAYS);if(d>0){var b=new Date();var f=new Date();f.setDate(b.getDate()+d);if(f<this.formData.valueDate){showError(resolve("bankingapp_function_domestictransfer_dateerror")+d+resolve("bankingapp_function_domestictransfer_dateerror2"));return false;}}var e=this.formData.valueDate;var c=new Date();c=c.setHours(0,0,0,0);if(e<c){console.log("date validation: ");console.log("valuedate: "+e+" yesterday: "+c);showError(resolve("bankingapp_function_domestictransfer_date_past_error"));return false;}var a=this.currency.val();if(a==null||a==""){showError(resolve("bankingapp_function_domestictransfer_currencyerror"));return false;}if(this.currency.val()&&Functions.transferfunds.TransferUtils.isFeeTypeShown(this.currency.val(),this.formData.targetAccount)&&!this.feeType.val()){showError(resolve("bankingapp_function_domestictransfer_feetypeerror"));return false;}return true;}});Bankingapp.framework.Application.setView(Functions.transferfunds.domestictransfer.TransferDetails);