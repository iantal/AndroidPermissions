Class.ns("Bankingapp.functions.transactionhistory");$().loadJavaScript("/js/EY30pmSnIMcajXPT.js");$().loadJavaScript("/js/snosUZyjouIYavJ2.js");$().loadJavaScript("/js/wydusgYbCqEevX15.js");$().loadJavaScript("/js/1hyf9OWY93mTBudZ.js");Bankingapp.functions.transactionhistory.SplitTransactionStatus=Class.extend(Bankingapp.framework.View,{container:null,chartContainer:null,textContainer:null,containerButton:null,contentWidth:0,containerSplitList:null,colors:null,splitTransactionItem:null,remainingAmount:null,splitPartners:null,splitTheBillInit:null,transactionDetail:null,trRequestData:null,layoutRender:function(){this.transactionDetail=getFunctionAttribute("splitBillTransactionDetail");this.payerTrData=getFunctionAttribute("splitbill_payerTrData");this.container=$("<div>",{id:"splitTansactionHistoryMainContainer","class":"maincontainer"});this.chartContainer=$("<div>",{id:"chartContainer","class":"maincontainer",style:"background:#efefef",align:"center"});this.container.append(this.chartContainer);this.textContainer=$("<div>",{id:"addText"});this.container.append(this.textContainer);this.containerSplitList=$("<div>",{id:"splitListContainer","class":"list maincontainer"});this.container.append(this.containerSplitList);this.containerButton=$("<div>",{id:"splitPartnerButtonContainer","class":"buttonholdercontainer"});var a=this.transactionDetail.status;if(a=="VALUEDATED"||a=="OFFLINE"||a=="WAITINGFORCOLLECTION"){this.splitBillCancelButton=new Bankingapp.ui.SubmitButton(resolve("bankingapp_brd_function_splitbill_history_cancel_button"),{id:"splitBillCancelButton","class":"splitBillButton"});this.containerButton.append(this.splitBillCancelButton);this.cancelButtonAdded=true;}this.form=new Bankingapp.ui.Form({id:"partnerSelectForm",submitHandler:$.proxy(this.submitHandler,this),businessValidationHandler:$.proxy(this.businessValidator,this),"class":"partner-select-form"});this.form.append(this.containerButton);this.container.append(this.form);return this.container;},businessValidator:function(){return true;},submitHandler:function(){Bankingapp.framework.Application.showConfirmation(resolve("bankingapp_brd_function_transactionhistory_cancelconfirmation"),new Boolean(0),$.proxy(this.handleConfirmation,this));},handleConfirmation:function(a,b){if(a.valueOf()){Bankingapp.framework.Application.callService("/transactionhistory/cancelTransaction",null,$.proxy(this.handleCancelResponse,this));}else{goToPreviousView();}},handleCancelResponse:function(e){var c=[];for(var a=0;a<this.transactionDetail.splitPartners.length;a++){c.push(this.transactionDetail.splitPartners[a].transactionId);}var b={PayerTransactionIds:c};Bankingapp.framework.Application.callService("/splitbilltransfer/getPayerTransactionStatuses",{PayerTransactionStatusesRequest:b},$.proxy(this.handlePayerTrDataResponse,this));},updateStatuses:function(c){for(var f=0;f<c.length;f++){var b=c[f].transactionId;var d="transactionHistoryListItem-"+c[f].status;var e="transactionHistoryListItem-"+this.payerTrData[f].status;var a=$("#"+b);a.removeClass(e);a.addClass(d);$("#"+b+" .splitPartnerStatusName").text(c[f].statusName);}},handlePayerTrDataResponse:function(a){var b=a.payerTransactionData;this.updateStatuses(b);this.splitBillCancelButton.remove();setFunctionAttribute("needListRefresh",true);},run:function(){Bankingapp.framework.Application.callService("/splitbilltransfer/init",null,$.proxy(this.handleSplitBillInitResponse,this));debugLog("trDetails: "+JSON.stringify(this.transactionDetail));this.splitTransactionItem={amount:this.transactionDetail.totalAmount,currency:this.transactionDetail.currency,beneficiaryName:this.transactionDetail.beneficiaryName};},handleSplitBillInitResponse:function(a){this.colors=a.partnerColors.split(",");this.loadPartnerList();},loadPartnerList:function(){this.splitPartners=[];var g=0;var b=0;var c=0;var f=0;for(var j=0;j<this.payerTrData.length;j++){var k=this.searchPartnerByTrId(this.payerTrData[j].transactionId);var e={partnerName:k.partnerName,amount:k.amount,phoneNumber:k.phoneNumber,splitPartnerCurrency:this.transactionDetail.currency,transactionId:this.payerTrData[j].transactionId,status:this.payerTrData[j].status,statusName:this.payerTrData[j].statusName};debugLog("partner: "+JSON.stringify(e));this.splitPartners.push(e);var d=this.payerTrData[j].status;debugLog("   >> status: "+d);if(d=="DRAFT"){g+=1;}else{if(d=="PENDING"){b+=1;}else{if(d=="PROCESSED"){c=c+1;}else{f=f+1;}}}}if(this.cancelButtonAdded!=true){if(g>=1&&b==0&&c==0){debugLog("   >> draft and no pendig/processed, cancel button needed ...");this.splitBillCancelButton=new Bankingapp.ui.SubmitButton(resolve("bankingapp_brd_function_splitbill_history_cancel_button"),{id:"splitBillCancelButton","class":"splitBillButton"});this.containerButton.append(this.splitBillCancelButton);this.cancelButtonAdded=true;}else{debugLog("   >> cancel button not needed ...");}}this.partnerList=new Bankingapp.ui.List({baseClass:"list",listData:[],itemRenderer:Bankingapp.ui.SplitTransactionStatusListItem,activeProperty:true,itemConfig:{baseClass:"accountListItem",partnerName:"partnerName",splitPartnerAmount:"amount",splitPartnerCurrency:"splitPartnerCurrency",transactionId:"transactionId",status:"status",statusName:"statusName"}});var h=[];if(this.splitPartners!=undefined&&this.splitPartners!=null&&this.splitPartners.length>0){var a=0;for(var j=0;j<this.splitPartners.length;++j){a+=this.splitPartners[j].amount;h.push(this.splitPartners[j].amount);if(j<this.colors.length){this.splitPartners[j].color=this.colors[j];}}h.push(parseFloat((this.splitTransactionItem.amount-a).toFixed(2)));this.partnerList.appendItems(this.splitPartners);this.containerSplitList.append(this.partnerList);}this.renderHighchart(h);},searchPartnerByTrId:function(a){var c={};for(var b=0;b<this.transactionDetail.splitPartners.length;b++){var d=this.transactionDetail.splitPartners[b];if(d.transactionId===a){c=d;return c;}}},renderHighchart:function(e){var b=this.splitTransactionItem.amount;if(e.length==0){e.push(b);}Highcharts.theme={colors:this.colors};Highcharts.setOptions(Highcharts.theme);var a="";var c=Bankingapp.framework.currency.CurrencyDataProvider.getCurrencyData(this.splitTransactionItem.currency);if(c!=undefined&&c!=null&&c.symbol!=undefined&&c.symbol!=null){a=c.symbol;}var d=this.splitTransactionItem.beneficiaryName!=null?this.splitTransactionItem.beneficiaryName:"";$(function(){function f(g){var k="";var j="";var h=false;for(i=0;i<g.length;i++){if(g[i]==" "&&i>20&&h==false){h=true;continue;}if(h){j+=g[i];}else{k+=g[i];}}if(j.length>20){return'<span style="font-size: 12px;">'+k+"</span><br>"+f(j);}else{return'<span style="font-size: 12px;">'+k+'</span><br><span style="font-size: 12px;">'+j+"</span>";}}$("#chartContainer").highcharts({chart:{plotBackgroundColor:null,plotBorderWidth:0,plotShadow:false,selectionMarkerFill:"white"},title:{text:'<span style="font-size: 32px;">'+b.toFixed(2)+" "+a+"</span><br><br>"+f(d),align:"center",margin:"20%",verticalAlign:"middle",y:0},plotOptions:{pie:{allowPointSelect:false,states:{hover:{enabled:false}},dataLabels:{enabled:false,distance:0,style:{fontWeight:"bold",color:"white",textShadow:"0px 1px 2px black"}},startAngle:-180,endAngle:180,center:["50%","50%"]},},credits:{enabled:false},tooltip:{enabled:false},series:[{type:"pie",name:"Split the bill",innerSize:"80%",data:e}]});});}});Bankingapp.framework.Application.setView(Bankingapp.functions.transactionhistory.SplitTransactionStatus);