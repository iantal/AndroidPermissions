$().loadJavaScript("/js/yjuDMlY6mIjPXsqj.js");$().loadJavaScript("/js/2mn7Hk00ag7k0rZ2.js");Class.ns("Bankingapp.functions.bankfeed");Bankingapp.functions.bankfeed.BankFeedList=Class.extend(Bankingapp.functions.bankfeed.BankFeedBase,{container:null,bankFeedList:null,bankFeedListContainer:null,FIELDNAME_STATUS:"status",FIELDNAME_DELETED:"deleted",STATUS_READ:"R",STATUS_UNREAD:"U",feedCategoryTypeArray:[],layoutRender:function(){this.container=$("<div>",{id:"bankFeedListMainContainer","class":"list maincontainer"});Bankingapp.framework.Application.bind("onResume",$.proxy(this.onResume,this));Bankingapp.framework.Application.bind("onContextMenuItemPressed",$.proxy(this.onContextMenuItemPressed,this));return this.container;},onResume:function(){showLoadingPopup();this.getFeedCategoryType();},getFeedCategoryType:function(){if(getFunctionAttribute("DICTIONARY_BANKFEED_CATEGORY_TYPE")==null||getFunctionAttribute("DICTIONARY_BANKFEED_CATEGORY_LANGUAGE")!=getLocale()){Bankingapp.framework.Application.callService("/component/dictionary",{DictionaryRequest:{TypeName:"pegasus.component.messaging:CategoryType",Locale:getLocale()}},$.proxy(this.getFeedCategoryTypeResult,this));setFunctionAttribute("DICTIONARY_BANKFEED_CATEGORY_LANGUAGE",getLocale());}else{this.getTransactionStatusDictionary();}},getFeedCategoryTypeResult:function(a){var c={};for(var b in a.dictionaryEntry){c[a.dictionaryEntry[b].typeCode]=a.dictionaryEntry[b].resolvedText;}setFunctionAttribute("DICTIONARY_BANKFEED_CATEGORY_TYPE",c);this.getTransactionStatusDictionary();},getTransactionStatusDictionary:function(){if(getFunctionAttribute("DICTIONARY_TRANSACTION_STATUS")==null||setFunctionAttribute("DICTIONARY_TRANSACTION_LANGUAGE")!=getLocale()){Bankingapp.framework.Application.callService("/component/dictionary",{DictionaryRequest:{TypeName:"pegasus.component.transactionframework:Status",Locale:getLocale()}},$.proxy(this.getTransactionStatusDictionaryResult,this));setFunctionAttribute("DICTIONARY_TRANSACTION_LANGUAGE",getLocale());}else{this.getEnabledFeedCategories();}},getTransactionStatusDictionaryResult:function(a){var c={};for(var b in a.dictionaryEntry){c[a.dictionaryEntry[b].typeCode]=a.dictionaryEntry[b].resolvedText;}setFunctionAttribute("DICTIONARY_TRANSACTION_STATUS",c);this.getEnabledFeedCategories();},getEnabledFeedCategories:function(){Bankingapp.framework.Application.callService("/brdmessaging/customer/getCategoryTypePreferences",null,$.proxy(this.getBankFeeds,this));},getBankFeeds:function(d){this.feedCategoryTypeArray=[];for(var b in d.categoryType){if(d.categoryType[b].checked===true||d.categoryType[b].checked==="true"){this.feedCategoryTypeArray.push(d.categoryType[b].categoryTypeId);}}var a={GetCustomerMessagesRequest:{OnlyFeeds:"true",CategoryTypeId:this.feedCategoryTypeArray}};var c=isLoggedIn().valueOf();if(!c){a.GetCustomerMessagesRequest.OnlyPublic="true";}Bankingapp.framework.Application.callService("/feed/getInboxFeedMessages",a,$.proxy(this.handleResult,this));},handleResult:function(a){setFunctionAttribute("BANK_FEED_LIST",a);var b=this.filterBankFeedList(a);if(this.bankFeedList!=null){this.bankFeedList.empty();this.bankFeedList.appendItems(b);}else{this.bankFeedListContainer=$("<div>").attr("id","bankFeedListContainer");this.container.append(this.bankFeedListContainer);this.bankFeedList=new Bankingapp.ui.HistoricList(b,{itemRenderer:Bankingapp.functions.bankfeed.BankFeedListItem,id:"messageId",baseClass:"bankFeedList",dateField:"createTs",dataDateFormat:resolve("bankingapp_common_parsedatepattern_withouttimezone"),displayDateFormat:resolve("bankingapp_common_dateFormatPattern"),dataOrder:"desc"});this.bankFeedListContainer.append(this.bankFeedList);this.bankFeedList.bind("itemClick",$.proxy(this.itemClickHandler,this));}hideLoadingPopup();},filterBankFeedList:function(e){var b=[];if((e!=undefined)&&(e!=null)){var a=getApplicationOption("SHOW_READ_MESSAGES");var c=((a!=undefined)&&(a!=null))?a.valueOf():true;for(var d=0;d<e.length;d++){var f=e[d];if($.inArray(f.categoryTypeId,this.feedCategoryTypeArray)!=-1){if(((f[this.FIELDNAME_DELETED]==undefined)||(f[this.FIELDNAME_DELETED]==null)||!f[this.FIELDNAME_DELETED])&&((f[this.FIELDNAME_STATUS].$==this.STATUS_UNREAD)||((f[this.FIELDNAME_STATUS].$==this.STATUS_READ)&&c))){b.push(f);}}}}return b;},itemClickHandler:function(b,a){setFunctionAttribute("SELECTED_BANKFEEDITEM",a);getCacheItem(this.getBankFeedCacheItemId(),Bankingapp.framework.Application.proxy(this.cachedReadMessage,this,true));},cachedReadMessage:function(a){this.bankFeedList.unbind("itemClick");if(a!=null){var c=getFunctionAttribute("SELECTED_BANKFEEDITEM")["messageId"];var d=a.data;if(d!=null){for(var b=0;b<d.length;b++){if(d[b]["messageId"]==c){d[b][this.FIELDNAME_STATUS]={"@name":"READ","$":this.STATUS_READ};break;}}a.data=d;setCacheItem(this.getBankFeedCacheItemId(),a);setFunctionAttribute("BANK_FEED_LIST",d);}}Bankingapp.framework.Application.callService("/feed/readMessage",{CustomerMessageId:{MessageId:c,Store:"INBOX"}},$.proxy(this.handleReadMessageResult,this));},handleReadMessageResult:function(f){var g=f.messageContent;var e=f.imageId;var a=f.externalLinkText;var i=f.externalLinkUrl;var h=f.internalLinkText;var b=f.internalLinkUrl;var d=getFunctionAttribute("SELECTED_BANKFEEDITEM");var c=false;if((g!=undefined)&&(g!=null)&&(g!="")){d.messageContent=g;if((e!=undefined)&&(e!=null)&&(e!="")){d.messageImageId=e;}if((a!=undefined)&&(a!=null)&&(a!="")){d.messageExternalLinkText=a;d.messageExternalLinkUrl=i;}if((h!=undefined)&&(h!=null)&&(h!="")){d.messageInternalLinkText=h;d.messageInternalLinkUrl=b;}setFunctionAttribute("SELECTED_BANKFEEDITEM",d);c=true;}if(d.categoryTypeId==3){Bankingapp.framework.Application.callService("/transactionhistory/getTransaction",{TransactionSearchRequest:{transactionId:d.payload.transactionId,transactionVersion:d.payload.transactionVersion}},$.proxy(this.handleTransactionDetail,this));}else{if(d.categoryTypeId==4||d.categoryTypeId==5){Bankingapp.framework.Application.callService("/statement/getStatement",{StatementRequest:{transactionId:d.payload.transactionId}},$.proxy(this.handleTransactionBookingDetail,this));}else{if(c){loadView("view://brd/bankingapp/function/bankfeed/bankfeeddetails",{DayText:this.bankFeedList.findPeriod($().dateParserWithoutTimezone(d.createTs)).text});}}}this.bankFeedList.unbind("itemClick");this.bankFeedList.bind("itemClick",$.proxy(this.itemClickHandler,this));},handleTransactionDetail:function(f){if(f.transaction.type==="splitBillTransferLifeCycle"){var b=this.createSplitBillTransactionDetailData(f);setFunctionAttribute("splitBillTransactionDetail",b);var e=[];for(var a=0;a<b.splitPartners.length;a++){e.push(b.splitPartners[a].transactionId);}if(JSON.stringify(e)!="[null]"){var c={PayerTransactionIds:e};}else{var c={PayerTransactionIds:[]};}Bankingapp.framework.Application.callService("/splitbilltransfer/getPayerTransactionStatuses",{PayerTransactionStatusesRequest:c},$.proxy(this.handlePayerTrDataResponse,this));}else{setSessionAttribute("transactionDetail",f);loadView("view://brd/bankingapp/function/transactionhistory/detail/transactionhistorydetail",null);}},createSplitBillTransactionDetailData:function(b){var c={};var a=b.transaction.transactionData.transactionRequest;c.status=b.transaction.status["@name"];c.totalAmount=a.totalAmount;c.currency=a.currency;c.beneficiaryName=a.beneficiaryName;c.splitPartners=a.splitPartners;return c;},handlePayerTrDataResponse:function(a){setFunctionAttribute("splitbill_payerTrData",a.payerTransactionData);loadView("view://brd/bankingapp/function/bankfeed/detail/splittransactionhistorydetail",null);},handleTransactionBookingDetail:function(a){setSessionAttribute("SELECTED_TRANSACTION",a.statement);loadView("view://brd/bankingapp/function/accountinfo/statementdetails",null);},onContextMenuItemPressed:function(c,b){if(b=="mark_all_as_read"){getCacheItem(this.getBankFeedCacheItemId(),Bankingapp.framework.Application.proxy(this.cachedMarkAllAsRead,this,true));}else{if(b=="mark_as_unread"){var e=getFunctionAttribute("BANK_FEED_LIST");if(e!=null){var d=[];for(var a=0;a<e.length;a++){if(e[a][this.FIELDNAME_STATUS]&&e[a][this.FIELDNAME_STATUS].$==this.STATUS_READ){d.push(e[a]);}}if(d.length>0){setFunctionAttribute("READ_FEED_LIST",d);loadView("view://brd/bankingapp/function/bankfeed/markasunread",null);}}}}},cachedMarkAllAsRead:function(a){var d=null;if(a!=null){d=a.data;}else{d=getFunctionAttribute("BANK_FEED_LIST");}var c=[];if(d!=null){for(var b=0;b<d.length;b++){if(d[b][this.FIELDNAME_STATUS]&&d[b][this.FIELDNAME_STATUS].$=="U"){c.push(d[b]["messageId"]);d[b][this.FIELDNAME_STATUS]={"@name":"READ","$":this.STATUS_READ};}}if(a!=null){a.data=d;setCacheItem(this.getBankFeedCacheItemId(),a);}setFunctionAttribute("BANK_FEED_LIST",d);}this.bankFeedList.empty();this.bankFeedList.appendItems(this.filterBankFeedList(d));if((c.length>0)&&isLoggedIn().valueOf()){Bankingapp.framework.Application.callService("/feed/markAsReadMessages",{MarkAsReadRequest:{MessageId:c}},$.proxy(this.handleMarkAsReadResult,this));}},handleMarkAsReadResult:function(a){this.getEnabledFeedCategories();}});Bankingapp.framework.Application.setView(Bankingapp.functions.bankfeed.BankFeedList);