package com.google.android.bitmapfun;

import android.content.Context;
import android.content.res.Resources;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.graphics.drawable.BitmapDrawable;
import android.graphics.drawable.ColorDrawable;
import android.graphics.drawable.Drawable;
import android.graphics.drawable.TransitionDrawable;
import android.support.v4.app.FragmentActivity;
import android.support.v4.app.FragmentManager;
import android.widget.ImageView;
import java.lang.ref.WeakReference;

public abstract class ImageWorker
{
  private static final int FADE_IN_TIME = 200;
  private static final int MESSAGE_CLEAR = 0;
  private static final int MESSAGE_CLOSE = 3;
  private static final int MESSAGE_FLUSH = 2;
  private static final int MESSAGE_INIT_DISK_CACHE = 1;
  private static final String TAG = "ImageWorker";
  private boolean mExitTasksEarly = false;
  private boolean mFadeInBitmap = true;
  private ImageCache mImageCache;
  private ImageCache.ImageCacheParams mImageCacheParams;
  private Bitmap mLoadingBitmap;
  protected boolean mPauseWork = false;
  private final Object mPauseWorkLock = new Object();
  protected Resources mResources;
  
  protected ImageWorker(Context paramContext)
  {
    this.mResources = paramContext.getResources();
  }
  
  public static boolean cancelPotentialWork(Object paramObject, ImageView paramImageView)
  {
    paramImageView = getBitmapWorkerTask(paramImageView);
    if (paramImageView != null)
    {
      Object localObject = paramImageView.data;
      if ((localObject == null) || (!localObject.equals(paramObject))) {
        paramImageView.cancel(true);
      }
    }
    else
    {
      return true;
    }
    return false;
  }
  
  public static void cancelWork(ImageView paramImageView)
  {
    paramImageView = getBitmapWorkerTask(paramImageView);
    if (paramImageView != null) {
      paramImageView.cancel(true);
    }
  }
  
  private static BitmapWorkerTask getBitmapWorkerTask(ImageView paramImageView)
  {
    if (paramImageView != null)
    {
      paramImageView = paramImageView.getDrawable();
      if ((paramImageView instanceof AsyncDrawable)) {
        return ((AsyncDrawable)paramImageView).getBitmapWorkerTask();
      }
    }
    return null;
  }
  
  public void addImageCache(FragmentActivity paramFragmentActivity, String paramString)
  {
    this.mImageCacheParams = new ImageCache.ImageCacheParams(paramFragmentActivity, paramString);
    this.mImageCache = ImageCache.getInstance(paramFragmentActivity.getSupportFragmentManager(), this.mImageCacheParams);
    new CacheAsyncTask().execute(new Object[] { Integer.valueOf(1) });
  }
  
  public void addImageCache(FragmentManager paramFragmentManager, ImageCache.ImageCacheParams paramImageCacheParams)
  {
    this.mImageCacheParams = paramImageCacheParams;
    this.mImageCache = ImageCache.getInstance(paramFragmentManager, this.mImageCacheParams);
    new CacheAsyncTask().execute(new Object[] { Integer.valueOf(1) });
  }
  
  public void clearCache()
  {
    new CacheAsyncTask().execute(new Object[] { Integer.valueOf(0) });
  }
  
  protected void clearCacheInternal()
  {
    if (this.mImageCache != null) {
      this.mImageCache.clearCache();
    }
  }
  
  public void closeCache()
  {
    new CacheAsyncTask().execute(new Object[] { Integer.valueOf(3) });
  }
  
  protected void closeCacheInternal()
  {
    if (this.mImageCache != null)
    {
      this.mImageCache.close();
      this.mImageCache = null;
    }
  }
  
  public void flushCache()
  {
    new CacheAsyncTask().execute(new Object[] { Integer.valueOf(2) });
  }
  
  protected void flushCacheInternal()
  {
    if (this.mImageCache != null) {
      this.mImageCache.flush();
    }
  }
  
  protected ImageCache getImageCache()
  {
    return this.mImageCache;
  }
  
  protected void initDiskCacheInternal()
  {
    if (this.mImageCache != null) {
      this.mImageCache.initDiskCache();
    }
  }
  
  public void loadImage(Object paramObject, ImageView paramImageView)
  {
    if (paramObject == null) {}
    do
    {
      return;
      localObject = null;
      if (this.mImageCache != null) {
        localObject = this.mImageCache.getBitmapFromMemCache(String.valueOf(paramObject));
      }
      if (localObject != null)
      {
        paramImageView.setImageDrawable((Drawable)localObject);
        return;
      }
    } while (!cancelPotentialWork(paramObject, paramImageView));
    Object localObject = new BitmapWorkerTask(paramImageView);
    paramImageView.setImageDrawable(new AsyncDrawable(this.mResources, this.mLoadingBitmap, (BitmapWorkerTask)localObject));
    ((BitmapWorkerTask)localObject).executeOnExecutor(AsyncTask.DUAL_THREAD_EXECUTOR, new Object[] { paramObject });
  }
  
  protected abstract Bitmap processBitmap(Object paramObject);
  
  public void setExitTasksEarly(boolean paramBoolean)
  {
    this.mExitTasksEarly = paramBoolean;
    setPauseWork(false);
  }
  
  protected void setImageDrawable(ImageView paramImageView, Drawable paramDrawable)
  {
    if (this.mFadeInBitmap)
    {
      paramDrawable = new TransitionDrawable(new Drawable[] { new ColorDrawable(17170445), paramDrawable });
      paramImageView.setBackgroundDrawable(new BitmapDrawable(this.mResources, this.mLoadingBitmap));
      paramImageView.setImageDrawable(paramDrawable);
      paramDrawable.startTransition(200);
      return;
    }
    paramImageView.setImageDrawable(paramDrawable);
  }
  
  public void setImageFadeIn(boolean paramBoolean)
  {
    this.mFadeInBitmap = paramBoolean;
  }
  
  public void setLoadingImage(int paramInt)
  {
    this.mLoadingBitmap = BitmapFactory.decodeResource(this.mResources, paramInt);
  }
  
  public void setLoadingImage(Bitmap paramBitmap)
  {
    this.mLoadingBitmap = paramBitmap;
  }
  
  public void setPauseWork(boolean paramBoolean)
  {
    synchronized (this.mPauseWorkLock)
    {
      this.mPauseWork = paramBoolean;
      if (!this.mPauseWork) {
        this.mPauseWorkLock.notifyAll();
      }
      return;
    }
  }
  
  private static class AsyncDrawable
    extends BitmapDrawable
  {
    private final WeakReference<ImageWorker.BitmapWorkerTask> bitmapWorkerTaskReference;
    
    public AsyncDrawable(Resources paramResources, Bitmap paramBitmap, ImageWorker.BitmapWorkerTask paramBitmapWorkerTask)
    {
      super(paramBitmap);
      this.bitmapWorkerTaskReference = new WeakReference(paramBitmapWorkerTask);
    }
    
    public ImageWorker.BitmapWorkerTask getBitmapWorkerTask()
    {
      return (ImageWorker.BitmapWorkerTask)this.bitmapWorkerTaskReference.get();
    }
  }
  
  private class BitmapWorkerTask
    extends AsyncTask<Object, Void, BitmapDrawable>
  {
    private Object data;
    private final WeakReference<ImageView> imageViewReference;
    
    public BitmapWorkerTask(ImageView paramImageView)
    {
      this.imageViewReference = new WeakReference(paramImageView);
    }
    
    private ImageView getAttachedImageView()
    {
      ImageView localImageView = (ImageView)this.imageViewReference.get();
      if (this == ImageWorker.getBitmapWorkerTask(localImageView)) {
        return localImageView;
      }
      return null;
    }
    
    protected BitmapDrawable doInBackground(Object... paramVarArgs)
    {
      this.data = paramVarArgs[0];
      String str = String.valueOf(this.data);
      Object localObject2 = null;
      Object localObject3 = null;
      for (;;)
      {
        synchronized (ImageWorker.this.mPauseWorkLock)
        {
          if (ImageWorker.this.mPauseWork)
          {
            boolean bool = isCancelled();
            if (!bool)
            {
              try
              {
                ImageWorker.this.mPauseWorkLock.wait();
              }
              catch (InterruptedException localInterruptedException) {}
              continue;
            }
          }
          ??? = localObject2;
          if (ImageWorker.this.mImageCache != null)
          {
            ??? = localObject2;
            if (!isCancelled())
            {
              ??? = localObject2;
              if (getAttachedImageView() != null)
              {
                ??? = localObject2;
                if (!ImageWorker.this.mExitTasksEarly) {
                  ??? = ImageWorker.this.mImageCache.getBitmapFromDiskCache(str);
                }
              }
            }
          }
          localObject2 = ???;
          if (??? == null)
          {
            localObject2 = ???;
            if (!isCancelled())
            {
              localObject2 = ???;
              if (getAttachedImageView() != null)
              {
                localObject2 = ???;
                if (!ImageWorker.this.mExitTasksEarly) {
                  localObject2 = ImageWorker.this.processBitmap(paramVarArgs[0]);
                }
              }
            }
          }
          ??? = localObject3;
          if (localObject2 != null)
          {
            if (!Utils.hasHoneycomb()) {
              break label247;
            }
            paramVarArgs = new BitmapDrawable(ImageWorker.this.mResources, (Bitmap)localObject2);
            ??? = paramVarArgs;
            if (ImageWorker.this.mImageCache != null)
            {
              ImageWorker.this.mImageCache.addBitmapToCache(str, paramVarArgs);
              ??? = paramVarArgs;
            }
          }
          return ???;
        }
        label247:
        paramVarArgs = new RecyclingBitmapDrawable(ImageWorker.this.mResources, (Bitmap)localObject2);
      }
    }
    
    protected void onCancelled(BitmapDrawable arg1)
    {
      super.onCancelled(???);
      synchronized (ImageWorker.this.mPauseWorkLock)
      {
        ImageWorker.this.mPauseWorkLock.notifyAll();
        return;
      }
    }
    
    protected void onPostExecute(BitmapDrawable paramBitmapDrawable)
    {
      if ((isCancelled()) || (ImageWorker.this.mExitTasksEarly)) {
        paramBitmapDrawable = null;
      }
      ImageView localImageView = getAttachedImageView();
      if ((paramBitmapDrawable != null) && (localImageView != null)) {
        ImageWorker.this.setImageDrawable(localImageView, paramBitmapDrawable);
      }
    }
  }
  
  protected class CacheAsyncTask
    extends AsyncTask<Object, Void, Void>
  {
    protected CacheAsyncTask() {}
    
    protected Void doInBackground(Object... paramVarArgs)
    {
      switch (((Integer)paramVarArgs[0]).intValue())
      {
      }
      for (;;)
      {
        return null;
        ImageWorker.this.clearCacheInternal();
        continue;
        ImageWorker.this.initDiskCacheInternal();
        continue;
        ImageWorker.this.flushCacheInternal();
        continue;
        ImageWorker.this.closeCacheInternal();
      }
    }
  }
}
