package com.google.analytics.tracking.android;

import android.content.Context;
import android.content.res.Resources;
import android.util.DisplayMetrics;
import com.google.android.gms.common.util.VisibleForTesting;
import java.util.Collection;
import java.util.HashMap;
import java.util.Locale;
import java.util.Map;

public class GoogleAnalytics
  implements TrackerHandler
{
  private static GoogleAnalytics sInstance;
  private AdHitIdGenerator mAdHitIdGenerator;
  private volatile Boolean mAppOptOut;
  private volatile String mClientId;
  private Context mContext;
  private boolean mDebug;
  private Tracker mDefaultTracker;
  private String mLastTrackingId;
  private AnalyticsThread mThread;
  private final Map<String, Tracker> mTrackers = new HashMap();
  
  @VisibleForTesting
  GoogleAnalytics() {}
  
  private GoogleAnalytics(Context paramContext)
  {
    this(paramContext, GAThread.getInstance(paramContext));
  }
  
  private GoogleAnalytics(Context paramContext, AnalyticsThread paramAnalyticsThread)
  {
    if (paramContext == null) {
      throw new IllegalArgumentException("context cannot be null");
    }
    this.mContext = paramContext.getApplicationContext();
    this.mThread = paramAnalyticsThread;
    this.mAdHitIdGenerator = new AdHitIdGenerator();
    this.mThread.requestAppOptOut(new AppOptOutCallback()
    {
      public void reportAppOptOut(boolean paramAnonymousBoolean)
      {
        GoogleAnalytics.access$002(GoogleAnalytics.this, Boolean.valueOf(paramAnonymousBoolean));
      }
    });
    this.mThread.requestClientId(new AnalyticsThread.ClientIdCallback()
    {
      public void reportClientId(String paramAnonymousString)
      {
        GoogleAnalytics.access$102(GoogleAnalytics.this, paramAnonymousString);
      }
    });
  }
  
  @VisibleForTesting
  static void clearInstance()
  {
    try
    {
      sInstance = null;
      return;
    }
    finally {}
  }
  
  static GoogleAnalytics getInstance()
  {
    try
    {
      GoogleAnalytics localGoogleAnalytics = sInstance;
      return localGoogleAnalytics;
    }
    finally {}
  }
  
  public static GoogleAnalytics getInstance(Context paramContext)
  {
    try
    {
      if (sInstance == null) {
        sInstance = new GoogleAnalytics(paramContext);
      }
      paramContext = sInstance;
      return paramContext;
    }
    finally {}
  }
  
  @VisibleForTesting
  static GoogleAnalytics getNewInstance(Context paramContext, AnalyticsThread paramAnalyticsThread)
  {
    try
    {
      if (sInstance != null) {
        sInstance.close();
      }
      sInstance = new GoogleAnalytics(paramContext, paramAnalyticsThread);
      paramContext = sInstance;
      return paramContext;
    }
    finally {}
  }
  
  @VisibleForTesting
  void close() {}
  
  public void closeTracker(Tracker paramTracker)
  {
    try
    {
      this.mTrackers.values().remove(paramTracker);
      if (paramTracker == this.mDefaultTracker) {
        this.mDefaultTracker = null;
      }
      return;
    }
    finally {}
  }
  
  @VisibleForTesting
  Boolean getAppOptOut()
  {
    return this.mAppOptOut;
  }
  
  String getClientIdForAds()
  {
    if (this.mClientId == null) {
      return null;
    }
    return this.mClientId.toString();
  }
  
  public Tracker getDefaultTracker()
  {
    try
    {
      GAUsage.getInstance().setUsage(GAUsage.Field.GET_DEFAULT_TRACKER);
      Tracker localTracker = this.mDefaultTracker;
      return localTracker;
    }
    finally {}
  }
  
  public Tracker getTracker(String paramString)
  {
    if (paramString == null) {
      try
      {
        throw new IllegalArgumentException("trackingId cannot be null");
      }
      finally {}
    }
    Tracker localTracker2 = (Tracker)this.mTrackers.get(paramString);
    Tracker localTracker1 = localTracker2;
    if (localTracker2 == null)
    {
      localTracker2 = new Tracker(paramString, this);
      this.mTrackers.put(paramString, localTracker2);
      localTracker1 = localTracker2;
      if (this.mDefaultTracker == null)
      {
        this.mDefaultTracker = localTracker2;
        localTracker1 = localTracker2;
      }
    }
    GAUsage.getInstance().setUsage(GAUsage.Field.GET_TRACKER);
    return localTracker1;
  }
  
  String getTrackingIdForAds()
  {
    return this.mLastTrackingId;
  }
  
  public boolean isDebugEnabled()
  {
    GAUsage.getInstance().setUsage(GAUsage.Field.GET_DEBUG);
    return this.mDebug;
  }
  
  public void requestAppOptOut(AppOptOutCallback paramAppOptOutCallback)
  {
    GAUsage.getInstance().setUsage(GAUsage.Field.REQUEST_APP_OPT_OUT);
    if (this.mAppOptOut != null)
    {
      paramAppOptOutCallback.reportAppOptOut(this.mAppOptOut.booleanValue());
      return;
    }
    this.mThread.requestAppOptOut(paramAppOptOutCallback);
  }
  
  public void sendHit(Map<String, String> paramMap)
  {
    if (paramMap == null) {
      try
      {
        throw new IllegalArgumentException("hit cannot be null");
      }
      finally {}
    }
    paramMap.put("language", Utils.getLanguage(Locale.getDefault()));
    paramMap.put("adSenseAdMobHitId", Integer.toString(this.mAdHitIdGenerator.getAdHitId()));
    paramMap.put("screenResolution", this.mContext.getResources().getDisplayMetrics().widthPixels + "x" + this.mContext.getResources().getDisplayMetrics().heightPixels);
    paramMap.put("usage", GAUsage.getInstance().getAndClearSequence());
    GAUsage.getInstance().getAndClearUsage();
    this.mThread.sendHit(paramMap);
    this.mLastTrackingId = ((String)paramMap.get("trackingId"));
  }
  
  public void setAppOptOut(boolean paramBoolean)
  {
    GAUsage.getInstance().setUsage(GAUsage.Field.SET_APP_OPT_OUT);
    this.mAppOptOut = Boolean.valueOf(paramBoolean);
    this.mThread.setAppOptOut(paramBoolean);
  }
  
  public void setDebug(boolean paramBoolean)
  {
    GAUsage.getInstance().setUsage(GAUsage.Field.SET_DEBUG);
    this.mDebug = paramBoolean;
    Log.setDebug(paramBoolean);
  }
  
  public void setDefaultTracker(Tracker paramTracker)
  {
    try
    {
      GAUsage.getInstance().setUsage(GAUsage.Field.SET_DEFAULT_TRACKER);
      this.mDefaultTracker = paramTracker;
      return;
    }
    finally {}
  }
  
  public static abstract interface AppOptOutCallback
  {
    public abstract void reportAppOptOut(boolean paramBoolean);
  }
}
