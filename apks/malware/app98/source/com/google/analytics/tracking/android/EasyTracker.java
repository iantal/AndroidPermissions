package com.google.analytics.tracking.android;

import android.app.Activity;
import android.content.Context;
import android.text.TextUtils;
import com.google.android.gms.common.util.VisibleForTesting;
import java.util.HashMap;
import java.util.Map;
import java.util.Timer;
import java.util.TimerTask;

public class EasyTracker
{
  static final int NUM_MILLISECONDS_TO_WAIT_FOR_OPEN_ACTIVITY = 1000;
  private static EasyTracker sInstance;
  private int mActivitiesActive = 0;
  private final Map<String, String> mActivityNameMap = new HashMap();
  private GoogleAnalytics mAnalyticsInstance;
  private String mAppName;
  private String mAppVersion;
  private Clock mClock = new Clock()
  {
    public long currentTimeMillis()
    {
      return System.currentTimeMillis();
    }
  };
  private Context mContext;
  private boolean mDebug;
  private int mDispatchPeriod = 1800;
  private Thread.UncaughtExceptionHandler mExceptionHandler;
  private boolean mIsAnonymizeIpEnabled;
  private boolean mIsAutoActivityTracking = false;
  private boolean mIsEnabled = false;
  private boolean mIsInForeground = false;
  private boolean mIsReportUncaughtExceptionsEnabled;
  private long mLastOnStopTime;
  private ParameterLoader mParameterFetcher;
  private Double mSampleRate;
  private ServiceManager mServiceManager;
  private long mSessionTimeout;
  private Timer mTimer;
  private TimerTask mTimerTask;
  private Tracker mTracker = null;
  private String mTrackingId;
  
  private EasyTracker() {}
  
  private void clearExistingTimer()
  {
    try
    {
      if (this.mTimer != null)
      {
        this.mTimer.cancel();
        this.mTimer = null;
      }
      return;
    }
    finally
    {
      localObject = finally;
      throw localObject;
    }
  }
  
  @VisibleForTesting
  static void clearTracker()
  {
    sInstance = null;
  }
  
  private String getActivityName(Activity paramActivity)
  {
    String str1 = paramActivity.getClass().getCanonicalName();
    if (this.mActivityNameMap.containsKey(str1)) {
      return (String)this.mActivityNameMap.get(str1);
    }
    String str2 = this.mParameterFetcher.getString(str1);
    paramActivity = str2;
    if (str2 == null) {
      paramActivity = str1;
    }
    this.mActivityNameMap.put(str1, paramActivity);
    return paramActivity;
  }
  
  public static EasyTracker getInstance()
  {
    if (sInstance == null) {
      sInstance = new EasyTracker();
    }
    return sInstance;
  }
  
  public static Tracker getTracker()
  {
    if (getInstance().mContext == null) {
      throw new IllegalStateException("You must call EasyTracker.getInstance().setContext(context) or startActivity(activity) before calling getTracker()");
    }
    return getInstance().mTracker;
  }
  
  private void loadParameters()
  {
    boolean bool2 = true;
    this.mTrackingId = this.mParameterFetcher.getString("ga_trackingId");
    if (TextUtils.isEmpty(this.mTrackingId))
    {
      this.mTrackingId = this.mParameterFetcher.getString("ga_api_key");
      if (TextUtils.isEmpty(this.mTrackingId))
      {
        Log.e("EasyTracker requested, but missing required ga_trackingId");
        this.mTracker = new NoopTracker();
        return;
      }
    }
    this.mIsEnabled = true;
    this.mAppName = this.mParameterFetcher.getString("ga_appName");
    this.mAppVersion = this.mParameterFetcher.getString("ga_appVersion");
    this.mDebug = this.mParameterFetcher.getBoolean("ga_debug");
    this.mSampleRate = this.mParameterFetcher.getDoubleFromString("ga_sampleFrequency");
    if (this.mSampleRate == null) {
      this.mSampleRate = new Double(this.mParameterFetcher.getInt("ga_sampleRate", 100));
    }
    this.mDispatchPeriod = this.mParameterFetcher.getInt("ga_dispatchPeriod", 1800);
    this.mSessionTimeout = (this.mParameterFetcher.getInt("ga_sessionTimeout", 30) * 1000);
    boolean bool1 = bool2;
    if (!this.mParameterFetcher.getBoolean("ga_autoActivityTracking")) {
      if (!this.mParameterFetcher.getBoolean("ga_auto_activity_tracking")) {
        break label453;
      }
    }
    label453:
    for (bool1 = bool2;; bool1 = false)
    {
      this.mIsAutoActivityTracking = bool1;
      this.mIsAnonymizeIpEnabled = this.mParameterFetcher.getBoolean("ga_anonymizeIp");
      this.mIsReportUncaughtExceptionsEnabled = this.mParameterFetcher.getBoolean("ga_reportUncaughtExceptions");
      this.mTracker = this.mAnalyticsInstance.getTracker(this.mTrackingId);
      if (!TextUtils.isEmpty(this.mAppName))
      {
        Log.i("setting appName to " + this.mAppName);
        this.mTracker.setAppName(this.mAppName);
      }
      if (this.mAppVersion != null) {
        this.mTracker.setAppVersion(this.mAppVersion);
      }
      this.mTracker.setAnonymizeIp(this.mIsAnonymizeIpEnabled);
      this.mTracker.setSampleRate(this.mSampleRate.doubleValue());
      this.mAnalyticsInstance.setDebug(this.mDebug);
      this.mServiceManager.setDispatchPeriod(this.mDispatchPeriod);
      if (!this.mIsReportUncaughtExceptionsEnabled) {
        break;
      }
      Thread.UncaughtExceptionHandler localUncaughtExceptionHandler = this.mExceptionHandler;
      Object localObject = localUncaughtExceptionHandler;
      if (localUncaughtExceptionHandler == null) {
        localObject = new ExceptionReporter(this.mTracker, this.mServiceManager, Thread.getDefaultUncaughtExceptionHandler(), this.mContext);
      }
      Thread.setDefaultUncaughtExceptionHandler((Thread.UncaughtExceptionHandler)localObject);
      return;
    }
  }
  
  public void activityStart(Activity paramActivity)
  {
    setContext(paramActivity);
    if (!this.mIsEnabled) {}
    do
    {
      return;
      clearExistingTimer();
      if ((!this.mIsInForeground) && (this.mActivitiesActive == 0) && (checkForNewSession()))
      {
        this.mTracker.setStartSession(true);
        if (this.mIsAutoActivityTracking) {}
      }
      this.mIsInForeground = true;
      this.mActivitiesActive += 1;
    } while (!this.mIsAutoActivityTracking);
    this.mTracker.sendView(getActivityName(paramActivity));
  }
  
  public void activityStop(Activity paramActivity)
  {
    setContext(paramActivity);
    if (!this.mIsEnabled) {}
    do
    {
      return;
      this.mActivitiesActive -= 1;
      this.mActivitiesActive = Math.max(0, this.mActivitiesActive);
      this.mLastOnStopTime = this.mClock.currentTimeMillis();
    } while (this.mActivitiesActive != 0);
    clearExistingTimer();
    this.mTimerTask = new NotInForegroundTimerTask(null);
    this.mTimer = new Timer("waitForActivityStart");
    this.mTimer.schedule(this.mTimerTask, 1000L);
  }
  
  boolean checkForNewSession()
  {
    return (this.mSessionTimeout == 0L) || ((this.mSessionTimeout > 0L) && (this.mClock.currentTimeMillis() > this.mLastOnStopTime + this.mSessionTimeout));
  }
  
  public void dispatch()
  {
    if (this.mIsEnabled) {
      this.mServiceManager.dispatch();
    }
  }
  
  @VisibleForTesting
  int getActivitiesActive()
  {
    return this.mActivitiesActive;
  }
  
  @VisibleForTesting
  void setClock(Clock paramClock)
  {
    this.mClock = paramClock;
  }
  
  public void setContext(Context paramContext)
  {
    if (paramContext == null)
    {
      Log.e("Context cannot be null");
      return;
    }
    GAServiceManager localGAServiceManager = GAServiceManager.getInstance();
    setContext(paramContext, new ParameterLoaderImpl(paramContext.getApplicationContext()), GoogleAnalytics.getInstance(paramContext.getApplicationContext()), localGAServiceManager);
  }
  
  @VisibleForTesting
  void setContext(Context paramContext, ParameterLoader paramParameterLoader, GoogleAnalytics paramGoogleAnalytics, ServiceManager paramServiceManager)
  {
    if (paramContext == null) {
      Log.e("Context cannot be null");
    }
    if (this.mContext == null)
    {
      this.mContext = paramContext.getApplicationContext();
      this.mAnalyticsInstance = paramGoogleAnalytics;
      this.mServiceManager = paramServiceManager;
      this.mParameterFetcher = paramParameterLoader;
      loadParameters();
    }
  }
  
  @VisibleForTesting
  void setUncaughtExceptionHandler(Thread.UncaughtExceptionHandler paramUncaughtExceptionHandler)
  {
    this.mExceptionHandler = paramUncaughtExceptionHandler;
  }
  
  class NoopTracker
    extends Tracker
  {
    private String mAppId;
    private String mAppInstallerId;
    private ExceptionParser mExceptionParser;
    private boolean mIsAnonymizeIp;
    private boolean mIsUseSecure;
    private double mSampleRate = 100.0D;
    
    NoopTracker() {}
    
    public void close() {}
    
    public Map<String, String> constructEvent(String paramString1, String paramString2, String paramString3, Long paramLong)
    {
      return new HashMap();
    }
    
    public Map<String, String> constructException(String paramString, boolean paramBoolean)
    {
      return new HashMap();
    }
    
    public Map<String, String> constructRawException(String paramString, Throwable paramThrowable, boolean paramBoolean)
    {
      return new HashMap();
    }
    
    public Map<String, String> constructSocial(String paramString1, String paramString2, String paramString3)
    {
      return new HashMap();
    }
    
    public Map<String, String> constructTiming(String paramString1, long paramLong, String paramString2, String paramString3)
    {
      return new HashMap();
    }
    
    public Map<String, String> constructTransaction(Transaction paramTransaction)
    {
      return new HashMap();
    }
    
    public String get(String paramString)
    {
      return "";
    }
    
    public String getAppId()
    {
      return this.mAppId;
    }
    
    public String getAppInstallerId()
    {
      return this.mAppInstallerId;
    }
    
    public ExceptionParser getExceptionParser()
    {
      return this.mExceptionParser;
    }
    
    public double getSampleRate()
    {
      return this.mSampleRate;
    }
    
    public String getTrackingId()
    {
      return "";
    }
    
    public boolean isAnonymizeIpEnabled()
    {
      return this.mIsAnonymizeIp;
    }
    
    public boolean isUseSecure()
    {
      return this.mIsUseSecure;
    }
    
    public void send(String paramString, Map<String, String> paramMap) {}
    
    public void sendEvent(String paramString1, String paramString2, String paramString3, Long paramLong) {}
    
    public void sendException(String paramString, Throwable paramThrowable, boolean paramBoolean) {}
    
    public void sendException(String paramString, boolean paramBoolean) {}
    
    public void sendSocial(String paramString1, String paramString2, String paramString3) {}
    
    public void sendTiming(String paramString1, long paramLong, String paramString2, String paramString3) {}
    
    public void sendTransaction(Transaction paramTransaction) {}
    
    public void sendView() {}
    
    public void sendView(String paramString) {}
    
    public void set(String paramString1, String paramString2) {}
    
    public void setAnonymizeIp(boolean paramBoolean)
    {
      this.mIsAnonymizeIp = paramBoolean;
    }
    
    public void setAppId(String paramString)
    {
      this.mAppId = paramString;
    }
    
    public void setAppInstallerId(String paramString)
    {
      this.mAppInstallerId = paramString;
    }
    
    public void setAppName(String paramString) {}
    
    public void setAppScreen(String paramString) {}
    
    public void setAppVersion(String paramString) {}
    
    public void setCampaign(String paramString) {}
    
    public void setCustomDimension(int paramInt, String paramString) {}
    
    public void setCustomDimensionsAndMetrics(Map<Integer, String> paramMap, Map<Integer, Long> paramMap1) {}
    
    public void setCustomMetric(int paramInt, Long paramLong) {}
    
    public void setExceptionParser(ExceptionParser paramExceptionParser)
    {
      this.mExceptionParser = paramExceptionParser;
    }
    
    public void setReferrer(String paramString) {}
    
    public void setSampleRate(double paramDouble)
    {
      this.mSampleRate = paramDouble;
    }
    
    public void setStartSession(boolean paramBoolean) {}
    
    public void setUseSecure(boolean paramBoolean)
    {
      this.mIsUseSecure = paramBoolean;
    }
  }
  
  private class NotInForegroundTimerTask
    extends TimerTask
  {
    private NotInForegroundTimerTask() {}
    
    public void run()
    {
      EasyTracker.access$102(EasyTracker.this, false);
    }
  }
}
