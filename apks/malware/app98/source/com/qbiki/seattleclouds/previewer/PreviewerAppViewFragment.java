package com.qbiki.seattleclouds.previewer;

import android.graphics.Bitmap.CompressFormat;
import android.os.Bundle;
import android.support.v4.app.Fragment;
import android.support.v4.app.FragmentActivity;
import android.view.LayoutInflater;
import android.view.View;
import android.view.View.OnClickListener;
import android.view.ViewGroup;
import android.widget.Button;
import android.widget.ImageView;
import android.widget.TextView;
import com.google.android.bitmapfun.ImageCache.ImageCacheParams;
import com.google.android.bitmapfun.ImageFetcher;
import com.qbiki.scapi.HttpResponseException;
import com.qbiki.scapi.SCApi;
import com.qbiki.scapi.SCApiException;
import com.qbiki.scapi.SCApiRequestAsyncTask;
import com.qbiki.seattleclouds.App;
import com.qbiki.seattleclouds.SCFragment;
import java.io.IOException;
import java.util.Map;
import org.json.JSONException;
import org.json.JSONObject;

public class PreviewerAppViewFragment
  extends SCFragment
{
  public static final String ARG_APP_ID = "ARG_APP_ID";
  private SCApp mApp;
  private ImageFetcher mImageFetcher;
  private Button mSizeButton;
  
  public PreviewerAppViewFragment() {}
  
  public View onCreateView(LayoutInflater paramLayoutInflater, ViewGroup paramViewGroup, Bundle paramBundle)
  {
    paramBundle = paramLayoutInflater.inflate(2130903143, paramViewGroup, false);
    paramViewGroup = getArguments();
    paramLayoutInflater = null;
    if (paramViewGroup != null) {
      paramLayoutInflater = paramViewGroup.getString("ARG_APP_ID");
    }
    paramViewGroup = paramLayoutInflater;
    if (paramLayoutInflater == null) {
      paramViewGroup = "unknown";
    }
    if ((PreviewerAppsFragment.mAppsMap != null) && (PreviewerAppsFragment.mAppsMap.size() > 0)) {
      this.mApp = ((SCApp)PreviewerAppsFragment.mAppsMap.get(paramViewGroup));
    }
    if (this.mApp == null)
    {
      getActivity().finish();
      return paramBundle;
    }
    getActivity().setTitle(this.mApp.getTitle());
    paramLayoutInflater = (ImageView)paramBundle.findViewById(2131099944);
    paramViewGroup = (TextView)paramBundle.findViewById(2131099945);
    TextView localTextView1 = (TextView)paramBundle.findViewById(2131099947);
    TextView localTextView2 = (TextView)paramBundle.findViewById(2131099949);
    TextView localTextView3 = (TextView)paramBundle.findViewById(2131099735);
    this.mSizeButton = ((Button)paramBundle.findViewById(2131099950));
    Button localButton = (Button)paramBundle.findViewById(2131099951);
    ImageCache.ImageCacheParams localImageCacheParams = new ImageCache.ImageCacheParams(getActivity(), "previewer/appIcons");
    localImageCacheParams.diskCacheEnabled = true;
    localImageCacheParams.compressFormat = Bitmap.CompressFormat.PNG;
    localImageCacheParams.memoryCacheEnabled = false;
    this.mImageFetcher = new ImageFetcher(getActivity(), PreviewerAppsFragment.mIconSize, false);
    this.mImageFetcher.addImageCache(getActivity().getSupportFragmentManager(), localImageCacheParams);
    this.mImageFetcher.loadImage(this.mApp.getIconLink(), paramLayoutInflater);
    paramViewGroup.setText(this.mApp.getId());
    localTextView1.setText(this.mApp.getPlatformString());
    localTextView2.setText("v" + this.mApp.getVersion());
    localTextView3.setText(this.mApp.getDescription());
    if (this.mApp.getResourcesSize() > 0L) {
      this.mSizeButton.setText(SCApp.getResourcesSizeString(this.mApp.getResourcesSize()));
    }
    for (;;)
    {
      this.mSizeButton.setOnClickListener(new View.OnClickListener()
      {
        public void onClick(View paramAnonymousView)
        {
          PreviewerAppViewFragment.this.mSizeButton.setEnabled(false);
          new PreviewerAppViewFragment.RefreshAppSizeTask(PreviewerAppViewFragment.this, PreviewerAppViewFragment.this).execute(new Void[0]);
        }
      });
      localButton.setOnClickListener(new View.OnClickListener()
      {
        public void onClick(View paramAnonymousView)
        {
          PreviewerAppsFragment.startApp(PreviewerAppViewFragment.this.getActivity(), PreviewerAppViewFragment.this.mApp.getId());
        }
      });
      return paramBundle;
      this.mSizeButton.setText(2131361958);
    }
  }
  
  private class RefreshAppSizeTask
    extends SCApiRequestAsyncTask<Void, Void, String>
  {
    public RefreshAppSizeTask(Fragment paramFragment)
    {
      super();
    }
    
    protected void onPostExecute(String paramString)
    {
      if (paramString != null)
      {
        PreviewerAppViewFragment.this.mSizeButton.setText(SCApp.getResourcesSizeString(PreviewerAppViewFragment.this.mApp.getResourcesSize()));
        return;
      }
      PreviewerAppViewFragment.this.mSizeButton.setEnabled(true);
    }
    
    protected String performRequest(Void... paramVarArgs)
      throws IOException, JSONException, HttpResponseException, SCApiException
    {
      paramVarArgs = SCApi.getInstance().getAppResourcesSize(App.username, PreviewerAppViewFragment.this.mApp.getId());
      PreviewerAppViewFragment.this.mApp.setResourcesSize(paramVarArgs.getLong("resourcesSize"));
      return "ok";
    }
  }
}
