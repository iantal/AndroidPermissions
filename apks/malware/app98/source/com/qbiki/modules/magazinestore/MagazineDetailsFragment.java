package com.qbiki.modules.magazinestore;

import android.os.Bundle;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.View;
import android.view.View.OnClickListener;
import android.view.ViewGroup;
import android.view.ViewTreeObserver;
import android.view.ViewTreeObserver.OnGlobalLayoutListener;
import android.widget.Button;
import android.widget.ImageView;
import android.widget.TextView;
import com.qbiki.billing.SCIabHelper;
import com.qbiki.seattleclouds.SCFragment;
import com.qbiki.util.DeviceUtil;
import com.qbiki.util.ResourceImageResizer;

public class MagazineDetailsFragment
  extends SCFragment
{
  public static final String ARG_MAGAZINE_INFO = "ARG_MAGAZINE_INFO";
  private static final String TAG = "MagazineDetailsFragment";
  private static final boolean mDebugLayout = false;
  private Button mActionButton;
  private java.text.DateFormat mDateFormat;
  private ResourceImageResizer mImageFetcher;
  private MagazineInfo mMagazineInfo;
  private View mRootView;
  
  public MagazineDetailsFragment() {}
  
  private void refreshActionButton()
  {
    this.mActionButton.setText(MagazineStoreFragment.getActionString(getActivity(), this.mMagazineInfo));
  }
  
  public void onActiveChanged(boolean paramBoolean)
  {
    super.onActiveChanged(paramBoolean);
    if (paramBoolean)
    {
      SCIabHelper localSCIabHelper = SCIabHelper.getInstance();
      if ((localSCIabHelper != null) && (localSCIabHelper.isOwnedProduct(this.mMagazineInfo.productIdentifier)))
      {
        this.mMagazineInfo.productOwned = true;
        if (this.mActionButton != null) {
          refreshActionButton();
        }
      }
    }
  }
  
  public void onCreate(Bundle paramBundle)
  {
    super.onCreate(paramBundle);
    paramBundle = getArguments();
    if (paramBundle != null) {
      this.mMagazineInfo = ((MagazineInfo)paramBundle.getParcelable("ARG_MAGAZINE_INFO"));
    }
    if (this.mMagazineInfo == null)
    {
      Log.e("MagazineDetailsFragment", "MagazineInfo is null");
      return;
    }
    this.mImageFetcher = new ResourceImageResizer(getActivity(), DeviceUtil.dpToPx(getActivity(), 280.0F));
    this.mDateFormat = android.text.format.DateFormat.getMediumDateFormat(getActivity());
  }
  
  public View onCreateView(final LayoutInflater paramLayoutInflater, ViewGroup paramViewGroup, Bundle paramBundle)
  {
    this.mRootView = paramLayoutInflater.inflate(2130903137, paramViewGroup, false);
    paramLayoutInflater = (ImageView)this.mRootView.findViewById(2131099933);
    paramViewGroup = (TextView)this.mRootView.findViewById(2131099734);
    paramBundle = (TextView)this.mRootView.findViewById(2131099934);
    TextView localTextView = (TextView)this.mRootView.findViewById(2131099735);
    this.mActionButton = ((Button)this.mRootView.findViewById(2131099935));
    if (this.mMagazineInfo != null)
    {
      paramViewGroup.setText(this.mMagazineInfo.title);
      paramBundle.setText(this.mDateFormat.format(this.mMagazineInfo.publishDate));
      refreshActionButton();
      localTextView.setText(this.mMagazineInfo.description);
      paramLayoutInflater.getViewTreeObserver().addOnGlobalLayoutListener(new ViewTreeObserver.OnGlobalLayoutListener()
      {
        private int mCurrentCoverWidth = 0;
        
        public void onGlobalLayout()
        {
          if (this.mCurrentCoverWidth != paramLayoutInflater.getWidth())
          {
            this.mCurrentCoverWidth = paramLayoutInflater.getWidth();
            int i = this.mCurrentCoverWidth + this.mCurrentCoverWidth / 5;
            int j = (int)(i / 0.74D);
            MagazineDetailsFragment.this.mImageFetcher.setImageSize(i, j);
            MagazineDetailsFragment.this.mImageFetcher.loadImage(MagazineDetailsFragment.this.mMagazineInfo.coverName, paramLayoutInflater);
          }
        }
      });
      this.mActionButton.setOnClickListener(new View.OnClickListener()
      {
        public void onClick(View paramAnonymousView)
        {
          MagazineStoreFragment.launchPurchase(MagazineDetailsFragment.this.mMagazineInfo, MagazineDetailsFragment.this);
        }
      });
    }
    return this.mRootView;
  }
}
