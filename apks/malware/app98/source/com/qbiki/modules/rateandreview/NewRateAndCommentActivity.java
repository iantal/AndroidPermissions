package com.qbiki.modules.rateandreview;

import android.content.Intent;
import android.content.res.Resources;
import android.net.ConnectivityManager;
import android.net.NetworkInfo;
import android.os.AsyncTask;
import android.os.Bundle;
import android.util.Log;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Button;
import android.widget.EditText;
import android.widget.LinearLayout;
import android.widget.RatingBar;
import android.widget.RatingBar.OnRatingBarChangeListener;
import android.widget.TextView;
import com.qbiki.seattleclouds.App;
import com.qbiki.seattleclouds.SCActivity;
import com.qbiki.util.DialogUtil;
import com.qbiki.util.HTTPUtil;
import com.qbiki.util.StyleUtil;
import java.io.IOException;
import java.io.UnsupportedEncodingException;
import java.net.URLEncoder;

public class NewRateAndCommentActivity
  extends SCActivity
{
  private static final String TAG = "NewRateAndCommentActivity";
  private String fbid = "";
  private String fbname = "";
  private String pageid = "";
  private Bundle style;
  
  public NewRateAndCommentActivity() {}
  
  private void closeAndRefreshComment()
  {
    Intent localIntent = new Intent();
    localIntent.putExtra("result", "OK");
    setResult(-1, localIntent);
    finish();
  }
  
  private void postRateAndComment()
  {
    ConnectivityManager localConnectivityManager = (ConnectivityManager)getSystemService("connectivity");
    if ((localConnectivityManager.getActiveNetworkInfo() == null) || (!localConnectivityManager.getActiveNetworkInfo().isConnected()))
    {
      DialogUtil.showAlert(this, getResources().getString(2131361915), getResources().getString(2131362162));
      return;
    }
    new RateAsyncTask(null).execute(new Void[0]);
  }
  
  protected void onCreate(final Bundle paramBundle)
  {
    super.onCreate(paramBundle);
    setContentView(2130903173);
    paramBundle = getIntent().getExtras();
    if (paramBundle != null)
    {
      this.pageid = paramBundle.getString("pageid");
      this.fbid = paramBundle.getString("fbid");
      this.fbname = paramBundle.getString("fbname");
      this.style = paramBundle.getBundle("PAGE_STYLE");
    }
    StyleUtil.setBackground((LinearLayout)findViewById(2131100057), this.style);
    paramBundle = (Button)findViewById(2131100062);
    paramBundle.setOnClickListener(new View.OnClickListener()
    {
      public void onClick(View paramAnonymousView)
      {
        paramBundle.setEnabled(false);
        NewRateAndCommentActivity.this.postRateAndComment();
      }
    });
    paramBundle = (RatingBar)findViewById(2131100058);
    paramBundle.setOnRatingBarChangeListener(new RatingBar.OnRatingBarChangeListener()
    {
      public void onRatingChanged(RatingBar paramAnonymousRatingBar, float paramAnonymousFloat, boolean paramAnonymousBoolean)
      {
        paramAnonymousRatingBar = (TextView)NewRateAndCommentActivity.this.findViewById(2131100059);
        if ((int)paramAnonymousFloat == 0) {
          ((RatingBar)NewRateAndCommentActivity.this.findViewById(2131100058)).setRating(1.0F);
        }
        do
        {
          return;
          if ((int)paramAnonymousFloat == 1)
          {
            paramAnonymousRatingBar.setText(NewRateAndCommentActivity.this.getResources().getString(2131362166));
            return;
          }
          if ((int)paramAnonymousFloat == 2)
          {
            paramAnonymousRatingBar.setText(NewRateAndCommentActivity.this.getResources().getString(2131362167));
            return;
          }
          if ((int)paramAnonymousFloat == 3)
          {
            paramAnonymousRatingBar.setText(NewRateAndCommentActivity.this.getResources().getString(2131362168));
            return;
          }
          if ((int)paramAnonymousFloat == 4)
          {
            paramAnonymousRatingBar.setText(NewRateAndCommentActivity.this.getResources().getString(2131362169));
            return;
          }
        } while ((int)paramAnonymousFloat != 5);
        paramAnonymousRatingBar.setText(NewRateAndCommentActivity.this.getResources().getString(2131362170));
      }
    });
    paramBundle.setRating(1.0F);
    StyleUtil.setTextColor((TextView)findViewById(2131099739), this.style);
    StyleUtil.setTextColor((TextView)findViewById(2131100059), this.style);
    StyleUtil.setTextColor((TextView)findViewById(2131100060), this.style);
  }
  
  private class RateAsyncTask
    extends AsyncTask<Void, Void, String>
  {
    private RateAsyncTask() {}
    
    protected String doInBackground(Void... paramVarArgs)
    {
      paramVarArgs = "";
      try
      {
        str = URLEncoder.encode(NewRateAndCommentActivity.this.fbname, "UTF-8");
        paramVarArgs = str;
      }
      catch (UnsupportedEncodingException localUnsupportedEncodingException)
      {
        for (;;)
        {
          try
          {
            String str;
            int i;
            paramVarArgs = HTTPUtil.performPostRequest(paramVarArgs, str);
            return paramVarArgs;
          }
          catch (IOException paramVarArgs)
          {
            Log.e("NewRateAndCommentActivity", paramVarArgs.getMessage());
          }
          localUnsupportedEncodingException = localUnsupportedEncodingException;
          Log.e("NewRateAndCommentActivity", localUnsupportedEncodingException.getMessage());
        }
      }
      paramVarArgs = paramVarArgs.replace("+", "%20");
      i = (int)((RatingBar)NewRateAndCommentActivity.this.findViewById(2131100058)).getRating();
      paramVarArgs = "http://" + App.serverHostName + "/rateit.ashx?" + "username=" + App.username + "&appid=" + App.appId + "&pageid=" + NewRateAndCommentActivity.this.pageid + "&fbid=" + NewRateAndCommentActivity.this.fbid + "&fbname=" + paramVarArgs + "&rate=" + i + "&publisherid=" + App.publisherId;
      str = ((EditText)NewRateAndCommentActivity.this.findViewById(2131100061)).getText().toString();
      return "null";
    }
    
    protected void onPostExecute(String paramString)
    {
      super.onPostExecute(paramString);
      if (paramString.equalsIgnoreCase("OK"))
      {
        NewRateAndCommentActivity.this.closeAndRefreshComment();
        return;
      }
      DialogUtil.showAlert(NewRateAndCommentActivity.this, NewRateAndCommentActivity.this.getResources().getString(2131361915), paramString);
    }
    
    protected void onPreExecute()
    {
      super.onPreExecute();
      ((RatingBar)NewRateAndCommentActivity.this.findViewById(2131100058)).setEnabled(false);
    }
  }
}
