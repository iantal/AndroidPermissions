package org.jsoup.safety;

import java.util.Iterator;
import java.util.List;
import org.jsoup.helper.Validate;
import org.jsoup.nodes.Attribute;
import org.jsoup.nodes.Attributes;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.nodes.Node;
import org.jsoup.nodes.TextNode;
import org.jsoup.parser.Tag;

public class Cleaner
{
  private Whitelist whitelist;
  
  public Cleaner(Whitelist paramWhitelist)
  {
    Validate.notNull(paramWhitelist);
    this.whitelist = paramWhitelist;
  }
  
  private int copySafeNodes(Element paramElement1, Element paramElement2)
  {
    paramElement1 = paramElement1.childNodes();
    int i = 0;
    paramElement1 = paramElement1.iterator();
    while (paramElement1.hasNext())
    {
      Object localObject = (Node)paramElement1.next();
      if ((localObject instanceof Element))
      {
        localObject = (Element)localObject;
        if (this.whitelist.isSafeTag(((Element)localObject).tagName()))
        {
          ElementMeta localElementMeta = createSafeElement((Element)localObject);
          Element localElement = localElementMeta.el;
          paramElement2.appendChild(localElement);
          i = i + localElementMeta.numAttribsDiscarded + copySafeNodes((Element)localObject, localElement);
        }
        else
        {
          i = i + 1 + copySafeNodes((Element)localObject, paramElement2);
        }
      }
      else if ((localObject instanceof TextNode))
      {
        paramElement2.appendChild(new TextNode(((TextNode)localObject).getWholeText(), ((Node)localObject).baseUri()));
      }
    }
    return i;
  }
  
  private ElementMeta createSafeElement(Element paramElement)
  {
    String str = paramElement.tagName();
    Attributes localAttributes = new Attributes();
    Element localElement = new Element(Tag.valueOf(str), paramElement.baseUri(), localAttributes);
    int i = 0;
    Iterator localIterator = paramElement.attributes().iterator();
    while (localIterator.hasNext())
    {
      Attribute localAttribute = (Attribute)localIterator.next();
      if (this.whitelist.isSafeAttribute(str, paramElement, localAttribute)) {
        localAttributes.put(localAttribute);
      } else {
        i += 1;
      }
    }
    localAttributes.addAll(this.whitelist.getEnforcedAttributes(str));
    return new ElementMeta(localElement, i);
  }
  
  public Document clean(Document paramDocument)
  {
    Validate.notNull(paramDocument);
    Document localDocument = Document.createShell(paramDocument.baseUri());
    copySafeNodes(paramDocument.body(), localDocument.body());
    return localDocument;
  }
  
  public boolean isValid(Document paramDocument)
  {
    Validate.notNull(paramDocument);
    Document localDocument = Document.createShell(paramDocument.baseUri());
    return copySafeNodes(paramDocument.body(), localDocument.body()) == 0;
  }
  
  private static class ElementMeta
  {
    Element el;
    int numAttribsDiscarded;
    
    ElementMeta(Element paramElement, int paramInt)
    {
      this.el = paramElement;
      this.numAttribsDiscarded = paramInt;
    }
  }
}
