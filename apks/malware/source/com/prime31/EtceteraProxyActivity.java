package com.prime31;

import android.app.Activity;
import android.content.ContentResolver;
import android.content.Intent;
import android.content.res.AssetFileDescriptor;
import android.database.Cursor;
import android.net.Uri;
import android.os.Bundle;
import android.provider.MediaStore.Images.Media;
import android.util.Log;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;

public class EtceteraProxyActivity
  extends Activity
{
  public static final String PROXY_ALBUM = "album";
  public static final String PROXY_CAMERA = "camera";
  public static final String PROXY_VIDEO = "video";
  private static String _destinationFilePath;
  private static String _type;
  private final int RESULT_ALBUM = 222;
  private final int RESULT_CAMERA = 111;
  private final int RESULT_VIDEO = 333;
  
  public EtceteraProxyActivity() {}
  
  private void handleAlbum(int paramInt, Intent paramIntent)
  {
    if (paramInt == -1)
    {
      Object localObject = paramIntent.getData();
      Log.i("Prime31-Proxy", "gettng Intends extra data. imageUri: " + localObject);
      paramIntent = ((Uri)localObject).getPath();
      localObject = getPath((Uri)localObject);
      Log.i("Prime31-Proxy", "selectedImagePath: " + (String)localObject);
      Log.i("Prime31-Proxy", "fileManagerPath: " + paramIntent);
      if (localObject != null)
      {
        EtceteraPlugin.instance().photoAlbumItemChosen((String)localObject);
        return;
      }
      if (paramIntent != null)
      {
        EtceteraPlugin.instance().photoAlbumItemChosen(paramIntent);
        return;
      }
      EtceteraPlugin.instance().photoAlbumItemChosen(null);
      return;
    }
    EtceteraPlugin.instance().photoAlbumItemChosen(null);
  }
  
  private void handleCamera(int paramInt, Intent paramIntent)
  {
    Log.i("Prime31-Proxy", "camera completed. going to try to find the image after checking result");
    if (paramInt == -1)
    {
      File localFile;
      if (hasImageCaptureBug())
      {
        localFile = new File("/sdcard/tmp");
        try
        {
          localUri = Uri.parse(MediaStore.Images.Media.insertImage(getContentResolver(), localFile.getAbsolutePath(), null, null));
          if (localUri == null) {
            Log.i("Prime31-Proxy", "uri is null. could not insert image into MediaStore");
          }
        }
        catch (FileNotFoundException localFileNotFoundException)
        {
          for (;;)
          {
            Uri localUri;
            Log.i("Prime31-Proxy", "camera failed to write image to disk location: " + localFile.getAbsolutePath());
          }
        }
        catch (Exception localException)
        {
          for (;;)
          {
            Log.e("Prime31-Proxy", "error saving image to media store: " + localException.getMessage());
            Log.e("Prime31-Proxy", "absolute path of file is: " + localFile.getAbsolutePath());
          }
        }
        try
        {
          paramIntent = paramIntent.getData();
          Log.i("Prime31-Proxy", "last ditch check for buggy devices. direct uri get returns: " + paramIntent);
          EtceteraPlugin.instance().cameraPhotoTaken(getPath(paramIntent));
          return;
        }
        catch (Exception paramIntent)
        {
          Log.e("Prime31-Proxy", "last ditch effor for naughty devices failed: " + paramIntent.getMessage());
          EtceteraPlugin.instance().cameraPhotoTaken(null);
          return;
        }
        EtceteraPlugin.instance().cameraPhotoTaken(getPath(localUri));
        return;
      }
      paramIntent = paramIntent.getData();
      EtceteraPlugin.instance().cameraPhotoTaken(getPath(paramIntent));
      return;
    }
    EtceteraPlugin.instance().cameraPhotoTaken(null);
    Log.i("Prime31-Proxy", "camera failed. resultCode: " + paramInt);
    paramIntent = new File(getCacheDir().getAbsolutePath() + "/someImage.jpg");
    Log.i("Prime31-Proxy", "does the file somehow exist anyway?: " + paramIntent.exists());
  }
  
  private void handleVideo(int paramInt, Intent paramIntent)
  {
    if (paramInt == -1) {
      try
      {
        paramIntent = getContentResolver().openAssetFileDescriptor(paramIntent.getData(), "r").createInputStream();
        FileOutputStream localFileOutputStream = new FileOutputStream(new File(_destinationFilePath));
        byte[] arrayOfByte = new byte['Ð€'];
        for (;;)
        {
          paramInt = paramIntent.read(arrayOfByte);
          if (paramInt <= 0)
          {
            paramIntent.close();
            localFileOutputStream.close();
            Log.i("Prime31", "wrote file to: " + _destinationFilePath);
            EtceteraPlugin.instance().videoTaken(_destinationFilePath);
            return;
          }
          localFileOutputStream.write(arrayOfByte, 0, paramInt);
        }
        EtceteraPlugin.instance().videoTaken(null);
      }
      catch (IOException paramIntent)
      {
        Log.i("Prime31-Proxy", "error saving video: " + paramIntent.getMessage());
        EtceteraPlugin.instance().videoTaken(null);
        return;
      }
    }
  }
  
  public String getPath(Uri paramUri)
  {
    if (paramUri == null) {}
    do
    {
      return null;
      paramUri = managedQuery(paramUri, new String[] { "_data" }, null, null, null);
    } while (paramUri == null);
    int i = paramUri.getColumnIndexOrThrow("_data");
    paramUri.moveToFirst();
    return paramUri.getString(i);
  }
  
  public boolean hasImageCaptureBug()
  {
    return true;
  }
  
  public void onActivityResult(int paramInt1, int paramInt2, Intent paramIntent)
  {
    super.onActivityResult(paramInt1, paramInt2, paramIntent);
    if (paramInt1 == 222) {}
    try
    {
      Log.i("Prime31-Proxy", "processing ALBUM result");
      handleAlbum(paramInt2, paramIntent);
      for (;;)
      {
        finish();
        return;
        if (paramInt1 != 111) {
          break;
        }
        Log.i("Prime31-Proxy", "processing CAMERA result");
        handleCamera(paramInt2, paramIntent);
      }
    }
    catch (Exception paramIntent)
    {
      for (;;)
      {
        Log.e("Prime31-Proxy", "fatal error retrieving image: " + paramIntent.getMessage());
        if (paramInt1 == 222)
        {
          EtceteraPlugin.instance().photoAlbumItemChosen(null);
          continue;
          if (paramInt1 == 333)
          {
            Log.i("Prime31-Proxy", "processing VIDEO result");
            handleVideo(paramInt2, paramIntent);
          }
        }
        else if (paramInt1 == 111)
        {
          EtceteraPlugin.instance().cameraPhotoTaken(null);
        }
        else if (paramInt1 == 333)
        {
          EtceteraPlugin.instance().videoTaken(null);
        }
      }
    }
  }
  
  public void onCreate(Bundle paramBundle)
  {
    super.onCreate(paramBundle);
    _type = getIntent().getExtras().getString("type");
    Log.i("Prime31-Proxy", "proxy received action: " + _type);
    if (_type.equals("album"))
    {
      paramBundle = new Intent();
      paramBundle.setType("image/*");
      paramBundle.setAction("android.intent.action.GET_CONTENT");
      startActivityForResult(Intent.createChooser(paramBundle, "Select Picture"), 222);
    }
    do
    {
      return;
      if (_type.equals("camera"))
      {
        paramBundle = new Intent("android.media.action.IMAGE_CAPTURE");
        if (hasImageCaptureBug()) {
          paramBundle.putExtra("output", Uri.fromFile(new File("/sdcard/tmp")));
        }
        for (;;)
        {
          startActivityForResult(paramBundle, 111);
          return;
          paramBundle.putExtra("output", MediaStore.Images.Media.EXTERNAL_CONTENT_URI);
        }
      }
    } while (!_type.equals("video"));
    _destinationFilePath = getIntent().getExtras().getString("path");
    startActivityForResult(new Intent("android.media.action.VIDEO_CAPTURE"), 333);
  }
}
