package com.umeng.analytics;

import android.content.Context;
import com.umeng.common.Log;
import com.umeng.common.b;
import com.umeng.common.b.g;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.PrintWriter;
import java.io.StringWriter;
import org.json.JSONArray;
import org.json.JSONObject;

public class a
  implements Thread.UncaughtExceptionHandler
{
  private static final String c = "com_umeng__crash.cache";
  private Thread.UncaughtExceptionHandler a;
  private Context b;
  
  public a() {}
  
  private void a(Throwable paramThrowable)
  {
    if (paramThrowable == null)
    {
      Log.e("MobclickAgent", "Exception is null in handleException");
      return;
    }
    a(this.b, paramThrowable);
  }
  
  public void a(Context paramContext)
  {
    this.b = paramContext;
    this.a = Thread.getDefaultUncaughtExceptionHandler();
    Thread.setDefaultUncaughtExceptionHandler(this);
  }
  
  void a(Context paramContext, String paramString)
  {
    try
    {
      Object localObject = g.a();
      String str1 = localObject.split(" ")[0];
      String str2 = localObject.split(" ")[1];
      localObject = new JSONObject();
      ((JSONObject)localObject).put("date", str1);
      ((JSONObject)localObject).put("time", str2);
      ((JSONObject)localObject).put("context", paramString);
      ((JSONObject)localObject).put("type", "error");
      ((JSONObject)localObject).put("version", b.d(paramContext));
      paramString = b(paramContext);
      paramContext = paramString;
      if (paramString == null) {
        paramContext = new JSONArray();
      }
      paramContext.put(localObject);
      paramString = this.b.openFileOutput("com_umeng__crash.cache", 0);
      paramString.write(paramContext.toString().getBytes());
      paramString.flush();
      paramString.close();
      return;
    }
    catch (Exception paramContext)
    {
      Log.b("MobclickAgent", "an error occured while writing report file...", paramContext);
    }
  }
  
  void a(Context paramContext, Throwable paramThrowable)
  {
    StringWriter localStringWriter = new StringWriter();
    PrintWriter localPrintWriter = new PrintWriter(localStringWriter);
    paramThrowable.printStackTrace(localPrintWriter);
    for (paramThrowable = paramThrowable.getCause(); paramThrowable != null; paramThrowable = paramThrowable.getCause()) {
      paramThrowable.printStackTrace(localPrintWriter);
    }
    paramThrowable = localStringWriter.toString();
    localPrintWriter.close();
    a(paramContext, paramThrowable);
  }
  
  JSONArray b(Context paramContext)
  {
    Object localObject = null;
    File localFile = new File(paramContext.getFilesDir(), "com_umeng__crash.cache");
    StringBuffer localStringBuffer;
    try
    {
      if (!localFile.exists()) {
        return null;
      }
      paramContext = paramContext.openFileInput("com_umeng__crash.cache");
      localStringBuffer = new StringBuffer();
      byte[] arrayOfByte = new byte['Ð€'];
      for (;;)
      {
        int i = paramContext.read(arrayOfByte);
        if (i == -1) {
          break;
        }
        localStringBuffer.append(new String(arrayOfByte, 0, i));
      }
      try
      {
        localFile.delete();
        return paramContext;
      }
      catch (Exception localException)
      {
        localException.printStackTrace();
        return paramContext;
      }
    }
    catch (Exception paramContext)
    {
      paramContext.printStackTrace();
      paramContext = localObject;
    }
    paramContext.close();
    if (localStringBuffer.length() != 0) {}
    for (paramContext = new JSONArray(localStringBuffer.toString());; paramContext = null) {
      break;
    }
  }
  
  public void uncaughtException(Thread paramThread, Throwable paramThrowable)
  {
    a(paramThrowable);
    if (this.a != null) {
      this.a.uncaughtException(paramThread, paramThrowable);
    }
  }
}
