package com.umeng.update;

import android.app.AlertDialog;
import android.app.AlertDialog.Builder;
import android.content.Context;
import android.content.SharedPreferences;
import android.content.SharedPreferences.Editor;
import android.os.Looper;
import com.umeng.common.Log;
import com.umeng.common.b.g;
import com.umeng.common.c;
import com.umeng.common.net.j;
import com.umeng.common.net.k;
import org.json.JSONObject;

public class UmengUpdateAgent
{
  public static final String a = "1.0.0.20120516";
  private static boolean b = true;
  private static boolean c = true;
  private static String d = "update";
  private static final String e = "update";
  private static UmengUpdateListener f = null;
  private static final String g = "umeng_last_update_time";
  private static final String h = "umeng_update_internal";
  private static final String[] i = { "http://www.umeng.com/api/check_app_update", "http://www.umeng.co/api/check_app_update" };
  private static UmengUpdateAgent j = null;
  
  public UmengUpdateAgent() {}
  
  private static SharedPreferences a(Context paramContext)
  {
    StringBuffer localStringBuffer = new StringBuffer();
    localStringBuffer.append("umeng_analytic_online_setting_");
    localStringBuffer.append(com.umeng.common.b.t(paramContext));
    return paramContext.getSharedPreferences(localStringBuffer.toString(), 0);
  }
  
  private static void b(int paramInt, UpdateResponse paramUpdateResponse)
  {
    if (f != null) {
      f.onUpdateReturned(paramInt, paramUpdateResponse);
    }
  }
  
  private static void b(Context paramContext, String paramString)
  {
    Log.a("update", "url: " + paramString);
    new com.umeng.common.net.a(paramContext, "update", com.umeng.common.b.u(paramContext), paramString, null).a();
  }
  
  private static UmengUpdateAgent e()
  {
    if (j == null) {
      j = new UmengUpdateAgent();
    }
    return j;
  }
  
  public static void setUpdateAutoPopup(boolean paramBoolean)
  {
    c = paramBoolean;
  }
  
  public static void setUpdateListener(UmengUpdateListener paramUmengUpdateListener)
  {
    f = paramUmengUpdateListener;
  }
  
  public static void setUpdateOnlyWifi(boolean paramBoolean)
  {
    b = paramBoolean;
  }
  
  public static void showUpdateDialog(Context paramContext, UpdateResponse paramUpdateResponse)
  {
    Object localObject = "";
    try
    {
      if (!com.umeng.common.b.k(paramContext)) {
        localObject = paramContext.getString(c.a(paramContext).f("UMGprsCondition")) + "\n";
      }
      StringBuffer localStringBuffer = new StringBuffer();
      localStringBuffer.append((String)localObject);
      localStringBuffer.append(paramContext.getString(c.a(paramContext).f("UMNewVersion")));
      localStringBuffer.append(paramUpdateResponse.version);
      localStringBuffer.append("\n");
      localStringBuffer.append(paramUpdateResponse.updateLog);
      localObject = new AlertDialog.Builder(paramContext);
      ((AlertDialog.Builder)localObject).setTitle(paramContext.getString(c.a(paramContext).f("UMUpdateTitle"))).setMessage(localStringBuffer.toString()).setPositiveButton(paramContext.getString(c.a(paramContext).f("UMUpdateNow")), new a(paramContext, paramUpdateResponse)).setNegativeButton(paramContext.getString(c.a(paramContext).f("UMNotNow")), new b());
      ((AlertDialog.Builder)localObject).create().show();
      return;
    }
    catch (Exception paramContext)
    {
      Log.b(d, "Fail to create update dialog box.", paramContext);
    }
  }
  
  public static void update(Context paramContext)
  {
    try
    {
      if ((b) && (!com.umeng.common.b.k(paramContext)))
      {
        b(UpdateStatus.NoneWifi, null);
        return;
      }
      if (paramContext == null)
      {
        b(UpdateStatus.No, null);
        Log.b(d, "unexpected null context in update");
        return;
      }
    }
    catch (Exception paramContext)
    {
      Log.b(d, "Exception occurred in Mobclick.update(). ", paramContext);
      return;
    }
    UmengUpdateAgent localUmengUpdateAgent = e();
    localUmengUpdateAgent.getClass();
    new Thread(new a(localUmengUpdateAgent, paramContext)).start();
  }
  
  public static void update(Context paramContext, long paramLong)
  {
    if (paramContext == null) {
      Log.a(d, "unexpected null Context");
    }
    SharedPreferences localSharedPreferences;
    long l1;
    long l2;
    do
    {
      return;
      localSharedPreferences = a(paramContext);
      l1 = localSharedPreferences.getLong("umeng_last_update_time", 0L);
      paramLong = localSharedPreferences.getLong("umeng_update_internal", paramLong);
      l2 = System.currentTimeMillis();
    } while (l2 - l1 <= paramLong);
    update(paramContext);
    localSharedPreferences.edit().putLong("umeng_last_update_time", l2).commit();
  }
  
  public static void update(Context paramContext, String paramString)
  {
    com.umeng.common.a.m = paramString;
    update(paramContext);
  }
  
  public class a
    extends j
    implements Runnable
  {
    Context a;
    
    public a(Context paramContext)
    {
      this.a = paramContext;
    }
    
    private JSONObject a(Context paramContext)
    {
      JSONObject localJSONObject = new JSONObject();
      try
      {
        localJSONObject.put("type", "update");
        localJSONObject.put("appkey", com.umeng.common.b.p(paramContext));
        localJSONObject.put("version_code", com.umeng.common.b.d(paramContext));
        localJSONObject.put("package", com.umeng.common.b.t(paramContext));
        localJSONObject.put("sdk_version", "1.0.0.20120516");
        localJSONObject.put("idmd5", g.b(com.umeng.common.b.f(paramContext)));
        localJSONObject.put("channel", com.umeng.common.b.s(paramContext));
        return localJSONObject;
      }
      catch (Exception paramContext)
      {
        Log.b(UmengUpdateAgent.a(), "exception in updateInternal", paramContext);
      }
      return null;
    }
    
    private void b()
    {
      Object localObject1 = a(this.a);
      Object localObject2 = UmengUpdateAgent.b();
      localObject2.getClass();
      UmengUpdateAgent.b localB = new UmengUpdateAgent.b((UmengUpdateAgent)localObject2, (JSONObject)localObject1);
      int i = 0;
      for (localObject1 = null;; localObject1 = localObject2)
      {
        if (i >= UmengUpdateAgent.c().length) {}
        do
        {
          if (localObject1 == null) {
            UmengUpdateAgent.a(UpdateStatus.Timeout, null);
          }
          Log.a(UmengUpdateAgent.a(), "response : " + ((UpdateResponse)localObject1).hasUpdate);
          if (!((UpdateResponse)localObject1).hasUpdate) {
            break;
          }
          UmengUpdateAgent.a(UpdateStatus.Yes, (UpdateResponse)localObject1);
          if (UmengUpdateAgent.d()) {
            UmengUpdateAgent.showUpdateDialog(this.a, (UpdateResponse)localObject1);
          }
          return;
          localB.a(UmengUpdateAgent.c()[i]);
          localObject2 = (UpdateResponse)a(localB, UpdateResponse.class);
          localObject1 = localObject2;
        } while (localObject2 != null);
        i += 1;
      }
      UmengUpdateAgent.a(UpdateStatus.No, null);
    }
    
    public boolean a()
    {
      return false;
    }
    
    public void run()
    {
      try
      {
        Looper.prepare();
        b();
        Looper.loop();
        return;
      }
      catch (Exception localException)
      {
        UmengUpdateAgent.a(UpdateStatus.No, null);
        Log.a(UmengUpdateAgent.a(), "reques update error", localException);
      }
    }
  }
  
  public class b
    extends k
  {
    private JSONObject e;
    
    public b(JSONObject paramJSONObject)
    {
      super();
      this.e = paramJSONObject;
    }
    
    public JSONObject a()
    {
      return this.e;
    }
    
    public String b()
    {
      return this.c;
    }
  }
}
