package com.abarakat.webview;

import android.content.Context;
import android.content.Intent;
import android.net.Uri;
import android.os.AsyncTask;
import android.os.Environment;
import android.util.Log;
import android.webkit.WebView;
import android.webkit.WebViewClient;
import android.widget.Toast;
import java.io.BufferedInputStream;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.math.BigInteger;
import java.net.URL;
import java.net.URLConnection;
import java.security.SecureRandom;
import org.apache.http.util.ByteArrayBuffer;

public class IntentWebViewClient
  extends WebViewClient
{
  protected InitTask _initTask;
  protected Context context;
  
  public IntentWebViewClient(Context paramContext)
  {
    this.context = paramContext;
  }
  
  public void DownloadFromUrl(String paramString1, String paramString2)
  {
    try
    {
      Object localObject = new File(Environment.getExternalStorageDirectory().getAbsolutePath() + "/Download/");
      if (!((File)localObject).exists()) {
        ((File)localObject).mkdirs();
      }
      URL localURL = new URL(paramString1);
      paramString1 = new File((File)localObject, paramString2);
      long l = System.currentTimeMillis();
      Log.d("DownloadManager", "download begining");
      Log.d("DownloadManager", "download url:" + localURL);
      Log.d("DownloadManager", "downloaded file name:" + paramString2);
      localObject = new BufferedInputStream(localURL.openConnection().getInputStream());
      paramString2 = new ByteArrayBuffer(5000);
      for (;;)
      {
        int i = ((BufferedInputStream)localObject).read();
        if (i == -1)
        {
          paramString1 = new FileOutputStream(paramString1);
          paramString1.write(paramString2.toByteArray());
          paramString1.flush();
          paramString1.close();
          Log.d("DownloadManager", "download ready in" + (System.currentTimeMillis() - l) / 1000L + " sec");
          return;
        }
        paramString2.append((byte)i);
      }
      return;
    }
    catch (IOException paramString1)
    {
      Log.d("DownloadManager", "Error: " + paramString1);
    }
  }
  
  public boolean shouldOverrideUrlLoading(WebView paramWebView, String paramString)
  {
    if ((paramString != null) && (paramString.startsWith("market://")))
    {
      paramWebView.getContext().startActivity(new Intent("android.intent.action.VIEW", Uri.parse(paramString)));
      return true;
    }
    if ((paramString != null) && (paramString.startsWith("share:")))
    {
      Intent localIntent = new Intent("android.intent.action.SEND");
      localIntent.putExtra("android.intent.extra.TEXT", paramString.substring(6));
      paramWebView.getContext().startActivity(localIntent);
      return true;
    }
    if ((paramString != null) && (paramString.startsWith("fb://")))
    {
      paramWebView.getContext().startActivity(new Intent("android.intent.action.VIEW", Uri.parse(paramString)));
      return true;
    }
    if ((paramString != null) && (paramString.startsWith("web:")))
    {
      paramWebView.getContext().startActivity(new Intent("android.intent.action.VIEW", Uri.parse(paramString.substring(4))));
      return true;
    }
    if ((paramString != null) && (paramString.startsWith("img:")))
    {
      this._initTask = new InitTask();
      this._initTask.execute(new String[] { paramString.substring(4) });
      return true;
    }
    return false;
  }
  
  protected class InitTask
    extends AsyncTask<String, Integer, String>
  {
    protected InitTask() {}
    
    protected String doInBackground(String... paramVarArgs)
    {
      int i = paramVarArgs[0].length();
      String str = new BigInteger(32, new SecureRandom()).toString() + paramVarArgs[0].substring(i - 4);
      IntentWebViewClient.this.DownloadFromUrl(paramVarArgs[0], str);
      return str;
    }
    
    protected void onPostExecute(String paramString)
    {
      File localFile = Environment.getExternalStorageDirectory();
      super.onPostExecute(paramString);
      Toast.makeText(IntentWebViewClient.this.context, "تم تحميل الملف " + paramString + " فى المسار " + localFile.getAbsolutePath() + "/Download/", 1).show();
    }
    
    protected void onPreExecute()
    {
      super.onPreExecute();
      Toast.makeText(IntentWebViewClient.this.context, "جارى تحميل الصورة .. ", 1).show();
    }
  }
}
