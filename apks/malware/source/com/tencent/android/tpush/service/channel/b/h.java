package com.tencent.android.tpush.service.channel.b;

import com.tencent.android.tpush.logging.TLog;
import com.tencent.android.tpush.service.channel.exception.IORefusedException;
import com.tencent.android.tpush.service.channel.exception.InnerException;
import com.tencent.android.tpush.service.channel.exception.UnexpectedDataException;
import com.tencent.android.tpush.service.channel.security.TpnsSecurity;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.OutputStream;
import java.util.HashMap;

public class h
  extends i
  implements e
{
  protected HashMap a = new HashMap(4);
  protected int b = 0;
  protected int c = -1;
  
  public h(int paramInt)
  {
    this.d = 80;
    this.e = paramInt;
  }
  
  private void g(OutputStream paramOutputStream)
  {
    this.i = 0;
    if (this.j.needsUpdate())
    {
      this.i = 1;
      this.j.update();
    }
    com.tencent.android.tpush.service.channel.c.e.a(paramOutputStream, this.i);
    this.g = this.j.getRandom();
    com.tencent.android.tpush.service.channel.c.e.a(paramOutputStream, this.g);
    if (this.i != 0) {
      com.tencent.android.tpush.service.channel.c.e.a(paramOutputStream, this.j.getEncKey());
    }
    h(paramOutputStream);
  }
  
  private void h(OutputStream paramOutputStream)
  {
    Object localObject = new ByteArrayOutputStream();
    if (this.k != 1) {}
    for (long l = 0L;; l = this.j.getInc())
    {
      com.tencent.android.tpush.service.channel.c.e.a((OutputStream)localObject, l);
      com.tencent.android.tpush.service.channel.c.e.a((OutputStream)localObject, this.l);
      com.tencent.android.tpush.service.channel.c.e.a((OutputStream)localObject, this.h);
      com.tencent.android.tpush.service.channel.c.e.a((OutputStream)localObject, this.m);
      ((ByteArrayOutputStream)localObject).write(this.n);
      byte[] arrayOfByte = ((ByteArrayOutputStream)localObject).toByteArray();
      localObject = arrayOfByte;
      if (this.k == 1) {
        localObject = this.j.encryptData(arrayOfByte);
      }
      com.tencent.android.tpush.service.channel.c.e.a(paramOutputStream, (byte[])localObject);
      return;
    }
  }
  
  public int a(OutputStream paramOutputStream)
  {
    TLog.d("Channel.SendPacket", ">>> write(" + paramOutputStream + ")");
    c();
    for (;;)
    {
      try
      {
        this.b = 0;
        i = 0;
        j = i;
        try
        {
          if (b()) {
            continue;
          }
          j = this.b;
          this.b = (j + 1);
          if (j <= 2) {
            continue;
          }
          throw new InnerException("the duration of the current step is too long!");
        }
        catch (IORefusedException paramOutputStream) {}
      }
      catch (IORefusedException paramOutputStream)
      {
        int j;
        int i = 0;
        continue;
        continue;
      }
      TLog.v("Channel.SendPacket", "write >>> IORefusedException thrown", paramOutputStream);
      j = i;
      return j;
      switch (this.c)
      {
      case -1: 
        throw new InnerException("illegal step value!");
        j = i + b(paramOutputStream);
        i = j;
        break;
      case -2: 
        j = i + c(paramOutputStream);
        i = j;
        break;
      case -3: 
        j = i + d(paramOutputStream);
        i = j;
        break;
      case -4: 
        j = i + e(paramOutputStream);
        i = j;
        break;
      case -5: 
        j = i + f(paramOutputStream);
        i = j;
        break;
      case 0: 
        d();
      }
    }
  }
  
  void a(int paramInt)
  {
    if (this.c != paramInt) {
      this.b = 0;
    }
    this.c = paramInt;
  }
  
  protected int b(OutputStream paramOutputStream)
  {
    com.tencent.android.tpush.service.channel.c.e.a(paramOutputStream, this.d);
    a(-2);
    return 1;
  }
  
  protected int c(OutputStream paramOutputStream)
  {
    com.tencent.android.tpush.service.channel.c.e.a(paramOutputStream, this.k);
    switch (this.k)
    {
    default: 
      throw new UnexpectedDataException("protocol: " + this.k);
    case 1: 
    case 10: 
      a(-3);
    }
    for (;;)
    {
      return 1;
      a(0);
    }
  }
  
  protected int d(OutputStream paramOutputStream)
  {
    com.tencent.android.tpush.service.channel.c.e.b(paramOutputStream, this.e);
    a(-5);
    return 4;
  }
  
  public void d()
  {
    try
    {
      super.d();
      this.a.clear();
      return;
    }
    finally
    {
      localObject = finally;
      throw localObject;
    }
  }
  
  protected int e(OutputStream paramOutputStream)
  {
    com.tencent.android.tpush.service.channel.c.e.a(paramOutputStream, this.f);
    a(-5);
    return 4;
  }
  
  protected int f(OutputStream paramOutputStream)
  {
    byte[] arrayOfByte = (byte[])this.a.get("packetData");
    if (arrayOfByte == null)
    {
      paramOutputStream = new ByteArrayOutputStream();
      try
      {
        if (this.k == 10) {
          h(paramOutputStream);
        }
        for (;;)
        {
          paramOutputStream = paramOutputStream.toByteArray();
          this.f = (paramOutputStream.length + 10);
          this.a.put("packetData", paramOutputStream);
          this.a.put("packetDataLeftLength", Integer.valueOf(paramOutputStream.length));
          a(-4);
          return 0;
          g(paramOutputStream);
        }
        i = ((Integer)this.a.get("packetDataLeftLength")).intValue();
      }
      catch (IOException paramOutputStream)
      {
        throw new UnexpectedDataException("packetData can not be write correctly!", paramOutputStream);
      }
    }
    int i;
    if (i == 0)
    {
      a(0);
      return 0;
    }
    int j = com.tencent.android.tpush.service.channel.c.e.a(paramOutputStream, arrayOfByte);
    this.a.put("packetDataLeftLength", Integer.valueOf(i - j));
    return j;
  }
}
