package com.tencent.android.tpush.service;

import android.app.ActivityManager;
import android.app.ActivityManager.RunningServiceInfo;
import android.content.ComponentName;
import android.content.Context;
import android.content.Intent;
import android.net.LocalServerSocket;
import android.os.Handler;
import android.os.Looper;
import android.os.Message;
import android.os.Process;
import android.util.Log;
import com.tencent.android.tpush.XGPushManager;
import com.tencent.android.tpush.common.g;
import com.tencent.android.tpush.common.p;
import com.tencent.android.tpush.logging.TLog;
import com.tencent.android.tpush.service.a.b;
import com.tencent.android.tpush.service.a.c;
import com.tencent.android.tpush.service.cache.CacheManager;
import com.tencent.android.tpush.service.channel.security.TpnsSecurity;
import com.tencent.android.tpush.service.d.d;
import java.util.Iterator;
import java.util.List;

public class l
{
  private static Context a = null;
  private static String b = "";
  private static LocalServerSocket c = null;
  private static volatile boolean e = false;
  private static volatile boolean f = false;
  private Handler d = null;
  
  private l() {}
  
  public static l a()
  {
    return n.a;
  }
  
  public static void a(Context paramContext)
  {
    Intent localIntent;
    if (paramContext != null)
    {
      TLog.v("XGService", "@@ startService(" + paramContext.getPackageName() + ")");
      localIntent = new Intent();
      localIntent.setClass(paramContext, XGPushService.class);
      if ((TpnsSecurity.checkTpnsSecurityLibSo(paramContext)) && (XGPushManager.isEnableService(paramContext))) {
        paramContext.startService(localIntent);
      }
    }
    else
    {
      return;
    }
    Log.e("XGService", "startService failed, libtpnsSecurity.so not found.");
    paramContext.stopService(localIntent);
  }
  
  public static void b(Context paramContext)
  {
    if (paramContext != null)
    {
      TLog.v("XGService", "@@ setContext(" + paramContext.getPackageName() + ")");
      a = paramContext;
      b = paramContext.getPackageName();
    }
  }
  
  public static Context f()
  {
    return a;
  }
  
  public static String g()
  {
    return b;
  }
  
  private boolean j()
  {
    for (;;)
    {
      Object localObject2;
      try
      {
        TLog.v("XGService", "@@ isSurvive()");
        List localList = CacheManager.getRegisterInfos(f());
        if ((localList == null) || (localList.size() < 2))
        {
          TLog.tf("XGService", ">> Just one app with push sdk found in this device:" + a.getPackageName());
        }
        else
        {
          c localC1 = null;
          localList = null;
          c localC2 = b.a(a);
          Object localObject3 = ((ActivityManager)a.getSystemService("activity")).getRunningServices(Integer.MAX_VALUE);
          localObject2 = localC1;
          if (localObject3 != null)
          {
            localObject2 = localC1;
            if (((List)localObject3).size() > 0)
            {
              String str = XGPushService.class.getName();
              localObject3 = ((List)localObject3).iterator();
              localObject2 = localList;
              if (((Iterator)localObject3).hasNext())
              {
                localObject2 = (ActivityManager.RunningServiceInfo)((Iterator)localObject3).next();
                if (!str.equals(((ActivityManager.RunningServiceInfo)localObject2).service.getClassName())) {
                  continue;
                }
                localC1 = b.a(a, ((ActivityManager.RunningServiceInfo)localObject2).service.getPackageName());
                localObject2 = localC1;
                if (localList == null) {
                  break label261;
                }
                if (localC1.a <= localList.a) {
                  continue;
                }
                localObject2 = localC1;
                break label261;
              }
            }
          }
          if (localObject2 != null)
          {
            float f1 = ((c)localObject2).a;
            float f2 = localC2.a;
            if (f1 > f2) {
              return false;
            }
          }
        }
      }
      catch (Exception localException)
      {
        TLog.e("XGService", localException.getMessage());
        break label259;
        localObject2 = localException;
      }
      label259:
      return true;
      label261:
      Object localObject1 = localObject2;
    }
  }
  
  private boolean k()
  {
    TLog.v("XGService", "@@ tryToKeepServiceAlive(" + a.getPackageName() + ")");
    boolean bool2 = j();
    TLog.i("XGService", ">> isSurvive():" + bool2 + ", isGetRunningToken=" + e);
    bool1 = bool2;
    if (bool2) {}
    try
    {
      String str2 = d.e(a, "com.tencent.android.tpush.socket.name");
      String str1 = str2;
      if (d.a(str2))
      {
        str1 = d.a();
        d.a(a, "com.tencent.android.tpush.socket.name", str1);
      }
      p.e(a);
      TLog.tf("XGService", ">> socket=" + str1 + " @" + a.getPackageName());
      c = new LocalServerSocket(str1);
      e = Boolean.valueOf(true).booleanValue();
      TLog.tf("XGService", ">> Socket created, get token success to survive. @" + a.getPackageName());
      XGWatchdog.getInstance(a).startWatchdog();
      bool1 = bool2;
    }
    catch (Throwable localThrowable)
    {
      for (;;)
      {
        TLog.w("XGService", ">> Address in use already @" + a.getPackageName(), localThrowable);
        bool1 = e;
      }
    }
    finally {}
    return bool1;
  }
  
  private void l()
  {
    TLog.v("XGService", "@@ initHandler()");
    this.d = new m(this, Looper.getMainLooper());
  }
  
  public void b()
  {
    TLog.v("XGService", "@@ initApplication()");
    b.a(a, new c(2.37F, 0));
  }
  
  public void c()
  {
    long l2 = 1000L;
    TLog.v("XGService", "@@ serviceStartHandler()");
    if (this.d == null) {
      l();
    }
    for (;;)
    {
      try
      {
        if ((e) && (c != null))
        {
          TLog.i("XGService", ">> [service is running?]:true");
          return;
        }
        long l3 = 0L;
        Object localObject1 = CacheManager.getRegisterInfos(f());
        long l1 = l3;
        if (localObject1 != null)
        {
          l1 = l3;
          if (((List)localObject1).size() > 1)
          {
            l3 = (int)(Math.random() * 1000.0D) + 900;
            l1 = l3;
            if (l3 < 1000L)
            {
              l1 = l2;
              TLog.i("XGService", ">> delay millis:" + l1 + " @" + a.getPackageName());
              localObject1 = this.d.obtainMessage(1);
              this.d.sendMessageDelayed((Message)localObject1, l1);
              return;
            }
          }
        }
      }
      finally {}
    }
  }
  
  public void d()
  {
    TLog.tf("XGService", "@@ serviceExit()");
    if (this.d != null)
    {
      this.d.removeCallbacksAndMessages(null);
      this.d = null;
    }
    if (g.a().b() != null) {
      g.a().b().removeCallbacksAndMessages(null);
    }
    a.a().b(a);
    e();
    TLog.stop();
    Process.killProcess(Process.myPid());
  }
  
  /* Error */
  public void e()
  {
    // Byte code:
    //   0: ldc 46
    //   2: ldc_w 370
    //   5: invokestatic 72	com/tencent/android/tpush/logging/TLog:v	(Ljava/lang/String;Ljava/lang/String;)V
    //   8: aload_0
    //   9: monitorenter
    //   10: getstatic 25	com/tencent/android/tpush/service/l:c	Landroid/net/LocalServerSocket;
    //   13: astore_1
    //   14: aload_1
    //   15: ifnull +13 -> 28
    //   18: getstatic 25	com/tencent/android/tpush/service/l:c	Landroid/net/LocalServerSocket;
    //   21: invokevirtual 373	android/net/LocalServerSocket:close	()V
    //   24: aconst_null
    //   25: putstatic 25	com/tencent/android/tpush/service/l:c	Landroid/net/LocalServerSocket;
    //   28: iconst_0
    //   29: invokestatic 259	java/lang/Boolean:valueOf	(Z)Ljava/lang/Boolean;
    //   32: invokevirtual 262	java/lang/Boolean:booleanValue	()Z
    //   35: putstatic 27	com/tencent/android/tpush/service/l:e	Z
    //   38: aload_0
    //   39: monitorexit
    //   40: return
    //   41: astore_1
    //   42: ldc 46
    //   44: ldc_w 375
    //   47: aload_1
    //   48: invokestatic 377	com/tencent/android/tpush/logging/TLog:e	(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Throwable;)V
    //   51: goto -23 -> 28
    //   54: astore_1
    //   55: aload_0
    //   56: monitorexit
    //   57: aload_1
    //   58: athrow
    // Local variable table:
    //   start	length	slot	name	signature
    //   0	59	0	this	l
    //   13	2	1	localLocalServerSocket	LocalServerSocket
    //   41	7	1	localException	Exception
    //   54	4	1	localObject	Object
    // Exception table:
    //   from	to	target	type
    //   18	28	41	java/lang/Exception
    //   10	14	54	finally
    //   18	28	54	finally
    //   28	40	54	finally
    //   42	51	54	finally
    //   55	57	54	finally
  }
}
