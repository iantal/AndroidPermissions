package com.tencent.android.tpush.a;

import android.content.Context;
import android.content.Intent;
import com.tencent.android.tpush.XGIOperateCallback;
import com.tencent.android.tpush.XGPushConfig;
import com.tencent.android.tpush.XGPushManager;
import com.tencent.android.tpush.common.m;
import com.tencent.android.tpush.logging.TLog;
import com.tencent.android.tpush.service.d.d;
import java.util.List;
import org.json.JSONException;

class g
  implements Runnable
{
  private Context b;
  private Intent c;
  private XGIOperateCallback d;
  
  public g(f paramF, Context paramContext, Intent paramIntent, XGIOperateCallback paramXGIOperateCallback)
  {
    TLog.v("XGService", "create PushMessageRunnable, intent=" + paramIntent);
    this.b = paramContext;
    this.c = paramIntent;
    this.d = paramXGIOperateCallback;
  }
  
  private void a()
  {
    Object localObject = new Intent("com.tencent.android.tpush.action.PUSH_MESSAGE");
    ((Intent)localObject).setPackage(this.b.getPackageName());
    ((Intent)localObject).putExtras(this.c);
    TLog.v("XGService", "@@ processMsgIntent(" + localObject + "," + ((Intent)localObject).getExtras() + ")");
    this.b.sendBroadcast((Intent)localObject);
    localObject = this.c.getStringExtra("svrPkgName");
    if (!d.a((String)localObject))
    {
      Intent localIntent = new Intent("com.tencent.android.tpush.action.ack.sdk2srv");
      localIntent.setPackage((String)localObject);
      localIntent.putExtras(this.c);
      this.b.sendBroadcast(localIntent);
    }
  }
  
  public void run()
  {
    localObject4 = null;
    Object localObject3 = null;
    synchronized (this.a)
    {
      TLog.v("XGService", "@@PushMessageRunnable @ run()");
    }
    for (;;)
    {
      try
      {
        long l1 = this.c.getLongExtra("expire_time", 0L);
        long l2 = System.currentTimeMillis();
        localH = h.a(this.b, this.c);
        if ((l1 > 0L) && (l2 > l1))
        {
          TLog.e("XGService", "msg is expired, currentTimeMillis=" + l2 + ",expire_time=" + l1 + "." + this.c);
          XGPushManager.msgAck(this.b, localH);
          return;
        }
        l1 = this.c.getLongExtra("msgId", -1L);
        String str1 = this.c.getPackage();
        String str3 = "@" + l1 + str1 + "@";
        l2 = this.c.getLongExtra("accId", -1L);
        Object localObject5 = XGPushConfig.getAccessidList(this.b);
        if ((localObject5 != null) && (((List)localObject5).size() > 0) && (!((List)localObject5).contains(Long.valueOf(l2))))
        {
          str1 = "PushMessageRunnable match accessId failed, message droped cause accessId:" + l2 + " not in " + localObject5;
          TLog.tf("XGService", str1);
          TLog.e("TPush", str1);
          XGPushManager.msgAck(this.b, localH);
          return;
          str2 = finally;
          throw str2;
        }
        localObject5 = d.a(this.b, l2);
        TLog.tf("XGService", ">> msgId:" + l1 + ",is contains:" + ((String)localObject5).contains(str3));
        if (((String)localObject5).contains(str3)) {
          continue;
        }
        TLog.tf("XGService", ">> PushMessageRunnable@!msgIds.contains(msgIdstr)@msgId:" + l1 + "@pkgName:" + str2);
        m.b(this.b, "tpush_msgId_" + l2, str3 + (String)localObject5);
        d.a(this.b, "tpush_msgId_" + l2, str3 + (String)localObject5);
        if (!m.a(this.b, "tpush_msgId_" + l2, "").contains(str3))
        {
          TLog.tf("XGService", str3 + " flag write failed");
          return;
        }
        TLog.tf("TPush", "receiver msg:" + localH.toString());
        a();
        localObject1 = localObject4;
        if (localH.h() != null)
        {
          localObject1 = localObject4;
          if (localH.h().b() == 1)
          {
            boolean bool = d.a(localH.f());
            localObject1 = localObject4;
            if (bool) {}
          }
        }
      }
      catch (JSONException localJSONException)
      {
        h localH;
        Object localObject1;
        TLog.e("XGService", "push解包失败", localJSONException);
        continue;
        this.d = null;
        Object localObject2 = localObject4;
        continue;
      }
      catch (IllegalArgumentException localIllegalArgumentException)
      {
        TLog.e("XGService", "push消息类型错误", localIllegalArgumentException);
        continue;
      }
      catch (SecurityException localSecurityException)
      {
        TLog.e("XGService", "", localSecurityException);
        continue;
      }
      catch (Throwable localThrowable2)
      {
        TLog.e("XGService", "出现未知异常", localThrowable2);
        continue;
        this.d.onSuccess("", 0);
        continue;
      }
      try
      {
        localH.a();
        localObject1 = localObject3;
      }
      catch (Throwable localThrowable1)
      {
        TLog.e("XGService", "出现未知错误", localThrowable1);
      }
    }
    XGPushManager.msgAck(this.b, localH);
    if (this.d != null)
    {
      if (localObject1 != null) {
        this.d.onFail("", -1, localObject1.toString());
      }
    }
    else {
      return;
    }
  }
}
