package com.tencent.tmselfupdatesdk;

import android.os.Bundle;
import android.text.TextUtils;
import com.tencent.tmassistant.aidl.TMAssistantDownloadTaskInfo;
import com.tencent.tmassistantbase.util.TMLog;
import com.tencent.tmdownloader.TMAssistantDownloadClient;
import com.tencent.tmdownloader.TMAssistantDownloadConst;

class j
  implements Runnable
{
  j(TMSelfUpdateManager paramTMSelfUpdateManager) {}
  
  public void run()
  {
    int i;
    try
    {
      Object localObject1 = new Bundle();
      ((Bundle)localObject1).putString(TMAssistantDownloadConst.PARAM_TASK_PACKNAME, this.a.hostPackageName);
      ((Bundle)localObject1).putString(TMAssistantDownloadConst.PARAM_CHANNELID, this.a.mHostChannelId);
      ((Bundle)localObject1).putString(TMAssistantDownloadConst.PARAM_VIA, this.a.mScene);
      if (this.a.h == 4)
      {
        if (this.a.a(true) != null)
        {
          ((Bundle)localObject1).putByte(TMAssistantDownloadConst.PARAM_DOWNLOADTYPE, (byte)3);
          i = this.a.a(true).startDownloadTask(this.a.i, "application/tm.android.apkdiff", (Bundle)localObject1);
          TMLog.i("TMSelfUpdateManager", "apkPatch start download Result :" + i);
          if (4 != i) {
            return;
          }
          localObject1 = this.a.a(true).getDownloadTaskState(this.a.i);
          if (localObject1 == null) {
            return;
          }
          localObject1 = ((TMAssistantDownloadTaskInfo)localObject1).mSavePath;
          TMLog.i("TMSelfUpdateManager", "apkPatch has yet exists：url:" + this.a.i + ";  patchPath:" + (String)localObject1);
          TMSelfUpdateManager.a(this.a, (String)localObject1);
          return;
        }
        this.a.a(2, -18, "SelfUpdate failure, TMAssistantDownloadSDKClient_IS_NULL!");
        return;
      }
    }
    catch (Throwable localThrowable)
    {
      this.a.a(2, -20, "SelfUpdate failure, UNKNOWN EXCEPTION!");
      TMLog.e("TMSelfUpdateManager", "exception:", localThrowable);
      localThrowable.printStackTrace();
      return;
    }
    if (this.a.h == 2)
    {
      if (this.a.a(true) != null)
      {
        localThrowable.putByte(TMAssistantDownloadConst.PARAM_DOWNLOADTYPE, (byte)1);
        i = this.a.a(true).startDownloadTask(this.a.i, "application/vnd.android.package-archive", localThrowable);
        TMLog.i("TMSelfUpdateManager", "newapk start download Result :" + i);
        if (4 == i)
        {
          Object localObject2 = this.a.a(true).getDownloadTaskState(this.a.i);
          if (localObject2 != null)
          {
            localObject2 = ((TMAssistantDownloadTaskInfo)localObject2).mSavePath;
            TMLog.i("TMSelfUpdateManager", "newapk has yet exists：url:" + this.a.i + "; apkPath:" + (String)localObject2);
            if (!TextUtils.isEmpty((CharSequence)localObject2))
            {
              TMLog.i("TMSelfUpdateManager", "genNewPkgProcess overwriteChannelid = " + this.a.overwriteChannelid);
              this.a.writeChannelIdAfterUpdate((String)localObject2);
              TMSelfUpdateManager.a(this.a, (String)localObject2, this.a.hostPackageName, this.a.updateType);
              this.a.a(0, 0, "SelfUpdate success !");
              return;
            }
            this.a.a(2, -19, "SelfUpdate failure, SelfUpdateSDKErrorCode_getSavePath_IS_NULL!");
            return;
          }
          this.a.a(2, -19, "SelfUpdate failure, SelfUpdateSDKErrorCode_GetDownloadTaskState_IS_NULL!");
        }
      }
      else
      {
        this.a.a(2, -18, "SelfUpdate failure, TMAssistantDownloadSDKClient_IS_NULL!");
      }
    }
    else
    {
      if (this.a.h == 1)
      {
        this.a.a(0, -15, "SelfUpdate success, NO Update!");
        return;
      }
      this.a.a(2, -20, "SelfUpdate failure, UNKNOWN EXCEPTION!");
    }
  }
}
