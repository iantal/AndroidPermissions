package com.tencent.open;

import android.app.Activity;
import android.content.Context;
import android.location.Location;
import android.net.ConnectivityManager;
import android.net.NetworkInfo;
import android.os.Bundle;
import android.os.Handler;
import android.os.HandlerThread;
import android.os.Looper;
import android.os.Message;
import android.os.SystemClock;
import com.tencent.connect.a.a;
import com.tencent.connect.auth.QQAuth;
import com.tencent.connect.auth.QQToken;
import com.tencent.connect.common.BaseApi;
import com.tencent.open.a.f;
import com.tencent.open.utils.Global;
import com.tencent.open.utils.HttpUtils;
import com.tencent.open.utils.HttpUtils.HttpStatusException;
import com.tencent.open.utils.HttpUtils.NetworkUnavailableException;
import com.tencent.open.utils.Util;
import com.tencent.tauth.IRequestListener;
import com.tencent.tauth.IUiListener;
import com.tencent.tauth.UiError;
import java.io.IOException;
import java.net.MalformedURLException;
import java.net.SocketTimeoutException;
import org.apache.http.conn.ConnectTimeoutException;
import org.json.JSONException;
import org.json.JSONObject;

public class LocationApi
  extends BaseApi
  implements c.a
{
  private HandlerThread a;
  private Handler b;
  private Handler c;
  private c d;
  private Bundle e;
  private IUiListener f;
  
  public LocationApi(QQAuth paramQQAuth, QQToken paramQQToken)
  {
    super(paramQQAuth, paramQQToken);
    a();
  }
  
  public LocationApi(QQToken paramQQToken)
  {
    super(paramQQToken);
    a();
  }
  
  private void a()
  {
    this.d = new c();
    this.a = new HandlerThread("get_location");
    this.a.start();
    this.b = new Handler(this.a.getLooper());
    this.c = new Handler(Global.getContext().getMainLooper())
    {
      public void handleMessage(Message paramAnonymousMessage)
      {
        switch (paramAnonymousMessage.what)
        {
        }
        for (;;)
        {
          super.handleMessage(paramAnonymousMessage);
          return;
          f.b("openSDK_LOG", "location: verify sosocode success.");
          LocationApi.a(LocationApi.this).a(Global.getContext(), LocationApi.this);
          LocationApi.b(LocationApi.this).sendEmptyMessageDelayed(101, 10000L);
          continue;
          f.b("openSDK_LOG", "location: verify sosocode failed.");
          LocationApi.a(LocationApi.this, -14, "定位失败，验证定位码错误！");
          continue;
          f.b("openSDK_LOG", "location: get location timeout.");
          LocationApi.a(LocationApi.this, -13, "定位超时，请稍后再试或检查网络状况！");
        }
      }
    };
  }
  
  private void a(int paramInt, String paramString)
  {
    this.d.b();
    if (this.f == null) {
      return;
    }
    JSONObject localJSONObject = new JSONObject();
    try
    {
      localJSONObject.put("ret", paramInt);
      localJSONObject.put("errMsg", paramString);
      this.f.onComplete(localJSONObject);
      return;
    }
    catch (JSONException paramString)
    {
      for (;;)
      {
        paramString.printStackTrace();
      }
    }
  }
  
  private void a(Location paramLocation)
  {
    f.b("openSDK_LOG", "location: search mParams: " + this.e);
    Bundle localBundle;
    if (this.e != null)
    {
      localBundle = new Bundle(this.e);
      localBundle.putAll(composeCGIParams());
    }
    for (;;)
    {
      double d1 = paramLocation.getLatitude();
      double d2 = paramLocation.getLongitude();
      localBundle.putString("appid", this.mToken.getAppId());
      if (!localBundle.containsKey("latitude")) {
        localBundle.putString("latitude", String.valueOf(d1));
      }
      if (!localBundle.containsKey("longitude")) {
        localBundle.putString("longitude", String.valueOf(d2));
      }
      if (!localBundle.containsKey("page")) {
        localBundle.putString("page", String.valueOf(1));
      }
      localBundle.putString("encrytoken", Util.encrypt("tencent&sdk&qazxc***14969%%" + this.mToken.getAccessToken() + this.mToken.getAppId() + this.mToken.getOpenId() + "qzone3.4"));
      f.b("openSDK_LOG", "location: search params: " + localBundle);
      f.b("SDKQQAgentPref", "GetNearbySwitchStart:" + SystemClock.elapsedRealtime());
      paramLocation = new b(this.f);
      HttpUtils.requestAsync(this.mToken, Global.getContext(), "http://fusion.qq.com/cgi-bin/qzapps/mapp_lbs_getnear.cgi", localBundle, "GET", paramLocation);
      return;
      localBundle = composeCGIParams();
    }
  }
  
  private void a(final String paramString, final String... paramVarArgs)
  {
    this.b.post(new Runnable()
    {
      public void run()
      {
        if ((paramVarArgs == null) || (paramVarArgs.length == 0)) {
          return;
        }
        if ("search_nearby".equals(paramString)) {}
        for (String str = "id_search_nearby";; str = "id_delete_location")
        {
          a.a(Global.getContext(), LocationApi.c(LocationApi.this), str, paramVarArgs);
          return;
        }
      }
    });
  }
  
  private void b()
  {
    this.d.b();
  }
  
  private boolean c()
  {
    Object localObject = (ConnectivityManager)Global.getContext().getSystemService("connectivity");
    if (localObject != null)
    {
      localObject = ((ConnectivityManager)localObject).getActiveNetworkInfo();
      return (localObject != null) && (((NetworkInfo)localObject).isAvailable());
    }
    return false;
  }
  
  private JSONObject d()
  {
    JSONObject localJSONObject = new JSONObject();
    try
    {
      localJSONObject.put("ret", -9);
      localJSONObject.put("errMsg", "网络连接异常，请检查后重试!");
      return localJSONObject;
    }
    catch (JSONException localJSONException)
    {
      localJSONException.printStackTrace();
    }
    return localJSONObject;
  }
  
  public void deleteLocation(Activity paramActivity, Bundle paramBundle, IUiListener paramIUiListener)
  {
    if (!c())
    {
      if (paramIUiListener != null) {
        paramIUiListener.onComplete(d());
      }
      return;
    }
    if (paramBundle != null)
    {
      paramActivity = new Bundle(paramBundle);
      paramActivity.putAll(composeCGIParams());
    }
    for (;;)
    {
      paramActivity.putString("appid", this.mToken.getAppId());
      paramActivity.putString("timestamp", String.valueOf(System.currentTimeMillis()));
      paramActivity.putString("encrytoken", Util.encrypt("tencent&sdk&qazxc***14969%%" + this.mToken.getAccessToken() + this.mToken.getAppId() + this.mToken.getOpenId() + "qzone3.4"));
      f.b("openSDK_LOG", "location: delete params: " + paramActivity);
      paramBundle = new b(paramIUiListener);
      HttpUtils.requestAsync(this.mToken, Global.getContext(), "http://fusion.qq.com/cgi-bin/qzapps/mapp_lbs_delete.cgi", paramActivity, "GET", paramBundle);
      a("delete_location", new String[] { "success" });
      return;
      paramActivity = composeCGIParams();
    }
  }
  
  public void onLocationUpdate(Location paramLocation)
  {
    a(paramLocation);
    b();
    this.c.removeMessages(101);
  }
  
  public void searchNearby(Activity paramActivity, Bundle paramBundle, IUiListener paramIUiListener)
  {
    if (!c())
    {
      if (paramIUiListener != null) {
        paramIUiListener.onComplete(d());
      }
      return;
    }
    this.e = paramBundle;
    this.f = paramIUiListener;
    this.b.post(new Runnable()
    {
      public void run()
      {
        if (LocationApi.a(LocationApi.this).a())
        {
          Message.obtain(LocationApi.b(LocationApi.this), 103).sendToTarget();
          return;
        }
        Message.obtain(LocationApi.b(LocationApi.this), 104).sendToTarget();
      }
    });
  }
  
  private abstract class a
    implements IRequestListener
  {
    private a() {}
    
    protected abstract void a(Exception paramException);
    
    public void onConnectTimeoutException(ConnectTimeoutException paramConnectTimeoutException)
    {
      a(paramConnectTimeoutException);
    }
    
    public void onHttpStatusException(HttpUtils.HttpStatusException paramHttpStatusException)
    {
      a(paramHttpStatusException);
    }
    
    public void onIOException(IOException paramIOException)
    {
      a(paramIOException);
    }
    
    public void onJSONException(JSONException paramJSONException)
    {
      a(paramJSONException);
    }
    
    public void onMalformedURLException(MalformedURLException paramMalformedURLException)
    {
      a(paramMalformedURLException);
    }
    
    public void onNetworkUnavailableException(HttpUtils.NetworkUnavailableException paramNetworkUnavailableException)
    {
      a(paramNetworkUnavailableException);
    }
    
    public void onSocketTimeoutException(SocketTimeoutException paramSocketTimeoutException)
    {
      a(paramSocketTimeoutException);
    }
    
    public void onUnknowException(Exception paramException)
    {
      a(paramException);
    }
  }
  
  private class b
    extends LocationApi.a
  {
    private IUiListener c;
    
    public b(IUiListener paramIUiListener)
    {
      super(null);
      this.c = paramIUiListener;
    }
    
    protected void a(Exception paramException)
    {
      if (this.c != null) {
        this.c.onError(new UiError(100, paramException.getMessage(), null));
      }
    }
    
    public void onComplete(JSONObject paramJSONObject)
    {
      if (this.c != null) {
        this.c.onComplete(paramJSONObject);
      }
      f.b("SDKQQAgentPref", "GetNearbySwitchEnd:" + SystemClock.elapsedRealtime());
    }
  }
}
