package com.tencent.stat;

import android.content.Context;
import com.tencent.stat.common.StatLogger;
import com.tencent.stat.common.k;
import com.tencent.stat.common.p;
import java.io.BufferedReader;
import java.io.File;
import java.io.FileReader;
import java.io.IOException;
import java.util.LinkedHashSet;

public class StatNativeCrashReport
{
  public static final String PRE_TAG_TOMBSTONE_FNAME = "tombstone_";
  static StatNativeCrashReport a;
  private static StatLogger b = ;
  private static boolean d;
  private static boolean e;
  private static String f;
  private static boolean g;
  private volatile boolean c = false;
  
  static
  {
    a = new StatNativeCrashReport();
    d = false;
    e = false;
    f = null;
    g = false;
    try
    {
      System.loadLibrary("MtaNativeCrash");
      g = true;
      return;
    }
    catch (Throwable localThrowable)
    {
      d = false;
      b.w("can't find libMtaNativeCrash.so, NativeCrash report disable.");
    }
  }
  
  public StatNativeCrashReport() {}
  
  static String a(File paramFile)
  {
    StringBuilder localStringBuilder = new StringBuilder();
    try
    {
      paramFile = new BufferedReader(new FileReader(paramFile));
      for (;;)
      {
        String str = paramFile.readLine();
        if (str == null) {
          break;
        }
        localStringBuilder.append(str);
        localStringBuilder.append('\n');
      }
      return localStringBuilder.toString();
    }
    catch (IOException paramFile)
    {
      b.e(paramFile);
    }
    for (;;)
    {
      paramFile.close();
    }
  }
  
  static LinkedHashSet<File> a(Context paramContext)
  {
    LinkedHashSet localLinkedHashSet = new LinkedHashSet();
    paramContext = getTombstonesDir(paramContext);
    if (paramContext != null)
    {
      paramContext = new File(paramContext);
      if ((paramContext != null) && (paramContext.isDirectory()))
      {
        paramContext = paramContext.listFiles();
        if (paramContext != null)
        {
          int j = paramContext.length;
          int i = 0;
          while (i < j)
          {
            Object localObject = paramContext[i];
            if ((localObject.getName().startsWith("tombstone_")) && (localObject.isFile()))
            {
              if (StatConfig.isDebugEnable()) {
                b.d("get tombstone file:" + localObject.getAbsolutePath().toString());
              }
              localLinkedHashSet.add(localObject.getAbsoluteFile());
            }
            i += 1;
          }
        }
      }
    }
    return localLinkedHashSet;
  }
  
  static long b(File paramFile)
  {
    paramFile = paramFile.getName().replace("tombstone_", "");
    try
    {
      long l = Long.valueOf(paramFile).longValue();
      return l;
    }
    catch (NumberFormatException paramFile)
    {
      b.e(paramFile);
    }
    return 0L;
  }
  
  public static void doNativeCrashTest()
  {
    if (!g)
    {
      b.warn("libMtaNativeCrash.so not loaded.");
      return;
    }
    a.makeJniCrash();
  }
  
  public static String getTombstonesDir(Context paramContext)
  {
    if (f == null) {
      f = p.a(paramContext, "__mta_tombstone__", "");
    }
    return f;
  }
  
  public static void initNativeCrash(Context paramContext, String paramString)
  {
    if (!g) {
      b.warn("libMtaNativeCrash.so not loaded.");
    }
    do
    {
      do
      {
        return;
      } while (a.c);
      String str = paramString;
      if (paramString == null) {}
      try
      {
        str = paramContext.getDir("tombstones", 0).getAbsolutePath();
        if (str.length() > 128)
        {
          b.e("The length of tombstones dir: " + str + " can't exceeds 200 bytes.");
          return;
        }
      }
      catch (Throwable paramContext)
      {
        b.w(paramContext);
        return;
      }
      f = str;
      p.b(paramContext, "__mta_tombstone__", str);
      setNativeCrashEnable(true);
      a.initJNICrash(str);
      a.c = true;
    } while (!StatConfig.isDebugEnable());
    b.d("initNativeCrash success.");
  }
  
  public static boolean isNativeCrashDebugEnable()
  {
    return e;
  }
  
  public static boolean isNativeCrashEnable()
  {
    return d;
  }
  
  public static String onNativeCrashHappened()
  {
    try
    {
      new RuntimeException("MTA has caught a native crash, java stack:\n").printStackTrace();
      return "";
    }
    catch (RuntimeException localRuntimeException)
    {
      return localRuntimeException.toString();
    }
  }
  
  public static void setNativeCrashDebugEnable(boolean paramBoolean)
  {
    if (!g)
    {
      b.warn("libMtaNativeCrash.so not loaded.");
      return;
    }
    try
    {
      a.enableNativeCrashDebug(paramBoolean);
      e = paramBoolean;
      return;
    }
    catch (Throwable localThrowable)
    {
      b.w(localThrowable);
    }
  }
  
  public static void setNativeCrashEnable(boolean paramBoolean)
  {
    if (!g)
    {
      b.warn("libMtaNativeCrash.so not loaded.");
      return;
    }
    try
    {
      a.enableNativeCrash(paramBoolean);
      d = paramBoolean;
      return;
    }
    catch (Throwable localThrowable)
    {
      b.w(localThrowable);
    }
  }
  
  public native void enableNativeCrash(boolean paramBoolean);
  
  public native void enableNativeCrashDebug(boolean paramBoolean);
  
  public native boolean initJNICrash(String paramString);
  
  public native String makeJniCrash();
  
  public native String stringFromJNI();
}
