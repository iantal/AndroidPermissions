package com.unity3d.ads.android.data;

import android.app.Activity;
import android.content.ComponentName;
import android.content.Context;
import android.content.Intent;
import android.content.ServiceConnection;
import android.os.Binder;
import android.os.IBinder;
import android.os.IInterface;
import android.os.Parcel;
import android.os.RemoteException;
import com.unity3d.ads.android.UnityAdsDeviceLog;
import java.lang.reflect.Method;
import java.util.concurrent.BlockingQueue;
import java.util.concurrent.LinkedBlockingQueue;

public class UnityAdsAdvertisingId
{
  private static UnityAdsAdvertisingId a = null;
  private String b = null;
  private boolean c = false;
  
  public UnityAdsAdvertisingId() {}
  
  private static UnityAdsAdvertisingId a()
  {
    if (a == null) {
      a = new UnityAdsAdvertisingId();
    }
    return a;
  }
  
  public static String getAdvertisingTrackingId()
  {
    return a().b;
  }
  
  public static boolean getLimitedAdTracking()
  {
    return a().c;
  }
  
  public static void init(Activity paramActivity)
  {
    UnityAdsAdvertisingId localUnityAdsAdvertisingId;
    c localC;
    Object localObject2;
    if (!a().fetchAdvertisingId(paramActivity))
    {
      localUnityAdsAdvertisingId = a();
      paramActivity = paramActivity.getApplicationContext();
      localC = new c(localUnityAdsAdvertisingId, (byte)0);
      localObject2 = new Intent("com.google.android.gms.ads.identifier.service.START");
      ((Intent)localObject2).setPackage("com.google.android.gms");
      if (!paramActivity.bindService((Intent)localObject2, localC, 1)) {}
    }
    try
    {
      localObject2 = UnityAdsAdvertisingId.GoogleAdvertisingInfo.GoogleAdvertisingInfoBinder.Create(localC.getBinder());
      localUnityAdsAdvertisingId.b = ((a)localObject2).getId();
      localUnityAdsAdvertisingId.c = ((a)localObject2).getEnabled(true);
      paramActivity.unbindService(localC);
      return;
    }
    catch (Exception localException)
    {
      localException = localException;
      paramActivity.unbindService(localC);
      return;
    }
    finally
    {
      localObject1 = finally;
      paramActivity.unbindService(localC);
      throw localObject1;
    }
  }
  
  public boolean fetchAdvertisingId(Activity paramActivity)
  {
    try
    {
      if (Class.forName("com.google.android.gms.common.GooglePlayServicesUtil").getMethod("isGooglePlayServicesAvailable", new Class[] { Context.class }).invoke(null, new Object[] { paramActivity }).equals(Integer.valueOf(0)))
      {
        paramActivity = Class.forName("com.google.android.gms.ads.identifier.AdvertisingIdClient").getMethod("getAdvertisingIdInfo", new Class[] { Context.class }).invoke(null, new Object[] { paramActivity });
        Class localClass = Class.forName("com.google.android.gms.ads.identifier.AdvertisingIdClient$Info");
        this.b = ((String)localClass.getMethod("getId", new Class[0]).invoke(paramActivity, new Object[0]));
        this.c = ((Boolean)localClass.getMethod("isLimitAdTrackingEnabled", new Class[0]).invoke(paramActivity, new Object[0])).booleanValue();
        return true;
      }
      UnityAdsDeviceLog.debug("Google Play Services not integrated, using fallback");
      return false;
    }
    catch (Exception paramActivity)
    {
      UnityAdsDeviceLog.debug("Exception while trying to access Google Play Services " + paramActivity);
    }
    return false;
  }
  
  private static abstract interface GoogleAdvertisingInfo
    extends IInterface
  {
    public abstract boolean getEnabled(boolean paramBoolean)
      throws RemoteException;
    
    public abstract String getId()
      throws RemoteException;
    
    public abstract class GoogleAdvertisingInfoBinder
      extends Binder
      implements a
    {
      public GoogleAdvertisingInfoBinder() {}
      
      public static a Create(IBinder paramIBinder)
      {
        if (paramIBinder == null) {
          return null;
        }
        IInterface localIInterface = paramIBinder.queryLocalInterface("com.google.android.gms.ads.identifier.internal.IAdvertisingIdService");
        if ((localIInterface != null) && ((localIInterface instanceof a))) {
          return (a)localIInterface;
        }
        return new b(paramIBinder);
      }
      
      public boolean onTransact(int paramInt1, Parcel paramParcel1, Parcel paramParcel2, int paramInt2)
      {
        int i = 0;
        switch (paramInt1)
        {
        default: 
          return super.onTransact(paramInt1, paramParcel1, paramParcel2, paramInt2);
        case 1: 
          paramParcel1.enforceInterface("com.google.android.gms.ads.identifier.internal.IAdvertisingIdService");
          paramParcel1 = getId();
          paramParcel2.writeNoException();
          paramParcel2.writeString(paramParcel1);
          return true;
        }
        paramParcel1.enforceInterface("com.google.android.gms.ads.identifier.internal.IAdvertisingIdService");
        if (paramParcel1.readInt() != 0) {}
        for (boolean bool = true;; bool = false)
        {
          bool = getEnabled(bool);
          paramParcel2.writeNoException();
          paramInt1 = i;
          if (bool) {
            paramInt1 = 1;
          }
          paramParcel2.writeInt(paramInt1);
          return true;
        }
      }
      
      private static class GoogleAdvertisingInfoImplementation
        implements UnityAdsAdvertisingId.GoogleAdvertisingInfo
      {
        private final IBinder _binder;
        
        GoogleAdvertisingInfoImplementation(IBinder paramIBinder)
        {
          this._binder = paramIBinder;
        }
        
        public IBinder asBinder()
        {
          return this._binder;
        }
        
        /* Error */
        public boolean getEnabled(boolean paramBoolean)
          throws RemoteException
        {
          // Byte code:
          //   0: iconst_1
          //   1: istore_3
          //   2: invokestatic 34	android/os/Parcel:obtain	()Landroid/os/Parcel;
          //   5: astore 4
          //   7: invokestatic 34	android/os/Parcel:obtain	()Landroid/os/Parcel;
          //   10: astore 5
          //   12: aload 4
          //   14: ldc 36
          //   16: invokevirtual 40	android/os/Parcel:writeInterfaceToken	(Ljava/lang/String;)V
          //   19: iload_1
          //   20: ifeq +56 -> 76
          //   23: iconst_1
          //   24: istore_2
          //   25: aload 4
          //   27: iload_2
          //   28: invokevirtual 44	android/os/Parcel:writeInt	(I)V
          //   31: aload_0
          //   32: getfield 21	com/unity3d/ads/android/data/UnityAdsAdvertisingId$GoogleAdvertisingInfo$GoogleAdvertisingInfoBinder$GoogleAdvertisingInfoImplementation:_binder	Landroid/os/IBinder;
          //   35: iconst_2
          //   36: aload 4
          //   38: aload 5
          //   40: iconst_0
          //   41: invokeinterface 50 5 0
          //   46: pop
          //   47: aload 5
          //   49: invokevirtual 53	android/os/Parcel:readException	()V
          //   52: aload 5
          //   54: invokevirtual 57	android/os/Parcel:readInt	()I
          //   57: istore_2
          //   58: iload_2
          //   59: ifeq +22 -> 81
          //   62: iload_3
          //   63: istore_1
          //   64: aload 5
          //   66: invokevirtual 60	android/os/Parcel:recycle	()V
          //   69: aload 4
          //   71: invokevirtual 60	android/os/Parcel:recycle	()V
          //   74: iload_1
          //   75: ireturn
          //   76: iconst_0
          //   77: istore_2
          //   78: goto -53 -> 25
          //   81: iconst_0
          //   82: istore_1
          //   83: goto -19 -> 64
          //   86: astore 6
          //   88: aload 5
          //   90: invokevirtual 60	android/os/Parcel:recycle	()V
          //   93: aload 4
          //   95: invokevirtual 60	android/os/Parcel:recycle	()V
          //   98: aload 6
          //   100: athrow
          // Local variable table:
          //   start	length	slot	name	signature
          //   0	101	0	this	GoogleAdvertisingInfoImplementation
          //   0	101	1	paramBoolean	boolean
          //   24	54	2	i	int
          //   1	62	3	bool	boolean
          //   5	89	4	localParcel1	Parcel
          //   10	79	5	localParcel2	Parcel
          //   86	13	6	localObject	Object
          // Exception table:
          //   from	to	target	type
          //   12	19	86	finally
          //   25	58	86	finally
        }
        
        public String getId()
          throws RemoteException
        {
          Parcel localParcel1 = Parcel.obtain();
          Parcel localParcel2 = Parcel.obtain();
          try
          {
            localParcel1.writeInterfaceToken("com.google.android.gms.ads.identifier.internal.IAdvertisingIdService");
            this._binder.transact(1, localParcel1, localParcel2, 0);
            localParcel2.readException();
            String str = localParcel2.readString();
            return str;
          }
          finally
          {
            localParcel2.recycle();
            localParcel1.recycle();
          }
        }
      }
    }
  }
  
  private class GoogleAdvertisingServiceConnection
    implements ServiceConnection
  {
    private final BlockingQueue<IBinder> _binderQueue = new LinkedBlockingQueue();
    boolean _consumed = false;
    
    private GoogleAdvertisingServiceConnection() {}
    
    public IBinder getBinder()
      throws InterruptedException
    {
      if (this._consumed) {
        throw new IllegalStateException();
      }
      this._consumed = true;
      return (IBinder)this._binderQueue.take();
    }
    
    public void onServiceConnected(ComponentName paramComponentName, IBinder paramIBinder)
    {
      try
      {
        this._binderQueue.put(paramIBinder);
        return;
      }
      catch (InterruptedException paramComponentName)
      {
        UnityAdsDeviceLog.debug("Couldn't put service to binder que");
      }
    }
    
    public void onServiceDisconnected(ComponentName paramComponentName) {}
  }
}
