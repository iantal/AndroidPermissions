package com.w545taxxxg9.pull;

import android.app.AlarmManager;
import android.app.PendingIntent;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.content.SharedPreferences.Editor;
import com.w545taxxxg9.Utils.AppNotificationManager;

public class PullServerController
  extends BroadcastReceiver
  implements PullServerClient.onMessageReceivedListener
{
  private final long ALARM_PERIOD = 14400000L;
  private final String LAST_ALARM_TIME_KEY = "last_alarm_time";
  private Context _context = null;
  
  public PullServerController() {}
  
  private long _getLastAlarmTime(Context paramContext)
  {
    return paramContext.getSharedPreferences("AppsgeyserPrefs", 0).getLong("last_alarm_time", 0L);
  }
  
  private void _pullMessage(Context paramContext)
  {
    new PullServerClient(paramContext, this).tryLoadMessageAsync();
  }
  
  private void _setLastAlarmTime(Context paramContext, long paramLong)
  {
    paramContext.getSharedPreferences("AppsgeyserPrefs", 0).edit().putLong("last_alarm_time", paramLong).commit();
  }
  
  public void onMessage(PullServerClient.Response[] paramArrayOfResponse)
  {
    int j = paramArrayOfResponse.length;
    int i = 0;
    while (i < j)
    {
      Object localObject = paramArrayOfResponse[i];
      String str1 = ((PullServerClient.Response)localObject).url;
      String str2 = ((PullServerClient.Response)localObject).message;
      localObject = ((PullServerClient.Response)localObject).title;
      Intent localIntent = AppNotificationManager.getLaunchIntent(this._context, (String)localObject, str1);
      AppNotificationManager.generateNotification(this._context, str2, (String)localObject, localIntent);
      new StatServerClient(this._context).sendMessageAcceptedAsync(str1);
      i += 1;
    }
  }
  
  public void onReceive(Context paramContext, Intent paramIntent)
  {
    this._context = paramContext;
    long l1 = _getLastAlarmTime(paramContext);
    long l2 = System.currentTimeMillis();
    if (l2 - l1 >= 14400000L)
    {
      _setLastAlarmTime(paramContext, l2);
      if (l1 != 0L) {
        _pullMessage(paramContext);
      }
    }
    reScheduleNotification(paramContext);
  }
  
  public void reScheduleNotification(Context paramContext)
  {
    this._context = paramContext;
    long l2 = _getLastAlarmTime(paramContext);
    long l1 = l2;
    if (l2 < System.currentTimeMillis() - 14400000L) {
      l1 = System.currentTimeMillis();
    }
    Object localObject = new Intent(paramContext, PullServerController.class);
    PendingIntent localPendingIntent1 = PendingIntent.getBroadcast(paramContext, 0, (Intent)localObject, 268435456);
    PendingIntent localPendingIntent2 = PendingIntent.getBroadcast(paramContext, 1, (Intent)localObject, 268435456);
    localObject = PendingIntent.getBroadcast(paramContext, 2, (Intent)localObject, 268435456);
    paramContext = (AlarmManager)paramContext.getSystemService("alarm");
    paramContext.cancel(localPendingIntent1);
    paramContext.cancel(localPendingIntent2);
    paramContext.cancel((PendingIntent)localObject);
    paramContext.set(0, l1 + 14400000L, localPendingIntent1);
    paramContext.set(0, 28800000L + l1, localPendingIntent2);
    paramContext.set(0, 172800000L + l1, (PendingIntent)localObject);
  }
}
