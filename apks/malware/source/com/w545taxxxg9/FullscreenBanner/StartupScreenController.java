package com.w545taxxxg9.FullscreenBanner;

import android.app.Activity;
import android.app.ProgressDialog;
import android.content.Context;
import android.content.Intent;
import android.graphics.Bitmap;
import android.net.Uri;
import android.os.Handler;
import android.view.ViewGroup;
import android.webkit.GeolocationPermissions.Callback;
import android.webkit.WebChromeClient;
import android.webkit.WebSettings;
import android.webkit.WebView;
import com.w545taxxxg9.MainNavigationActivity;
import com.w545taxxxg9.Server.AppsGeyserServerClient;
import com.w545taxxxg9.Utils.SimpleWebViewClient;
import com.w545taxxxg9.Views.BrowserWebView;
import java.io.File;

public class StartupScreenController
{
  private static final long LOADING_TIMEOUT = 5000L;
  private static final long STAY_CALL_TIMEOUT = 200L;
  private String _bannerUrl = "";
  private BrowserWebView _browser;
  private String _clickHandlerUrl = "";
  private Runnable _closeRunnable = new Runnable()
  {
    public void run()
    {
      if (!StartupScreenController.this._keepAliveCalled) {
        StartupScreenController.this.closeBanner();
      }
    }
  };
  private Handler _handler = new Handler();
  private boolean _keepAliveCalled = false;
  private MainNavigationActivity _mainActivity;
  private ProgressDialog _progressDialog;
  private ViewGroup _startupScreenViewContainer;
  
  public StartupScreenController(ViewGroup paramViewGroup, MainNavigationActivity paramMainNavigationActivity)
  {
    if (paramViewGroup != null)
    {
      this._mainActivity = paramMainNavigationActivity;
      this._startupScreenViewContainer = paramViewGroup;
      this._browser = ((BrowserWebView)this._startupScreenViewContainer.findViewById(2131427349));
      this._browser.setWebViewClient(new FullScreenBannerWebViewClient(this._mainActivity));
      _setupWebView();
      this._browser.addJavascriptInterface(new FullscreenBannerJsInterface(this), FullscreenBannerJsInterface.JS_INTERFACE_NAME);
      this._bannerUrl = AppsGeyserServerClient.getInstance(this._mainActivity).GetFullScreenBannerUrl();
      this._progressDialog = new ProgressDialog(this._mainActivity);
      this._progressDialog.setMessage(this._mainActivity.getText(2131230748));
      this._progressDialog.setCancelable(false);
    }
  }
  
  private void _setupWebView()
  {
    this._browser.setWebViewClient(new FullScreenBannerWebViewClient(this._mainActivity));
    this._browser.setWebChromeClient(new WebChromeClient()
    {
      public void onGeolocationPermissionsShowPrompt(String paramAnonymousString, GeolocationPermissions.Callback paramAnonymousCallback)
      {
        paramAnonymousCallback.invoke(paramAnonymousString, true, false);
      }
    });
    this._browser.setScrollBarStyle(33554432);
    Object localObject = this._mainActivity.getApplicationContext();
    String str1 = ((Context)localObject).getDir("appcache", 0).getPath();
    String str2 = ((Context)localObject).getDir("databases", 0).getPath();
    localObject = ((Context)localObject).getDir("geolocation", 0).getPath();
    WebSettings localWebSettings = this._browser.getSettings();
    localWebSettings.setAppCachePath(str1);
    localWebSettings.setDatabasePath(str2);
    localWebSettings.setGeolocationDatabasePath((String)localObject);
    localWebSettings.setJavaScriptEnabled(true);
    localWebSettings.setJavaScriptCanOpenWindowsAutomatically(true);
    localWebSettings.setAllowFileAccess(true);
    localWebSettings.setPluginsEnabled(true);
    localWebSettings.setGeolocationEnabled(true);
    localWebSettings.setDatabaseEnabled(true);
    localWebSettings.setDomStorageEnabled(true);
  }
  
  public void closeBanner()
  {
    this._progressDialog.dismiss();
    if (this._mainActivity != null) {
      this._mainActivity.runOnUiThread(new Runnable()
      {
        public void run()
        {
          StartupScreenController.this._mainActivity.showContentView();
        }
      });
    }
  }
  
  public void load()
  {
    this._browser.loadUrl(this._bannerUrl);
    this._handler.postDelayed(this._closeRunnable, 5000L);
    this._progressDialog.show();
    this._keepAliveCalled = false;
  }
  
  public void setClickUrl(String paramString)
  {
    this._clickHandlerUrl = paramString;
  }
  
  public void stayAlive()
  {
    this._keepAliveCalled = true;
    this._progressDialog.dismiss();
  }
  
  private class FullScreenBannerWebViewClient
    extends SimpleWebViewClient
  {
    public FullScreenBannerWebViewClient(Activity paramActivity)
    {
      super();
    }
    
    private boolean _handleRedirect(WebView paramWebView, String paramString)
    {
      if (!paramString.equalsIgnoreCase(StartupScreenController.this._bannerUrl))
      {
        paramWebView.stopLoading();
        paramWebView = new Intent("android.intent.action.VIEW", Uri.parse(paramString));
        StartupScreenController.this._mainActivity.startActivity(paramWebView);
        StartupScreenController.this.closeBanner();
        if ((StartupScreenController.this._clickHandlerUrl != null) && (StartupScreenController.this._clickHandlerUrl.length() > 0)) {
          AppsGeyserServerClient.getInstance(StartupScreenController.this._mainActivity).SendClickInfo(StartupScreenController.this._clickHandlerUrl);
        }
        return true;
      }
      return false;
    }
    
    public void onPageFinished(WebView paramWebView, String paramString)
    {
      StartupScreenController.this._handler.postDelayed(StartupScreenController.this._closeRunnable, 200L);
    }
    
    public void onPageStarted(WebView paramWebView, String paramString, Bitmap paramBitmap)
    {
      _handleRedirect(paramWebView, paramString);
    }
    
    public boolean shouldOverrideUrlLoading(WebView paramWebView, String paramString)
    {
      return _handleRedirect(paramWebView, paramString);
    }
  }
}
