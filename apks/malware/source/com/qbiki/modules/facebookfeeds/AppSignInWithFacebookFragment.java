package com.qbiki.modules.facebookfeeds;

import android.content.Intent;
import android.content.res.Resources;
import android.os.AsyncTask;
import android.os.Bundle;
import android.support.v4.app.Fragment;
import android.support.v4.app.FragmentActivity;
import android.view.LayoutInflater;
import android.view.View;
import android.view.View.OnClickListener;
import android.view.ViewGroup;
import android.widget.Button;
import android.widget.Toast;
import com.facebook.android.DialogError;
import com.facebook.android.Facebook;
import com.facebook.android.Facebook.DialogListener;
import com.facebook.android.FacebookError;
import com.facebook.android.SessionEvents;
import com.qbiki.scapi.HttpResponseException;
import com.qbiki.scapi.SCApi;
import com.qbiki.scapi.SCApiException;
import com.qbiki.scapi.SCApiRequestAsyncTask;
import com.qbiki.seattleclouds.App;
import com.qbiki.seattleclouds.AppConfig;
import com.qbiki.seattleclouds.SCFragment;
import com.qbiki.util.DialogUtil;
import com.qbiki.util.ViewUtil;
import java.io.IOException;
import org.json.JSONException;
import org.json.JSONObject;

public class AppSignInWithFacebookFragment
  extends SCFragment
{
  private static final boolean DEBUG = false;
  private static final String TAG = AppSignInWithFacebookFragment.class.getSimpleName();
  private Facebook facebook;
  private View mContentView;
  private View mLoadingView;
  private int mShortAnimationDuration;
  private Button mSignInWithFacebookButton;
  
  public AppSignInWithFacebookFragment() {}
  
  private void executeAuthWithFacebookTask()
  {
    new FacebookSignInAsyncTask(null).execute(new String[0]);
  }
  
  private Facebook getFacebook()
  {
    if (this.facebook == null) {
      this.facebook = new Facebook(App.appConfig.getFacebookAppID());
    }
    return this.facebook;
  }
  
  private void setLoadingInProgress(boolean paramBoolean1, boolean paramBoolean2)
  {
    View localView1;
    if (paramBoolean1)
    {
      localView1 = this.mLoadingView;
      if (!paramBoolean1) {
        break label42;
      }
    }
    label42:
    for (View localView2 = this.mContentView;; localView2 = this.mLoadingView)
    {
      if (!paramBoolean2) {
        break label51;
      }
      ViewUtil.crossFadeViews(localView1, localView2, this.mShortAnimationDuration);
      return;
      localView1 = this.mContentView;
      break;
    }
    label51:
    localView1.setVisibility(0);
    localView2.setVisibility(8);
  }
  
  private void showError(final String paramString)
  {
    if (getActivity() == null) {
      return;
    }
    getActivity().runOnUiThread(new Runnable()
    {
      public void run()
      {
        AppSignInWithFacebookFragment.this.setLoadingInProgress(false, true);
        DialogUtil.showAlert(AppSignInWithFacebookFragment.this.getActivity(), 2131361915, paramString);
      }
    });
  }
  
  private void startSignInWithFacebookProcess()
  {
    Facebook localFacebook = getFacebook();
    FragmentActivity localFragmentActivity = getActivity();
    Facebook.DialogListener local2 = new Facebook.DialogListener()
    {
      public void onCancel()
      {
        SessionEvents.onLoginError("Action Canceled");
      }
      
      public void onComplete(Bundle paramAnonymousBundle)
      {
        SessionEvents.onLoginSuccess();
        AppSignInWithFacebookFragment.this.executeAuthWithFacebookTask();
      }
      
      public void onError(DialogError paramAnonymousDialogError)
      {
        SessionEvents.onLoginError(paramAnonymousDialogError.getMessage());
        Toast.makeText(AppSignInWithFacebookFragment.this.getActivity(), paramAnonymousDialogError.getMessage(), 1).show();
      }
      
      public void onFacebookError(FacebookError paramAnonymousFacebookError)
      {
        SessionEvents.onLoginError(paramAnonymousFacebookError.getMessage());
        Toast.makeText(AppSignInWithFacebookFragment.this.getActivity(), paramAnonymousFacebookError.getMessage(), 1).show();
      }
    };
    localFacebook.authorize(localFragmentActivity, new String[] { "basic_info", "read_stream", "public_profile", "publish_actions", "publish_stream", "share_item", "user_friends", "user_videos", "video_upload" }, -1, local2);
  }
  
  public View onCreateView(LayoutInflater paramLayoutInflater, ViewGroup paramViewGroup, Bundle paramBundle)
  {
    paramLayoutInflater = paramLayoutInflater.inflate(2130903128, paramViewGroup, false);
    this.mContentView = paramLayoutInflater.findViewById(2131099901);
    this.mLoadingView = paramLayoutInflater.findViewById(2131099905);
    this.mShortAnimationDuration = getResources().getInteger(17694720);
    ((Button)paramLayoutInflater.findViewById(2131099903)).setVisibility(8);
    this.mSignInWithFacebookButton = ((Button)paramLayoutInflater.findViewById(2131099904));
    this.mSignInWithFacebookButton.setOnClickListener(new View.OnClickListener()
    {
      public void onClick(View paramAnonymousView)
      {
        AppSignInWithFacebookFragment.this.startSignInWithFacebookProcess();
      }
    });
    return paramLayoutInflater;
  }
  
  private class FacebookSignInAsyncTask
    extends AsyncTask<String, Void, String>
  {
    private FacebookSignInAsyncTask() {}
    
    /* Error */
    protected String doInBackground(String... paramVarArgs)
    {
      // Byte code:
      //   0: aload_0
      //   1: getfield 14	com/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment$FacebookSignInAsyncTask:this$0	Lcom/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment;
      //   4: invokestatic 38	com/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment:access$400	(Lcom/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment;)Lcom/facebook/android/Facebook;
      //   7: astore_1
      //   8: aload_1
      //   9: ifnull +214 -> 223
      //   12: aload_1
      //   13: invokevirtual 44	com/facebook/android/Facebook:isSessionValid	()Z
      //   16: ifeq +207 -> 223
      //   19: aload_0
      //   20: getfield 14	com/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment$FacebookSignInAsyncTask:this$0	Lcom/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment;
      //   23: invokevirtual 48	com/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment:getActivity	()Landroid/support/v4/app/FragmentActivity;
      //   26: invokestatic 54	com/qbiki/modules/facebookfeeds/FacebookContext:getInstance	(Landroid/app/Activity;)Lcom/qbiki/modules/facebookfeeds/FacebookContext;
      //   29: aload_1
      //   30: getstatic 60	com/qbiki/seattleclouds/App:appConfig	Lcom/qbiki/seattleclouds/AppConfig;
      //   33: invokevirtual 66	com/qbiki/seattleclouds/AppConfig:getFacebookAppID	()Ljava/lang/String;
      //   36: invokevirtual 70	com/qbiki/modules/facebookfeeds/FacebookContext:setFacebook	(Lcom/facebook/android/Facebook;Ljava/lang/String;)V
      //   39: new 72	org/json/JSONObject
      //   42: dup
      //   43: aload_1
      //   44: ldc 74
      //   46: invokevirtual 78	com/facebook/android/Facebook:request	(Ljava/lang/String;)Ljava/lang/String;
      //   49: invokespecial 81	org/json/JSONObject:<init>	(Ljava/lang/String;)V
      //   52: astore 5
      //   54: aload_1
      //   55: invokevirtual 84	com/facebook/android/Facebook:getAccessToken	()Ljava/lang/String;
      //   58: astore_3
      //   59: aload 5
      //   61: ldc 86
      //   63: invokevirtual 89	org/json/JSONObject:getString	(Ljava/lang/String;)Ljava/lang/String;
      //   66: astore 4
      //   68: ldc 91
      //   70: astore_2
      //   71: aload 5
      //   73: ldc 93
      //   75: invokevirtual 97	org/json/JSONObject:has	(Ljava/lang/String;)Z
      //   78: ifeq +29 -> 107
      //   81: new 99	java/lang/StringBuilder
      //   84: dup
      //   85: invokespecial 100	java/lang/StringBuilder:<init>	()V
      //   88: ldc 91
      //   90: invokevirtual 104	java/lang/StringBuilder:append	(Ljava/lang/String;)Ljava/lang/StringBuilder;
      //   93: aload 5
      //   95: ldc 93
      //   97: invokevirtual 89	org/json/JSONObject:getString	(Ljava/lang/String;)Ljava/lang/String;
      //   100: invokevirtual 104	java/lang/StringBuilder:append	(Ljava/lang/String;)Ljava/lang/StringBuilder;
      //   103: invokevirtual 107	java/lang/StringBuilder:toString	()Ljava/lang/String;
      //   106: astore_2
      //   107: aload_2
      //   108: astore_1
      //   109: aload_2
      //   110: invokevirtual 113	java/lang/String:length	()I
      //   113: ifne +40 -> 153
      //   116: aload_2
      //   117: astore_1
      //   118: aload 5
      //   120: ldc 115
      //   122: invokevirtual 97	org/json/JSONObject:has	(Ljava/lang/String;)Z
      //   125: ifeq +28 -> 153
      //   128: new 99	java/lang/StringBuilder
      //   131: dup
      //   132: invokespecial 100	java/lang/StringBuilder:<init>	()V
      //   135: aload_2
      //   136: invokevirtual 104	java/lang/StringBuilder:append	(Ljava/lang/String;)Ljava/lang/StringBuilder;
      //   139: aload 5
      //   141: ldc 115
      //   143: invokevirtual 89	org/json/JSONObject:getString	(Ljava/lang/String;)Ljava/lang/String;
      //   146: invokevirtual 104	java/lang/StringBuilder:append	(Ljava/lang/String;)Ljava/lang/StringBuilder;
      //   149: invokevirtual 107	java/lang/StringBuilder:toString	()Ljava/lang/String;
      //   152: astore_1
      //   153: aload_1
      //   154: astore_2
      //   155: aload_1
      //   156: invokevirtual 113	java/lang/String:length	()I
      //   159: ifne +23 -> 182
      //   162: new 99	java/lang/StringBuilder
      //   165: dup
      //   166: invokespecial 100	java/lang/StringBuilder:<init>	()V
      //   169: aload_1
      //   170: invokevirtual 104	java/lang/StringBuilder:append	(Ljava/lang/String;)Ljava/lang/StringBuilder;
      //   173: aload 4
      //   175: invokevirtual 104	java/lang/StringBuilder:append	(Ljava/lang/String;)Ljava/lang/StringBuilder;
      //   178: invokevirtual 107	java/lang/StringBuilder:toString	()Ljava/lang/String;
      //   181: astore_2
      //   182: new 117	com/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment$SignInViaScApiAsyncTask
      //   185: dup
      //   186: aload_0
      //   187: getfield 14	com/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment$FacebookSignInAsyncTask:this$0	Lcom/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment;
      //   190: aload_0
      //   191: getfield 14	com/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment$FacebookSignInAsyncTask:this$0	Lcom/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment;
      //   194: invokespecial 120	com/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment$SignInViaScApiAsyncTask:<init>	(Lcom/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment;Landroid/support/v4/app/Fragment;)V
      //   197: iconst_4
      //   198: anewarray 109	java/lang/String
      //   201: dup
      //   202: iconst_0
      //   203: aload_3
      //   204: aastore
      //   205: dup
      //   206: iconst_1
      //   207: ldc 122
      //   209: aastore
      //   210: dup
      //   211: iconst_2
      //   212: aload 4
      //   214: aastore
      //   215: dup
      //   216: iconst_3
      //   217: aload_2
      //   218: aastore
      //   219: invokevirtual 126	com/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment$SignInViaScApiAsyncTask:execute	([Ljava/lang/Object;)Landroid/os/AsyncTask;
      //   222: pop
      //   223: aconst_null
      //   224: areturn
      //   225: astore_1
      //   226: invokestatic 129	com/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment:access$500	()Ljava/lang/String;
      //   229: new 99	java/lang/StringBuilder
      //   232: dup
      //   233: invokespecial 100	java/lang/StringBuilder:<init>	()V
      //   236: ldc -125
      //   238: invokevirtual 104	java/lang/StringBuilder:append	(Ljava/lang/String;)Ljava/lang/StringBuilder;
      //   241: aload_1
      //   242: invokevirtual 132	java/net/MalformedURLException:toString	()Ljava/lang/String;
      //   245: invokevirtual 104	java/lang/StringBuilder:append	(Ljava/lang/String;)Ljava/lang/StringBuilder;
      //   248: invokevirtual 107	java/lang/StringBuilder:toString	()Ljava/lang/String;
      //   251: invokestatic 138	android/util/Log:e	(Ljava/lang/String;Ljava/lang/String;)I
      //   254: pop
      //   255: aload_0
      //   256: getfield 14	com/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment$FacebookSignInAsyncTask:this$0	Lcom/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment;
      //   259: aload_1
      //   260: invokevirtual 141	java/net/MalformedURLException:getMessage	()Ljava/lang/String;
      //   263: invokestatic 145	com/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment:access$600	(Lcom/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment;Ljava/lang/String;)V
      //   266: aconst_null
      //   267: areturn
      //   268: astore_1
      //   269: aload_1
      //   270: athrow
      //   271: astore_1
      //   272: invokestatic 129	com/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment:access$500	()Ljava/lang/String;
      //   275: new 99	java/lang/StringBuilder
      //   278: dup
      //   279: invokespecial 100	java/lang/StringBuilder:<init>	()V
      //   282: ldc -109
      //   284: invokevirtual 104	java/lang/StringBuilder:append	(Ljava/lang/String;)Ljava/lang/StringBuilder;
      //   287: aload_1
      //   288: invokevirtual 148	java/io/IOException:toString	()Ljava/lang/String;
      //   291: invokevirtual 104	java/lang/StringBuilder:append	(Ljava/lang/String;)Ljava/lang/StringBuilder;
      //   294: invokevirtual 107	java/lang/StringBuilder:toString	()Ljava/lang/String;
      //   297: invokestatic 138	android/util/Log:e	(Ljava/lang/String;Ljava/lang/String;)I
      //   300: pop
      //   301: aload_0
      //   302: getfield 14	com/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment$FacebookSignInAsyncTask:this$0	Lcom/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment;
      //   305: ldc -106
      //   307: invokestatic 145	com/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment:access$600	(Lcom/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment;Ljava/lang/String;)V
      //   310: aconst_null
      //   311: areturn
      //   312: astore_1
      //   313: invokestatic 129	com/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment:access$500	()Ljava/lang/String;
      //   316: new 99	java/lang/StringBuilder
      //   319: dup
      //   320: invokespecial 100	java/lang/StringBuilder:<init>	()V
      //   323: ldc -104
      //   325: invokevirtual 104	java/lang/StringBuilder:append	(Ljava/lang/String;)Ljava/lang/StringBuilder;
      //   328: aload_1
      //   329: invokevirtual 153	org/json/JSONException:toString	()Ljava/lang/String;
      //   332: invokevirtual 104	java/lang/StringBuilder:append	(Ljava/lang/String;)Ljava/lang/StringBuilder;
      //   335: invokevirtual 107	java/lang/StringBuilder:toString	()Ljava/lang/String;
      //   338: invokestatic 138	android/util/Log:e	(Ljava/lang/String;Ljava/lang/String;)I
      //   341: pop
      //   342: aload_0
      //   343: getfield 14	com/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment$FacebookSignInAsyncTask:this$0	Lcom/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment;
      //   346: ldc -101
      //   348: invokestatic 145	com/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment:access$600	(Lcom/qbiki/modules/facebookfeeds/AppSignInWithFacebookFragment;Ljava/lang/String;)V
      //   351: aconst_null
      //   352: areturn
      // Local variable table:
      //   start	length	slot	name	signature
      //   0	353	0	this	FacebookSignInAsyncTask
      //   0	353	1	paramVarArgs	String[]
      //   70	148	2	localObject	Object
      //   58	146	3	str1	String
      //   66	147	4	str2	String
      //   52	88	5	localJSONObject	JSONObject
      // Exception table:
      //   from	to	target	type
      //   19	68	225	java/net/MalformedURLException
      //   71	107	225	java/net/MalformedURLException
      //   109	116	225	java/net/MalformedURLException
      //   118	153	225	java/net/MalformedURLException
      //   155	182	225	java/net/MalformedURLException
      //   182	223	225	java/net/MalformedURLException
      //   19	68	268	finally
      //   71	107	268	finally
      //   109	116	268	finally
      //   118	153	268	finally
      //   155	182	268	finally
      //   182	223	268	finally
      //   226	266	268	finally
      //   272	310	268	finally
      //   313	351	268	finally
      //   19	68	271	java/io/IOException
      //   71	107	271	java/io/IOException
      //   109	116	271	java/io/IOException
      //   118	153	271	java/io/IOException
      //   155	182	271	java/io/IOException
      //   182	223	271	java/io/IOException
      //   19	68	312	org/json/JSONException
      //   71	107	312	org/json/JSONException
      //   109	116	312	org/json/JSONException
      //   118	153	312	org/json/JSONException
      //   155	182	312	org/json/JSONException
      //   182	223	312	org/json/JSONException
    }
    
    protected void onPreExecute()
    {
      AppSignInWithFacebookFragment.this.setLoadingInProgress(true, false);
      super.onPreExecute();
    }
  }
  
  private class SignInViaScApiAsyncTask
    extends SCApiRequestAsyncTask<String, Void, String>
  {
    private String mDisplayName;
    private boolean mIsNewAccount;
    private String mProviderUserID;
    private String mUserId;
    
    public SignInViaScApiAsyncTask(Fragment paramFragment)
    {
      super();
    }
    
    protected void onPostExecute(String paramString)
    {
      if (paramString != null)
      {
        paramString = new Intent();
        paramString.putExtra("userId", this.mUserId);
        paramString.putExtra("isNewAccount", this.mIsNewAccount);
        paramString.putExtra("displayName", this.mDisplayName);
        paramString.putExtra("facebookUserID", this.mProviderUserID);
        AppSignInWithFacebookFragment.this.getActivity().setResult(-1, paramString);
        AppSignInWithFacebookFragment.this.getActivity().finish();
      }
      AppSignInWithFacebookFragment.this.setLoadingInProgress(false, true);
    }
    
    protected void onPreExecute()
    {
      AppSignInWithFacebookFragment.this.setLoadingInProgress(true, false);
      super.onPreExecute();
    }
    
    protected String performRequest(String... paramVarArgs)
      throws IOException, JSONException, HttpResponseException, SCApiException
    {
      String str2 = paramVarArgs[0];
      String str3 = paramVarArgs[1];
      String str1 = paramVarArgs[2];
      this.mDisplayName = paramVarArgs[3];
      paramVarArgs = SCApi.getInstance().appUserSignIn(str3, str1, str2, this.mDisplayName);
      this.mUserId = paramVarArgs.getString("userId");
      this.mIsNewAccount = paramVarArgs.getBoolean("isNewAccount");
      this.mProviderUserID = str1;
      SCApi.getInstance().postFacebookFeedsUser(str1, App.appConfig.getFacebookAppID());
      return "ok";
    }
  }
}
