package com.qbiki.gcm;

import android.app.Notification;
import android.app.NotificationManager;
import android.app.PendingIntent;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.content.SharedPreferences.Editor;
import android.os.Bundle;
import com.google.android.gms.gcm.GoogleCloudMessaging;
import com.qbiki.c2dm.AnnouncementActivity;
import com.qbiki.modules.messenger.MessengerNotifications;

public class GCMBroadcastReceiver
  extends BroadcastReceiver
{
  private static final boolean DEBUG = false;
  private static final String KEY_MESSAGE = "message";
  private static final String KEY_TYPE = "type";
  private static final String PREF_NAME = "GCMBroadcastReceiver";
  private static final String TAG = "GCMBroadcastReceiver";
  
  public GCMBroadcastReceiver() {}
  
  private static void generateNotification(Context paramContext, String paramString1, String paramString2, Intent paramIntent)
  {
    long l = System.currentTimeMillis();
    int i = getNextNotificationId(paramContext);
    Notification localNotification = new Notification(2130837706, paramString2, l);
    paramIntent.setFlags(268435456);
    localNotification.setLatestEventInfo(paramContext, paramString2, paramString1, PendingIntent.getActivity(paramContext, i, paramIntent, 134217728));
    localNotification.flags |= 0x10;
    localNotification.defaults |= 0x1;
    ((NotificationManager)paramContext.getSystemService("notification")).notify(i, localNotification);
  }
  
  public static int getNextNotificationId(Context paramContext)
  {
    paramContext = getSettings(paramContext);
    int i = paramContext.getInt("notificationID", 0);
    paramContext = paramContext.edit();
    i += 1;
    paramContext.putInt("notificationID", i % 32);
    paramContext.commit();
    return i;
  }
  
  private static SharedPreferences getSettings(Context paramContext)
  {
    return paramContext.getSharedPreferences("GCMBroadcastReceiver", 0);
  }
  
  private void onMessage(Context paramContext, Intent paramIntent)
  {
    Object localObject = paramIntent.getExtras();
    if (localObject != null)
    {
      str = ((Bundle)localObject).getString("type");
      paramIntent = str;
      if (str == null) {
        paramIntent = "";
      }
      if (!paramIntent.equals("messengerMessage")) {
        break label44;
      }
      MessengerNotifications.processGcmMessage(paramContext, (Bundle)localObject);
    }
    label44:
    do
    {
      return;
      paramIntent = ((Bundle)localObject).getString("message");
    } while (paramIntent == null);
    String str = paramIntent.replace("\\n", "\n");
    localObject = new Intent(paramContext, AnnouncementActivity.class);
    ((Intent)localObject).putExtra("message", str);
    paramIntent = str;
    if (str.length() > 50) {
      paramIntent = str.substring(0, 50);
    }
    generateNotification(paramContext, paramContext.getString(2131361834), paramIntent, (Intent)localObject);
  }
  
  public void onReceive(Context paramContext, Intent paramIntent)
  {
    String str = GoogleCloudMessaging.getInstance(paramContext).getMessageType(paramIntent);
    if ("send_error".equals(str)) {}
    for (;;)
    {
      setResultCode(-1);
      return;
      if (!"deleted_messages".equals(str)) {
        onMessage(paramContext, paramIntent);
      }
    }
  }
}
