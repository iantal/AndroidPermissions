package org.apache.http.impl.client;

import java.io.IOException;
import java.net.Socket;
import org.apache.http.ConnectionReuseStrategy;
import org.apache.http.HttpClientConnection;
import org.apache.http.HttpException;
import org.apache.http.HttpHost;
import org.apache.http.HttpRequest;
import org.apache.http.HttpRequestInterceptor;
import org.apache.http.HttpResponse;
import org.apache.http.HttpVersion;
import org.apache.http.StatusLine;
import org.apache.http.auth.AuthSchemeRegistry;
import org.apache.http.auth.AuthScope;
import org.apache.http.auth.AuthStateHC4;
import org.apache.http.auth.Credentials;
import org.apache.http.client.config.RequestConfig;
import org.apache.http.client.params.HttpClientParamConfig;
import org.apache.http.client.protocol.RequestClientConnControl;
import org.apache.http.config.ConnectionConfig;
import org.apache.http.conn.HttpConnectionFactory;
import org.apache.http.conn.ManagedHttpClientConnection;
import org.apache.http.conn.routing.HttpRoute;
import org.apache.http.conn.routing.RouteInfo.LayerType;
import org.apache.http.conn.routing.RouteInfo.TunnelType;
import org.apache.http.entity.BufferedHttpEntityHC4;
import org.apache.http.impl.DefaultConnectionReuseStrategyHC4;
import org.apache.http.impl.auth.BasicSchemeFactoryHC4;
import org.apache.http.impl.auth.DigestSchemeFactoryHC4;
import org.apache.http.impl.auth.HttpAuthenticator;
import org.apache.http.impl.auth.NTLMSchemeFactory;
import org.apache.http.impl.conn.ManagedHttpClientConnectionFactory;
import org.apache.http.impl.execchain.TunnelRefusedException;
import org.apache.http.message.BasicHttpRequest;
import org.apache.http.params.BasicHttpParams;
import org.apache.http.params.HttpParamConfig;
import org.apache.http.params.HttpParams;
import org.apache.http.protocol.BasicHttpContextHC4;
import org.apache.http.protocol.HttpContext;
import org.apache.http.protocol.HttpProcessor;
import org.apache.http.protocol.HttpRequestExecutor;
import org.apache.http.protocol.ImmutableHttpProcessor;
import org.apache.http.protocol.RequestTargetHostHC4;
import org.apache.http.protocol.RequestUserAgentHC4;
import org.apache.http.util.Args;
import org.apache.http.util.EntityUtilsHC4;

public class ProxyClient
{
  private final AuthSchemeRegistry authSchemeRegistry;
  private final HttpAuthenticator authenticator;
  private final HttpConnectionFactory<HttpRoute, ManagedHttpClientConnection> connFactory;
  private final ConnectionConfig connectionConfig;
  private final HttpProcessor httpProcessor;
  private final AuthStateHC4 proxyAuthState;
  private final ProxyAuthenticationStrategy proxyAuthStrategy;
  private final RequestConfig requestConfig;
  private final HttpRequestExecutor requestExec;
  private final ConnectionReuseStrategy reuseStrategy;
  
  public ProxyClient()
  {
    this(null, null, null);
  }
  
  public ProxyClient(RequestConfig paramRequestConfig)
  {
    this(null, null, paramRequestConfig);
  }
  
  public ProxyClient(HttpConnectionFactory<HttpRoute, ManagedHttpClientConnection> paramHttpConnectionFactory, ConnectionConfig paramConnectionConfig, RequestConfig paramRequestConfig)
  {
    if (paramHttpConnectionFactory != null)
    {
      this.connFactory = paramHttpConnectionFactory;
      if (paramConnectionConfig == null) {
        break label198;
      }
      label17:
      this.connectionConfig = paramConnectionConfig;
      if (paramRequestConfig == null) {
        break label205;
      }
    }
    for (;;)
    {
      this.requestConfig = paramRequestConfig;
      this.httpProcessor = new ImmutableHttpProcessor(new HttpRequestInterceptor[] { new RequestTargetHostHC4(), new RequestClientConnControl(), new RequestUserAgentHC4() });
      this.requestExec = new HttpRequestExecutor();
      this.proxyAuthStrategy = new ProxyAuthenticationStrategy();
      this.authenticator = new HttpAuthenticator();
      this.proxyAuthState = new AuthStateHC4();
      this.authSchemeRegistry = new AuthSchemeRegistry();
      this.authSchemeRegistry.register("Basic", new BasicSchemeFactoryHC4());
      this.authSchemeRegistry.register("Digest", new DigestSchemeFactoryHC4());
      this.authSchemeRegistry.register("NTLM", new NTLMSchemeFactory());
      this.reuseStrategy = new DefaultConnectionReuseStrategyHC4();
      return;
      paramHttpConnectionFactory = ManagedHttpClientConnectionFactory.INSTANCE;
      break;
      label198:
      paramConnectionConfig = ConnectionConfig.DEFAULT;
      break label17;
      label205:
      paramRequestConfig = RequestConfig.DEFAULT;
    }
  }
  
  @Deprecated
  public ProxyClient(HttpParams paramHttpParams)
  {
    this(null, HttpParamConfig.getConnectionConfig(paramHttpParams), HttpClientParamConfig.getRequestConfig(paramHttpParams));
  }
  
  @Deprecated
  public AuthSchemeRegistry getAuthSchemeRegistry()
  {
    return this.authSchemeRegistry;
  }
  
  @Deprecated
  public HttpParams getParams()
  {
    return new BasicHttpParams();
  }
  
  public Socket tunnel(HttpHost paramHttpHost1, HttpHost paramHttpHost2, Credentials paramCredentials)
    throws IOException, HttpException
  {
    Args.notNull(paramHttpHost1, "Proxy host");
    Args.notNull(paramHttpHost2, "Target host");
    Args.notNull(paramCredentials, "Credentials");
    Object localObject2 = paramHttpHost2;
    Object localObject1 = localObject2;
    if (((HttpHost)localObject2).getPort() <= 0) {
      localObject1 = new HttpHost(((HttpHost)localObject2).getHostName(), 80, ((HttpHost)localObject2).getSchemeName());
    }
    HttpRoute localHttpRoute = new HttpRoute((HttpHost)localObject1, this.requestConfig.getLocalAddress(), paramHttpHost1, false, RouteInfo.TunnelType.TUNNELLED, RouteInfo.LayerType.PLAIN);
    localObject2 = (ManagedHttpClientConnection)this.connFactory.create(localHttpRoute, this.connectionConfig);
    BasicHttpContextHC4 localBasicHttpContextHC4 = new BasicHttpContextHC4();
    localObject1 = new BasicHttpRequest("CONNECT", ((HttpHost)localObject1).toHostString(), HttpVersion.HTTP_1_1);
    BasicCredentialsProviderHC4 localBasicCredentialsProviderHC4 = new BasicCredentialsProviderHC4();
    localBasicCredentialsProviderHC4.setCredentials(new AuthScope(paramHttpHost1.getHostName(), paramHttpHost1.getPort()), paramCredentials);
    localBasicHttpContextHC4.setAttribute("http.target_host", paramHttpHost2);
    localBasicHttpContextHC4.setAttribute("http.connection", localObject2);
    localBasicHttpContextHC4.setAttribute("http.request", localObject1);
    localBasicHttpContextHC4.setAttribute("http.route", localHttpRoute);
    localBasicHttpContextHC4.setAttribute("http.auth.proxy-scope", this.proxyAuthState);
    localBasicHttpContextHC4.setAttribute("http.auth.credentials-provider", localBasicCredentialsProviderHC4);
    localBasicHttpContextHC4.setAttribute("http.authscheme-registry", this.authSchemeRegistry);
    localBasicHttpContextHC4.setAttribute("http.request-config", this.requestConfig);
    this.requestExec.preProcess((HttpRequest)localObject1, this.httpProcessor, localBasicHttpContextHC4);
    if (!((ManagedHttpClientConnection)localObject2).isOpen()) {
      ((ManagedHttpClientConnection)localObject2).bind(new Socket(paramHttpHost1.getHostName(), paramHttpHost1.getPort()));
    }
    this.authenticator.generateAuthResponse((HttpRequest)localObject1, this.proxyAuthState, localBasicHttpContextHC4);
    paramHttpHost2 = this.requestExec.execute((HttpRequest)localObject1, (HttpClientConnection)localObject2, localBasicHttpContextHC4);
    if (paramHttpHost2.getStatusLine().getStatusCode() < 200) {
      throw new HttpException("Unexpected response to CONNECT request: " + paramHttpHost2.getStatusLine());
    }
    if ((this.authenticator.isAuthenticationRequested(paramHttpHost1, paramHttpHost2, this.proxyAuthStrategy, this.proxyAuthState, localBasicHttpContextHC4)) && (this.authenticator.handleAuthChallenge(paramHttpHost1, paramHttpHost2, this.proxyAuthStrategy, this.proxyAuthState, localBasicHttpContextHC4)))
    {
      if (this.reuseStrategy.keepAlive(paramHttpHost2, localBasicHttpContextHC4)) {
        EntityUtilsHC4.consume(paramHttpHost2.getEntity());
      }
      for (;;)
      {
        ((HttpRequest)localObject1).removeHeaders("Proxy-Authorization");
        break;
        ((ManagedHttpClientConnection)localObject2).close();
      }
    }
    if (paramHttpHost2.getStatusLine().getStatusCode() > 299)
    {
      paramHttpHost1 = paramHttpHost2.getEntity();
      if (paramHttpHost1 != null) {
        paramHttpHost2.setEntity(new BufferedHttpEntityHC4(paramHttpHost1));
      }
      ((ManagedHttpClientConnection)localObject2).close();
      throw new TunnelRefusedException("CONNECT refused by proxy: " + paramHttpHost2.getStatusLine(), paramHttpHost2);
    }
    return ((ManagedHttpClientConnection)localObject2).getSocket();
  }
}
