package net.tsz.afinal.utils;

import java.lang.reflect.Field;
import java.lang.reflect.ParameterizedType;
import java.util.ArrayList;
import java.util.List;
import net.tsz.afinal.annotation.sqlite.Id;
import net.tsz.afinal.annotation.sqlite.Table;
import net.tsz.afinal.db.sqlite.ManyToOneLazyLoader;
import net.tsz.afinal.db.table.ManyToOne;
import net.tsz.afinal.db.table.OneToMany;
import net.tsz.afinal.db.table.Property;
import net.tsz.afinal.exception.DbException;

public class ClassUtils
{
  public ClassUtils() {}
  
  public static List<ManyToOne> getManyToOneList(Class<?> paramClass)
  {
    ArrayList localArrayList = new ArrayList();
    for (;;)
    {
      int j;
      int i;
      try
      {
        arrayOfField = paramClass.getDeclaredFields();
        j = arrayOfField.length;
        i = 0;
      }
      catch (Exception paramClass)
      {
        Field[] arrayOfField;
        Field localField;
        ManyToOne localManyToOne;
        Class localClass;
        throw new RuntimeException(paramClass.getMessage(), paramClass);
      }
      localField = arrayOfField[i];
      if ((!FieldUtils.isTransient(localField)) && (FieldUtils.isManyToOne(localField)))
      {
        localManyToOne = new ManyToOne();
        if (localField.getType() == ManyToOneLazyLoader.class)
        {
          localClass = (Class)((ParameterizedType)localField.getGenericType()).getActualTypeArguments()[1];
          if (localClass != null) {
            localManyToOne.setManyClass(localClass);
          }
          localManyToOne.setColumn(FieldUtils.getColumnByField(localField));
          localManyToOne.setFieldName(localField.getName());
          localManyToOne.setDataType(localField.getType());
          localManyToOne.setSet(FieldUtils.getFieldSetMethod(paramClass, localField));
          localManyToOne.setGet(FieldUtils.getFieldGetMethod(paramClass, localField));
          localArrayList.add(localManyToOne);
        }
        else
        {
          localManyToOne.setManyClass(localField.getType());
          continue;
        }
      }
      while (i >= j)
      {
        return localArrayList;
        i += 1;
      }
    }
  }
  
  public static List<OneToMany> getOneToManyList(Class<?> paramClass)
  {
    ArrayList localArrayList = new ArrayList();
    for (;;)
    {
      int j;
      int i;
      try
      {
        arrayOfField = paramClass.getDeclaredFields();
        j = arrayOfField.length;
        i = 0;
      }
      catch (Exception paramClass)
      {
        Field[] arrayOfField;
        OneToMany localOneToMany;
        Object localObject;
        throw new RuntimeException(paramClass.getMessage(), paramClass);
      }
      Field localField = arrayOfField[i];
      if ((!FieldUtils.isTransient(localField)) && (FieldUtils.isOneToMany(localField)))
      {
        localOneToMany = new OneToMany();
        localOneToMany.setColumn(FieldUtils.getColumnByField(localField));
        localOneToMany.setFieldName(localField.getName());
        if ((localField.getGenericType() instanceof ParameterizedType))
        {
          localObject = (ParameterizedType)localField.getGenericType();
          if (((ParameterizedType)localObject).getActualTypeArguments().length == 1)
          {
            localObject = (Class)localObject.getActualTypeArguments()[0];
            if (localObject != null) {
              localOneToMany.setOneClass((Class)localObject);
            }
            localOneToMany.setDataType(localField.getType());
            localOneToMany.setSet(FieldUtils.getFieldSetMethod(paramClass, localField));
            localOneToMany.setGet(FieldUtils.getFieldGetMethod(paramClass, localField));
            localArrayList.add(localOneToMany);
          }
          else
          {
            localObject = (Class)localObject.getActualTypeArguments()[1];
            if (localObject == null) {
              continue;
            }
            localOneToMany.setOneClass((Class)localObject);
            continue;
          }
        }
        else
        {
          throw new DbException("getOneToManyList Exception:" + localField.getName() + "'s type is null");
        }
      }
      while (i >= j)
      {
        return localArrayList;
        i += 1;
      }
    }
  }
  
  public static String getPrimaryKeyColumn(Class<?> paramClass)
  {
    Object localObject2 = paramClass.getDeclaredFields();
    if (localObject2 != null)
    {
      int j = localObject2.length;
      int i = 0;
      paramClass = null;
      for (;;)
      {
        Object localObject1;
        if (i >= j) {
          localObject1 = null;
        }
        do
        {
          if (paramClass == null) {
            break;
          }
          localObject2 = paramClass.column();
          if (localObject2 != null)
          {
            paramClass = (Class<?>)localObject2;
            if (((String)localObject2).trim().length() != 0) {}
          }
          else
          {
            paramClass = localObject1.getName();
          }
          return paramClass;
          localObject1 = localObject2[i];
          paramClass = (Id)localObject1.getAnnotation(Id.class);
        } while (paramClass != null);
        i += 1;
      }
      j = localObject2.length;
      i = 0;
      if (i >= j)
      {
        j = localObject2.length;
        i = 0;
      }
      for (;;)
      {
        if (i >= j) {
          break label194;
        }
        if ("id".equals(localObject2[i].getName()))
        {
          return "id";
          if ("_id".equals(localObject2[i].getName())) {
            return "_id";
          }
          i += 1;
          break;
        }
        i += 1;
      }
    }
    throw new RuntimeException("this model[" + paramClass + "] has no field");
    label194:
    return null;
  }
  
  public static Field getPrimaryKeyField(Class<?> paramClass)
  {
    Field[] arrayOfField = paramClass.getDeclaredFields();
    if (arrayOfField != null)
    {
      int j = arrayOfField.length;
      int i = 0;
      Object localObject = null;
      if (i >= j)
      {
        label24:
        if (localObject == null)
        {
          j = arrayOfField.length;
          i = 0;
          label34:
          if (i < j) {
            break label83;
          }
        }
        paramClass = (Class<?>)localObject;
        label41:
        if (paramClass == null)
        {
          j = arrayOfField.length;
          i = 0;
        }
      }
      for (;;)
      {
        if (i >= j) {
          localObject = paramClass;
        }
        label83:
        Field localField;
        do
        {
          return localObject;
          paramClass = arrayOfField[i];
          localObject = paramClass;
          if (paramClass.getAnnotation(Id.class) != null) {
            break label24;
          }
          i += 1;
          break;
          localField = arrayOfField[i];
          paramClass = localField;
          if ("_id".equals(localField.getName())) {
            break label41;
          }
          i += 1;
          break label34;
          localField = arrayOfField[i];
          localObject = localField;
        } while ("id".equals(localField.getName()));
        i += 1;
      }
    }
    throw new RuntimeException("this model[" + paramClass + "] has no field");
  }
  
  public static String getPrimaryKeyFieldName(Class<?> paramClass)
  {
    paramClass = getPrimaryKeyField(paramClass);
    if (paramClass == null) {
      return null;
    }
    return paramClass.getName();
  }
  
  public static Object getPrimaryKeyValue(Object paramObject)
  {
    return FieldUtils.getFieldValue(paramObject, getPrimaryKeyField(paramObject.getClass()));
  }
  
  public static List<Property> getPropertyList(Class<?> paramClass)
  {
    ArrayList localArrayList = new ArrayList();
    for (;;)
    {
      int j;
      int i;
      try
      {
        arrayOfField = paramClass.getDeclaredFields();
        str = getPrimaryKeyFieldName(paramClass);
        j = arrayOfField.length;
        i = 0;
      }
      catch (Exception paramClass)
      {
        Field[] arrayOfField;
        String str;
        Field localField;
        Property localProperty;
        throw new RuntimeException(paramClass.getMessage(), paramClass);
      }
      localField = arrayOfField[i];
      if ((!FieldUtils.isTransient(localField)) && (FieldUtils.isBaseDateType(localField)) && (!localField.getName().equals(str)))
      {
        localProperty = new Property();
        localProperty.setColumn(FieldUtils.getColumnByField(localField));
        localProperty.setFieldName(localField.getName());
        localProperty.setDataType(localField.getType());
        localProperty.setDefaultValue(FieldUtils.getPropertyDefaultValue(localField));
        localProperty.setSet(FieldUtils.getFieldSetMethod(paramClass, localField));
        localProperty.setGet(FieldUtils.getFieldGetMethod(paramClass, localField));
        localProperty.setField(localField);
        localArrayList.add(localProperty);
      }
      while (i >= j)
      {
        return localArrayList;
        i += 1;
      }
    }
  }
  
  public static String getTableName(Class<?> paramClass)
  {
    Table localTable = (Table)paramClass.getAnnotation(Table.class);
    if ((localTable == null) || (localTable.name().trim().length() == 0)) {
      return paramClass.getName().replace('.', '_');
    }
    return localTable.name();
  }
}
