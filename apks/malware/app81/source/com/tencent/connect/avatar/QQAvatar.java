package com.tencent.connect.avatar;

import android.app.Activity;
import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.net.Uri;
import android.os.Bundle;
import com.tencent.connect.auth.QQToken;
import com.tencent.connect.common.BaseApi;
import com.tencent.open.b.d;
import com.tencent.open.utils.Global;
import com.tencent.open.utils.Util;
import com.tencent.tauth.IUiListener;
import com.tencent.tauth.UiError;
import org.json.JSONException;
import org.json.JSONObject;

public class QQAvatar
  extends BaseApi
{
  private IUiListener a;
  
  public QQAvatar(QQToken paramQQToken)
  {
    super(paramQQToken);
  }
  
  private Intent a(Activity paramActivity)
  {
    Intent localIntent = new Intent();
    localIntent.setClass(paramActivity, ImageActivity.class);
    return localIntent;
  }
  
  private void a(Activity paramActivity, Bundle paramBundle)
  {
    a(paramBundle);
    this.mActivityIntent.putExtra("key_action", "action_avatar");
    this.mActivityIntent.putExtra("key_params", paramBundle);
    startAssitActivity(paramActivity, this.a);
  }
  
  private void a(Bundle paramBundle)
  {
    if (this.mToken != null)
    {
      paramBundle.putString("appid", this.mToken.getAppId());
      if (this.mToken.isSessionValid())
      {
        paramBundle.putString("keystr", this.mToken.getAccessToken());
        paramBundle.putString("keytype", "0x80");
      }
      String str = this.mToken.getOpenId();
      if (str != null) {
        paramBundle.putString("hopenid", str);
      }
      paramBundle.putString("platform", "androidqz");
    }
    try
    {
      paramBundle.putString("pf", Global.getContext().getSharedPreferences("pfStore", 0).getString("pf", "openmobile_android"));
      paramBundle.putString("sdkv", "2.9.1");
      paramBundle.putString("sdkp", "a");
      return;
    }
    catch (Exception localException)
    {
      for (;;)
      {
        localException.printStackTrace();
        paramBundle.putString("pf", "openmobile_android");
      }
    }
  }
  
  public void onActivityResult(Activity paramActivity, int paramInt1, int paramInt2, Intent paramIntent)
  {
    if (paramInt2 == -1)
    {
      if (paramIntent == null)
      {
        this.a.onError(new UiError(-6, "onActivityResult intent data is null.", "onActivityResult intent data is null."));
        return;
      }
      paramInt1 = paramIntent.getIntExtra("key_error_code", 0);
      if (paramInt1 == 0)
      {
        paramActivity = paramIntent.getStringExtra("key_response");
        if (paramActivity != null) {
          try
          {
            paramIntent = Util.parseJson(paramActivity);
            this.a.onComplete(paramIntent);
            return;
          }
          catch (JSONException paramIntent)
          {
            this.a.onError(new UiError(-4, "服务器返回数据格式有误!", paramActivity));
            return;
          }
        }
        this.a.onComplete(new JSONObject());
        return;
      }
      paramActivity = paramIntent.getStringExtra("key_error_msg");
      paramIntent = paramIntent.getStringExtra("key_error_detail");
      this.a.onError(new UiError(paramInt1, paramActivity, paramIntent));
      return;
    }
    this.a.onCancel();
  }
  
  public void setAvatar(Activity paramActivity, Uri paramUri, IUiListener paramIUiListener, int paramInt)
  {
    if (this.a != null) {
      this.a.onCancel();
    }
    this.a = paramIUiListener;
    paramIUiListener = new Bundle();
    paramIUiListener.putString("picture", paramUri.toString());
    paramIUiListener.putInt("exitAnim", paramInt);
    paramIUiListener.putString("appid", this.mToken.getAppId());
    paramIUiListener.putString("access_token", this.mToken.getAccessToken());
    paramIUiListener.putLong("expires_in", this.mToken.getExpireTimeInSecond());
    paramIUiListener.putString("openid", this.mToken.getOpenId());
    this.mActivityIntent = a(paramActivity);
    if (hasActivityForIntent())
    {
      a(paramActivity, paramIUiListener);
      d.a().a(this.mToken.getOpenId(), this.mToken.getAppId(), "ANDROIDSDK.SETAVATAR.XX", "12", "18", "0");
      return;
    }
    d.a().a(this.mToken.getOpenId(), this.mToken.getAppId(), "ANDROIDSDK.SETAVATAR.XX", "12", "18", "1");
  }
}
