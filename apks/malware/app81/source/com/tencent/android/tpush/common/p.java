package com.tencent.android.tpush.common;

import android.app.ActivityManager;
import android.app.ActivityManager.RunningServiceInfo;
import android.content.BroadcastReceiver;
import android.content.ComponentName;
import android.content.Context;
import android.content.Intent;
import android.content.pm.ActivityInfo;
import android.content.pm.PackageInfo;
import android.content.pm.PackageManager;
import com.tencent.android.tpush.XGPushActivity;
import com.tencent.android.tpush.XGPushBaseReceiver;
import com.tencent.android.tpush.XGPushReceiver;
import com.tencent.android.tpush.encrypt.Rijndael;
import com.tencent.android.tpush.logging.TLog;
import com.tencent.android.tpush.rpc.XGRemoteService;
import com.tencent.android.tpush.service.XGPushService;
import com.tencent.android.tpush.service.d.d;
import com.tencent.android.tpush.service.l;
import java.text.SimpleDateFormat;
import java.util.Iterator;
import java.util.List;

public class p
{
  private static boolean a = true;
  private static boolean b = false;
  
  public static String a(long paramLong)
  {
    try
    {
      String str = new SimpleDateFormat("yyyyMMdd").format(Long.valueOf(paramLong));
      return str;
    }
    catch (Exception localException)
    {
      TLog.e("TPush", "getDateString", localException);
    }
    return "20141111";
  }
  
  public static String a(Context paramContext)
  {
    if (paramContext != null) {
      return Rijndael.decrypt(d.e(paramContext, "tpush.running.service.name"));
    }
    return "";
  }
  
  private static void a(Context paramContext, String paramString)
  {
    if ((paramContext == null) || (paramString == null) || (paramString.trim().length() == 0)) {}
    PackageManager localPackageManager;
    do
    {
      do
      {
        return;
        localPackageManager = paramContext.getPackageManager();
      } while (localPackageManager == null);
      paramContext = new ComponentName(paramContext.getPackageName(), paramString);
    } while (localPackageManager.getComponentEnabledSetting(paramContext) == 1);
    TLog.i("TPush", "enableComponentIfNeeded >>> " + paramString + " is not enable status , try to enable it.");
    localPackageManager.setComponentEnabledSetting(paramContext, 1, 1);
  }
  
  public static boolean a()
  {
    return a;
  }
  
  public static boolean a(Context paramContext, BroadcastReceiver paramBroadcastReceiver)
  {
    TLog.v("XGService", "@@ safeUnregisterReceiver(" + paramContext + "," + paramBroadcastReceiver + ")");
    try
    {
      paramContext.unregisterReceiver(paramBroadcastReceiver);
      return true;
    }
    catch (Exception paramContext)
    {
      TLog.e("TPush", paramContext.getMessage());
    }
    return false;
  }
  
  public static boolean a(String paramString)
  {
    return (paramString == null) || (paramString.trim().length() == 0);
  }
  
  public static int b(Context paramContext)
  {
    if (paramContext != null) {
      try
      {
        Object localObject = ((ActivityManager)paramContext.getSystemService("activity")).getRunningServices(Integer.MAX_VALUE);
        if ((localObject != null) && (((List)localObject).size() > 0))
        {
          TLog.i("TPush", "getServiceStatus  runningServiceInfos.size():" + ((List)localObject).size());
          paramContext = XGPushService.class.getName();
          localObject = ((List)localObject).iterator();
          while (((Iterator)localObject).hasNext())
          {
            ActivityManager.RunningServiceInfo localRunningServiceInfo = (ActivityManager.RunningServiceInfo)((Iterator)localObject).next();
            if (paramContext.equals(localRunningServiceInfo.service.getClassName()))
            {
              int i = localRunningServiceInfo.pid;
              if (i != 0) {
                return 1;
              }
              return 2;
            }
          }
        }
      }
      catch (Throwable paramContext)
      {
        TLog.e("XGService", paramContext.getMessage());
      }
    }
    return 0;
  }
  
  public static void c(Context paramContext)
  {
    List localList;
    if (paramContext != null)
    {
      TLog.v("XGService", "@@ StartService()");
      l.b(paramContext.getApplicationContext());
      localList = d.a(paramContext);
      if ((localList != null) && (localList.size() != 0) && (!o.a(paramContext).a())) {
        break label69;
      }
      l.a(paramContext);
    }
    for (;;)
    {
      g.a().a(new q(paramContext), 1500L);
      return;
      label69:
      TLog.v("XGService", ">> StartService, local app size:" + localList.size());
      paramContext.sendBroadcast(new Intent("com.tencent.android.tpush.action.SDK"));
    }
  }
  
  public static String d(Context paramContext)
  {
    try
    {
      String str = paramContext.getPackageManager().getPackageInfo(paramContext.getPackageName(), 0).versionName;
      paramContext = str;
      if (str == null) {
        paramContext = "";
      }
      return paramContext;
    }
    catch (Throwable paramContext)
    {
      TLog.w("XGService", "get app versino error", paramContext);
    }
    return "";
  }
  
  public static void e(Context paramContext)
  {
    int i = 0;
    if (paramContext == null) {
      return;
    }
    if (!b) {}
    try
    {
      a(paramContext, XGPushService.class.getName());
      a(paramContext, XGPushActivity.class.getName());
      a(paramContext, XGRemoteService.class.getName());
      Object localObject = paramContext.getPackageName();
      localObject = paramContext.getPackageManager().getPackageInfo((String)localObject, 2).receivers;
      int j = localObject.length;
      if (i < j)
      {
        String str = localObject[i].name;
        Class localClass = paramContext.getClassLoader().loadClass(str);
        if ((XGPushBaseReceiver.class.isAssignableFrom(localClass)) || (localClass.getName().equals(XGPushReceiver.class.getName()))) {
          a(paramContext, str);
        }
      }
      else
      {
        a = false;
        localObject = d.a(paramContext, paramContext.getPackageName() + ".PUSH_ACTION");
        if ((localObject != null) && (((List)localObject).size() > 0)) {
          a = true;
        }
        if (!f(paramContext)) {
          TLog.e("TPush", "You should set com.tencent.android.tpush.XGPushActivity's property android:exported = true in the AndroidManifest.xml");
        }
        b = true;
        g(paramContext);
        return;
      }
    }
    catch (Exception localException)
    {
      for (;;)
      {
        TLog.w("TPush", localException.getMessage());
        continue;
        i += 1;
      }
    }
  }
  
  public static boolean f(Context paramContext)
  {
    try
    {
      ComponentName localComponentName = new ComponentName(paramContext.getPackageName(), XGPushActivity.class.getName());
      boolean bool = paramContext.getPackageManager().getActivityInfo(localComponentName, 0).exported;
      return bool;
    }
    catch (Throwable paramContext)
    {
      TLog.e("TPush", "checkActivityIsExported", paramContext);
    }
    return false;
  }
  
  private static void g(Context paramContext)
  {
    if (!a)
    {
      TLog.e("TPush", "[ERROR] Please add service:" + XGRemoteService.class.getName() + " on AndroidManifest.xml by using you current package:" + paramContext.getPackageName() + ".PUSH_ACTION");
      TLog.e("TPush", "You can refer to the wiki:http://xg.qq.com or AndroidManifest.xml on DEMO APP");
    }
  }
}
