package com.baidu.mobstat;

import android.content.Context;
import android.os.Handler;
import android.os.HandlerThread;
import android.support.v4.app.Fragment;
import java.lang.ref.WeakReference;
import java.lang.reflect.Method;
import java.util.HashMap;
import org.json.JSONException;
import org.json.JSONObject;

class ag
{
  static HashMap a = new HashMap();
  private static HandlerThread b = new HandlerThread("SessionAnalysisThread");
  private static Handler c;
  private static ag l = new ag();
  private long d = 0L;
  private long e = 0L;
  private long f = 0L;
  private long g = 0L;
  private WeakReference h;
  private WeakReference i;
  private WeakReference j;
  private ae k = new ae();
  private int m = -1;
  private boolean n = true;
  private boolean o = false;
  private boolean p = false;
  private boolean q = false;
  
  private ag()
  {
    b.start();
    b.setPriority(10);
    c = new Handler(b.getLooper());
  }
  
  static Context a(Object paramObject)
  {
    try
    {
      paramObject = (Context)paramObject.getClass().getMethod("getActivity", new Class[0]).invoke(paramObject, new Object[0]);
      return paramObject;
    }
    catch (Throwable paramObject)
    {
      au.a().a(new Object[] { paramObject.getMessage() });
    }
    return null;
  }
  
  private void a(Context paramContext)
  {
    if (paramContext == null)
    {
      au.a().a("statsdk", "clearLastSession(Context context):context=null");
      return;
    }
    ar.a(false, paramContext, "__local_last_session.json", "{}", false);
  }
  
  private void a(boolean paramBoolean)
  {
    this.n = paramBoolean;
  }
  
  public static ag b()
  {
    return l;
  }
  
  private void c(Context paramContext, long paramLong)
  {
    au.a().a("statsdk", "flush current session to last_session.json");
    new JSONObject();
    Object localObject = this.k.c();
    try
    {
      ((JSONObject)localObject).put("e", paramLong);
      localObject = ((JSONObject)localObject).toString();
      au.a().a("statsdk", "cacheString=" + (String)localObject);
      ar.a(false, paramContext, "__local_last_session.json", (String)localObject, false);
      return;
    }
    catch (JSONException localJSONException)
    {
      for (;;)
      {
        au.a().a("statsdk", "StatSession.flushSession() failed");
      }
    }
  }
  
  private boolean e()
  {
    return this.n;
  }
  
  public int a()
  {
    if (this.m == -1) {
      this.m = 30000;
    }
    return this.m;
  }
  
  public void a(int paramInt)
  {
    this.m = (paramInt * 1000);
  }
  
  public void a(Context paramContext, long paramLong)
  {
    au.a().a("statsdk", "AnalysisResume job");
    if (this.o) {
      au.a().c(new Object[] { "statsdk", "遗漏StatService.onPause() || missing StatService.onPause()" });
    }
    this.o = true;
    if (e())
    {
      au.a().a(new Object[] { "is_first_resume=true" });
      a(false);
      c.post(new ah(this));
    }
    for (;;)
    {
      an localAn = new an(this, this.d, paramLong, paramContext, null, null, 1);
      c.post(localAn);
      this.h = new WeakReference(paramContext);
      this.e = paramLong;
      return;
      au.a().a("statsdk", " is_first_resume=false");
    }
  }
  
  public void a(Context paramContext, long paramLong, String paramString)
  {
    a(paramString);
    au.a().a("statsdk", "AnalysisPageStart");
    if (b(paramString).b) {
      au.a().c(new Object[] { "statsdk", "遗漏StatService.onPageEnd() || missing StatService.onPageEnd()" });
    }
    b(paramString).b = true;
    b(paramString).c = paramLong;
    if (e())
    {
      au.a().a("PPPPPPPPPPPPP is_first_resume=true");
      a(false);
      c.post(new ai(this));
    }
    for (;;)
    {
      paramString = new an(this, this.d, paramLong, paramContext, null, null, 1);
      c.post(paramString);
      this.h = new WeakReference(paramContext);
      this.e = paramLong;
      return;
      au.a().a("statsdk", " is_first_resume=false");
    }
  }
  
  public void a(Fragment paramFragment, long paramLong)
  {
    au.a().a("statsdk", "post resume job");
    if (this.p) {
      au.a().c(new Object[] { "statsdk", "遗漏StatService.onPause() || missing StatService.onPause()" });
    }
    this.p = true;
    if (e())
    {
      au.a().a("statsdk", "is_first_resume=true");
      a(false);
      c.post(new aj(this));
    }
    for (;;)
    {
      an localAn = new an(this, this.d, paramLong, null, paramFragment, null, 2);
      c.post(localAn);
      this.i = new WeakReference(paramFragment);
      this.f = paramLong;
      return;
      au.a().a("statsdk", "is_first_resume=false");
    }
  }
  
  public void a(Object paramObject, long paramLong)
  {
    au.a().a("statsdk", "post resume job");
    if (this.q) {
      au.a().c(new Object[] { "statsdk", "遗漏StatService.onPause() || missing StatService.onPause()" });
    }
    this.q = true;
    if (e())
    {
      au.a().a("statsdk", "is_first_resume=true");
      a(false);
      c.post(new ak(this));
    }
    for (;;)
    {
      an localAn = new an(this, this.d, paramLong, null, null, paramObject, 3);
      c.post(localAn);
      this.j = new WeakReference(paramObject);
      this.g = paramLong;
      return;
      au.a().a("statsdk", "is_first_resume=false");
    }
  }
  
  void a(String paramString)
  {
    if (paramString == null) {
      au.a().c(new Object[] { "sdkstat", "page Object is null" });
    }
    al localAl;
    do
    {
      return;
      localAl = new al(this, paramString);
    } while (a.containsKey(paramString));
    a.put(paramString, localAl);
  }
  
  al b(String paramString)
  {
    if (paramString == null)
    {
      au.a().c(new Object[] { "sdkstat", "pageName is null" });
      return null;
    }
    if (!a.containsKey(paramString)) {
      a(paramString);
    }
    return (al)a.get(paramString);
  }
  
  public void b(Context paramContext, long paramLong)
  {
    au.a().a("statsdk", "post pause job");
    if (!this.o)
    {
      au.a().c(new Object[] { "statsdk", "遗漏StatService.onResume() || missing StatService.onResume()" });
      return;
    }
    this.o = false;
    paramContext = new am(this, paramLong, paramContext, null, this.e, (Context)this.h.get(), null, 1, null, null, null);
    c.post(paramContext);
    this.d = paramLong;
  }
  
  public void b(Context paramContext, long paramLong, String paramString)
  {
    au.a().a("statsdk", "post pause job");
    if (b(paramString) == null)
    {
      au.a().c(new Object[] { "statsdk", "自定义页面" + paramString + "没有优先调用或者遗漏，请检查确保在onPageEnd函数之前调用onPageStart函数" });
      return;
    }
    if (!b(paramString).b)
    {
      au.a().c(new Object[] { "statsdk", "Please check (1)遗漏StatService.onPageStart() || missing StatService.onPageStart()" });
      return;
    }
    b(paramString).b = false;
    b(paramString).d = paramLong;
    paramContext = new am(this, paramLong, paramContext, null, b(paramString).c, (Context)this.h.get(), null, 1, paramString, null, null);
    c.post(paramContext);
    this.d = paramLong;
  }
  
  public void b(Fragment paramFragment, long paramLong)
  {
    au.a().a("statsdk", "post pause job");
    if (!this.p)
    {
      au.a().c(new Object[] { "statsdk", "遗漏android.support.v4.app.Fragment StatService.onResume() || android.support.v4.app.Fragment missing StatService.onResume()" });
      return;
    }
    this.p = false;
    paramFragment = new am(this, paramLong, null, paramFragment, this.f, null, (Fragment)this.i.get(), 2, null, null, null);
    c.post(paramFragment);
    this.d = paramLong;
  }
  
  public void b(Object paramObject, long paramLong)
  {
    au.a().a("statsdk", "post pause job");
    if (!this.q)
    {
      au.a().c(new Object[] { "statsdk", "遗漏android.app.Fragment StatService.onResume() || android.app.Fragment missing StatService.onResume()" });
      return;
    }
    this.q = false;
    paramObject = new am(this, paramLong, null, null, this.g, null, null, 3, null, this.j.get(), paramObject);
    c.post(paramObject);
    this.d = paramLong;
  }
  
  public void c()
  {
    this.k.a(this.k.d() + 1);
  }
  
  void c(String paramString)
  {
    if (paramString == null) {
      au.a().c(new Object[] { "sdkstat", "pageName is null" });
    }
    while (!a.containsKey(paramString)) {
      return;
    }
    a.remove(paramString);
  }
  
  public long d()
  {
    return this.k.a();
  }
}
