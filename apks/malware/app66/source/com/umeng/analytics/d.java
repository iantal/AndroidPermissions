package com.umeng.analytics;

import android.content.Context;
import android.content.SharedPreferences;
import android.content.SharedPreferences.Editor;
import android.content.pm.PackageManager;
import android.os.Handler;
import android.os.HandlerThread;
import com.umeng.common.Log;
import com.umeng.common.b;
import java.io.BufferedReader;
import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.net.URLEncoder;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import org.apache.http.HttpEntity;
import org.apache.http.HttpHost;
import org.apache.http.HttpResponse;
import org.apache.http.StatusLine;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.HttpClient;
import org.apache.http.client.entity.UrlEncodedFormEntity;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.entity.InputStreamEntity;
import org.apache.http.impl.client.DefaultHttpClient;
import org.apache.http.message.BasicNameValuePair;
import org.apache.http.params.BasicHttpParams;
import org.apache.http.params.HttpConnectionParams;
import org.apache.http.params.HttpParams;
import org.json.JSONObject;

public abstract class d
  implements i, com.umeng.analytics.onlineconfig.c
{
  private final a a = new a();
  private final Object b = new Object();
  private final Handler c;
  protected final c d = new c();
  protected final com.umeng.analytics.a.f e = new com.umeng.analytics.a.f();
  protected final int f = 1;
  protected final int g = 2;
  protected final int h = 3;
  protected final int i = 4;
  protected final int j = 5;
  String k = null;
  String l = null;
  private final String m = "body";
  private final String n = "header";
  private int o = -1;
  private long p = -1L;
  private long q = -1L;
  private long r = -1L;
  private boolean s = false;
  
  public d()
  {
    HandlerThread localHandlerThread = new HandlerThread("MobclickAgent");
    localHandlerThread.start();
    this.c = new Handler(localHandlerThread.getLooper());
  }
  
  private String a(Context paramContext, JSONObject paramJSONObject, String paramString)
  {
    HttpPost localHttpPost = new HttpPost(paramString);
    Object localObject = new BasicHttpParams();
    HttpConnectionParams.setConnectionTimeout((HttpParams)localObject, 10000);
    HttpConnectionParams.setSoTimeout((HttpParams)localObject, 30000);
    localObject = new DefaultHttpClient((HttpParams)localObject);
    localHttpPost.addHeader("X-Umeng-Sdk", c(paramContext));
    try
    {
      paramContext = h.a(paramContext);
      if (paramContext != null)
      {
        paramContext = new HttpHost(paramContext, 80);
        ((HttpClient)localObject).getParams().setParameter("http.route.default-proxy", paramContext);
      }
      paramContext = paramJSONObject.toString();
      Log.a("MobclickAgent", paramContext);
      if (g.t)
      {
        paramContext = com.umeng.common.util.f.a("content=" + paramContext, "utf-8");
        localHttpPost.addHeader("Content-Encoding", "deflate");
        localHttpPost.setEntity(new InputStreamEntity(new ByteArrayInputStream(paramContext), com.umeng.common.util.f.a));
      }
      for (;;)
      {
        paramContext = new Date();
        paramJSONObject = ((HttpClient)localObject).execute(localHttpPost);
        this.r = (new Date().getTime() - paramContext.getTime());
        if (paramJSONObject.getStatusLine().getStatusCode() != 200) {
          break;
        }
        Log.a("MobclickAgent", "Sent message to " + paramString);
        paramContext = paramJSONObject.getEntity();
        if (paramContext == null) {
          break;
        }
        return a(paramContext.getContent());
        paramJSONObject = new ArrayList(1);
        paramJSONObject.add(new BasicNameValuePair("content", paramContext));
        localHttpPost.setEntity(new UrlEncodedFormEntity(paramJSONObject, "UTF-8"));
      }
      return null;
    }
    catch (ClientProtocolException paramContext)
    {
      Log.b("MobclickAgent", "ClientProtocolException,Failed to send message.", paramContext);
      return null;
    }
    catch (IOException paramContext)
    {
      Log.b("MobclickAgent", "IOException,Failed to send message.", paramContext);
    }
  }
  
  private String a(InputStream paramInputStream)
  {
    BufferedReader localBufferedReader = new BufferedReader(new InputStreamReader(paramInputStream), 64);
    StringBuilder localStringBuilder = new StringBuilder();
    try
    {
      for (;;)
      {
        String str = localBufferedReader.readLine();
        if (str == null) {
          break;
        }
        localStringBuilder.append(str + "\n");
      }
      return null;
    }
    catch (IOException localIOException)
    {
      Log.b("MobclickAgent", "Caught IOException in convertStreamToString()", localIOException);
      for (;;)
      {
        try
        {
          paramInputStream.close();
          return null;
        }
        catch (IOException paramInputStream)
        {
          Log.b("MobclickAgent", "Caught IOException in convertStreamToString()", paramInputStream);
          return null;
        }
        try
        {
          paramInputStream.close();
          return localStringBuilder.toString();
        }
        catch (IOException paramInputStream)
        {
          Log.b("MobclickAgent", "Caught IOException in convertStreamToString()", paramInputStream);
          return null;
        }
      }
    }
    finally
    {
      try
      {
        paramInputStream.close();
        throw localObject;
      }
      catch (IOException paramInputStream)
      {
        Log.b("MobclickAgent", "Caught IOException in convertStreamToString()", paramInputStream);
      }
    }
  }
  
  private void a(Context paramContext)
  {
    if (this.o != -1) {}
    do
    {
      return;
      int[] arrayOfInt = j.i(paramContext);
      this.o = arrayOfInt[0];
      this.p = arrayOfInt[1];
    } while ((this.o != 4) && (this.o != 6));
    this.q = j.e(paramContext).getLong("last_report_time", -1L);
  }
  
  private void b(Context paramContext)
  {
    if ((this.o == 6) || (this.o == 4)) {
      j.e(paramContext).edit().putLong("last_report_time", this.q).commit();
    }
    if (this.r != -1L)
    {
      this.e.f = this.r;
      j.c(paramContext).edit().putLong("req_time", this.r).commit();
    }
  }
  
  private String c(Context paramContext)
  {
    if (!this.e.b()) {
      this.e.b(paramContext, new String[] { this.l, this.k });
    }
    StringBuffer localStringBuffer1 = new StringBuffer();
    localStringBuffer1.append(this.e.w);
    localStringBuffer1.append("/");
    localStringBuffer1.append(this.e.x);
    localStringBuffer1.append(" ");
    try
    {
      StringBuffer localStringBuffer2 = new StringBuffer();
      localStringBuffer2.append(paramContext.getPackageManager().getApplicationLabel(paramContext.getApplicationInfo()).toString());
      localStringBuffer2.append("/");
      localStringBuffer2.append(this.e.t);
      localStringBuffer2.append(" ");
      localStringBuffer2.append(this.e.g);
      localStringBuffer2.append("/");
      localStringBuffer2.append(this.e.i);
      localStringBuffer2.append(" ");
      localStringBuffer2.append(this.e.d);
      localStringBuffer1.append(URLEncoder.encode(localStringBuffer2.toString(), "UTF-8"));
      return localStringBuffer1.toString();
    }
    catch (Exception paramContext)
    {
      for (;;)
      {
        paramContext.printStackTrace();
      }
    }
  }
  
  private void d(Context paramContext)
  {
    JSONObject localJSONObject = g(paramContext);
    if ((localJSONObject == null) || (localJSONObject.isNull("body"))) {
      return;
    }
    String str = null;
    int i1 = 0;
    if (i1 < g.r.length)
    {
      str = a(paramContext, localJSONObject, g.r[i1]);
      if (str == null) {}
    }
    else
    {
      if (str == null) {
        break label98;
      }
      j.j(paramContext);
      Log.a("MobclickAgent", "send applog succeed :" + str);
    }
    for (;;)
    {
      b(paramContext);
      return;
      i1 += 1;
      break;
      label98:
      this.q = -1L;
      j.b(paramContext, localJSONObject, b.d(paramContext));
      Log.a("MobclickAgent", "send applog failed");
    }
  }
  
  public void a(int paramInt, long paramLong)
  {
    this.o = paramInt;
    this.p = paramLong;
  }
  
  /* Error */
  public void a(Context paramContext, int paramInt)
  {
    // Byte code:
    //   0: aload_0
    //   1: monitorenter
    //   2: aload_0
    //   3: getfield 91	com/umeng/analytics/d:s	Z
    //   6: ifne +23 -> 29
    //   9: iload_2
    //   10: iconst_4
    //   11: if_icmpne +18 -> 29
    //   14: aload_0
    //   15: aload_1
    //   16: invokespecial 447	com/umeng/analytics/d:a	(Landroid/content/Context;)V
    //   19: aload_0
    //   20: aload_1
    //   21: invokevirtual 449	com/umeng/analytics/d:f	(Landroid/content/Context;)V
    //   24: aload_0
    //   25: iconst_1
    //   26: putfield 91	com/umeng/analytics/d:s	Z
    //   29: iload_2
    //   30: iconst_5
    //   31: if_icmpne +14 -> 45
    //   34: aload_0
    //   35: getfield 52	com/umeng/analytics/d:d	Lcom/umeng/analytics/c;
    //   38: aload_1
    //   39: invokevirtual 450	com/umeng/analytics/c:a	(Landroid/content/Context;)V
    //   42: aload_0
    //   43: monitorexit
    //   44: return
    //   45: aload_0
    //   46: aload_1
    //   47: iload_2
    //   48: invokevirtual 453	com/umeng/analytics/d:b	(Landroid/content/Context;I)Z
    //   51: ifeq +20 -> 71
    //   54: aload_0
    //   55: getfield 112	com/umeng/analytics/d:c	Landroid/os/Handler;
    //   58: new 455	com/umeng/analytics/d$b
    //   61: dup
    //   62: aload_0
    //   63: aload_1
    //   64: invokespecial 457	com/umeng/analytics/d$b:<init>	(Lcom/umeng/analytics/d;Landroid/content/Context;)V
    //   67: invokevirtual 461	android/os/Handler:post	(Ljava/lang/Runnable;)Z
    //   70: pop
    //   71: aload_0
    //   72: getfield 52	com/umeng/analytics/d:d	Lcom/umeng/analytics/c;
    //   75: invokevirtual 462	com/umeng/analytics/c:b	()Z
    //   78: ifeq -36 -> 42
    //   81: aload_0
    //   82: getfield 112	com/umeng/analytics/d:c	Landroid/os/Handler;
    //   85: new 464	com/umeng/analytics/d$a
    //   88: dup
    //   89: aload_0
    //   90: aload_1
    //   91: invokespecial 465	com/umeng/analytics/d$a:<init>	(Lcom/umeng/analytics/d;Landroid/content/Context;)V
    //   94: invokevirtual 461	android/os/Handler:post	(Ljava/lang/Runnable;)Z
    //   97: pop
    //   98: goto -56 -> 42
    //   101: astore_1
    //   102: aload_0
    //   103: monitorexit
    //   104: aload_1
    //   105: athrow
    // Local variable table:
    //   start	length	slot	name	signature
    //   0	106	0	this	d
    //   0	106	1	paramContext	Context
    //   0	106	2	paramInt	int
    // Exception table:
    //   from	to	target	type
    //   2	9	101	finally
    //   14	29	101	finally
    //   34	42	101	finally
    //   45	71	101	finally
    //   71	98	101	finally
  }
  
  boolean b(Context paramContext, int paramInt)
  {
    if (!b.n(paramContext)) {}
    do
    {
      return false;
      switch (paramInt)
      {
      case 3: 
      default: 
        return false;
      case 1: 
      case 4: 
        while (this.o == 0)
        {
          return true;
          if (this.o == 1) {
            return true;
          }
        }
        if ((this.o == 6) && (System.currentTimeMillis() - this.q > this.p))
        {
          this.q = System.currentTimeMillis();
          return true;
        }
        if ((this.o == 4) && (System.currentTimeMillis() - this.q > g.g))
        {
          this.q = System.currentTimeMillis();
          return true;
        }
        break;
      }
    } while ((this.o != 5) || (!b.l(paramContext)));
    return true;
    return true;
  }
  
  public void e(Context paramContext)
  {
    a(paramContext, 1);
  }
  
  public void f(Context paramContext)
  {
    this.a.a(paramContext);
    this.a.a(this);
  }
  
  JSONObject g(Context paramContext)
  {
    JSONObject localJSONObject = new JSONObject();
    try
    {
      if (!this.e.b()) {
        this.e.b(paramContext, new String[] { this.l, this.k });
      }
      if (!this.e.a())
      {
        Log.b("MobclickAgent", "protocol Header need Appkey or Device ID ,Please check AndroidManifest.xml ");
        return null;
      }
      this.d.b(paramContext);
      if (this.d.a() <= 0)
      {
        Log.c("MobclickAgent", "no message to send");
        return null;
      }
    }
    catch (Exception localException)
    {
      Log.b("MobclickAgent", "", localException);
      j.j(paramContext);
      return null;
      if (!this.d.c()) {
        throw new Exception("protocol Body has invalid field: " + this.d.d().toString());
      }
    }
    catch (Error localError)
    {
      Log.b("MobclickAgent", "Error:" + localError.getMessage());
      j.j(paramContext);
      return null;
    }
    localError.put("header", new e(this));
    localError.put("body", this.d.d());
    this.d.e();
    return localError;
  }
}
