package com.urbanairship.push.c2dm;

import android.app.PendingIntent;
import android.content.Context;
import android.content.Intent;
import android.content.pm.PackageManager;
import android.content.pm.PackageManager.NameNotFoundException;
import android.os.Build.VERSION;
import com.urbanairship.AirshipConfigOptions;
import com.urbanairship.Logger;
import com.urbanairship.UAirship;
import com.urbanairship.push.PushManager;
import com.urbanairship.push.PushPreferences;
import com.urbanairship.push.embedded.BoxOfficeClient;
import com.urbanairship.push.embedded.BoxOfficeClient.BoxOfficeException;
import com.urbanairship.push.embedded.BoxOfficeClient.FirstRunForbiddenException;
import com.urbanairship.restclient.AsyncHandler;
import com.urbanairship.restclient.Request;
import com.urbanairship.restclient.Response;
import java.io.UnsupportedEncodingException;
import java.util.UUID;
import org.apache.http.entity.StringEntity;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

public class C2DMPushManager
{
  private static final String INTENT_REGISTER = "com.google.android.c2dm.intent.REGISTER";
  private static final String INTENT_UNREGISTER = "com.google.android.c2dm.intent.UNREGISTER";
  private static final long MAX_BACKOFF_TIME = 5120000L;
  public static final String PERMISSION_RECEIVE = "com.google.android.c2dm.permission.RECEIVE";
  private static long backoffTime = 10000L;
  public static final C2DMPushManager instance = new C2DMPushManager();
  private static PackageManager packageManager = null;
  
  private C2DMPushManager() {}
  
  public static void init()
  {
    Logger.info("Initializing C2DM Push ...");
    if (!isPermissionKnown("com.google.android.c2dm.permission.RECEIVE"))
    {
      Logger.error("com.google.android.c2dm.permission.RECEIVE is unknown to PackageManager. Note that an AVD emulator may not support C2DM.");
      Logger.error("If you're running in an emulator, you need to install the appropriate image through the Android SDK and AVM manager. See http://code.google.com/android/c2dm/ for further details.");
      return;
    }
    if (Build.VERSION.SDK_INT < 8)
    {
      Logger.debug("C2DM not supported in API level " + Build.VERSION.SDK_INT);
      PushManager.shared().c2dmRegistrationFailed("PHONE_REGISTRATION_ERROR");
      return;
    }
    PushPreferences localPushPreferences = PushManager.shared().getPreferences();
    if (localPushPreferences.getC2DMId() == null)
    {
      register();
      return;
    }
    Logger.info("Using C2DM ID: " + localPushPreferences.getC2DMId());
    PushManager.shared().updateApidIfNecessary();
  }
  
  public static boolean isPermissionKnown(String paramString)
  {
    PackageManager localPackageManager2 = packageManager;
    PackageManager localPackageManager1 = localPackageManager2;
    if (localPackageManager2 == null) {
      localPackageManager1 = UAirship.getPackageManager();
    }
    try
    {
      localPackageManager1.getPermissionInfo(paramString, 0);
      return true;
    }
    catch (PackageManager.NameNotFoundException paramString) {}
    return false;
  }
  
  public static void register()
  {
    register(0L);
  }
  
  public static void register(long paramLong)
  {
    new Thread()
    {
      public void run()
      {
        try
        {
          Thread.sleep(this.val$delay);
          Context localContext = UAirship.shared().getApplicationContext();
          str = UAirship.shared().getAirshipConfigOptions().c2dmSender;
          if (str == null)
          {
            Logger.error("The C2DM sender email is not set. Unable to register.");
            return;
          }
        }
        catch (InterruptedException localInterruptedException)
        {
          String str;
          for (;;)
          {
            Logger.error(localInterruptedException);
          }
          if (PushManager.shared().getPreferences().getPushSecret() == null) {}
          try
          {
            new BoxOfficeClient().firstRun();
            Intent localIntent = new Intent("com.google.android.c2dm.intent.REGISTER");
            localIntent.putExtra("app", PendingIntent.getBroadcast(localInterruptedException, 0, new Intent(), 0));
            localIntent.putExtra("sender", str);
            localInterruptedException.startService(localIntent);
            Logger.info("Sent C2DM registration, sender: " + str);
            return;
          }
          catch (BoxOfficeClient.FirstRunForbiddenException localFirstRunForbiddenException)
          {
            Logger.error(localFirstRunForbiddenException);
            PushManager.stopService();
            return;
          }
          catch (BoxOfficeClient.BoxOfficeException localBoxOfficeException)
          {
            Logger.error("Firstrun failed, will retry. Error: " + localBoxOfficeException.getMessage());
            C2DMPushManager.retryRegistration();
          }
        }
      }
    }.start();
  }
  
  public static void retryRegistration()
  {
    register(backoffTime);
    backoffTime *= 2L;
    if (backoffTime > 5120000L) {
      backoffTime = 5120000L;
    }
  }
  
  public static void sendTestPush(String paramString1, String paramString2)
  {
    Logger.info("Attempting to send a test C2DM push");
    Object localObject = new JSONObject();
    JSONObject localJSONObject1 = new JSONObject();
    JSONObject localJSONObject2 = new JSONObject();
    JSONArray localJSONArray = new JSONArray();
    localJSONArray.put(PushManager.shared().getPreferences().getPushId());
    String str = UUID.randomUUID().toString();
    try
    {
      localJSONObject1.put("alert", paramString2);
      localJSONObject2.put("id", str);
      localJSONObject1.put("extra", localJSONObject2);
      ((JSONObject)localObject).put("apids", localJSONArray);
      ((JSONObject)localObject).put("android", localJSONObject1);
      paramString2 = ((JSONObject)localObject).toString(0);
      localObject = UAirship.shared().getAirshipConfigOptions().hostURL;
      localObject = new Request("POST", (String)localObject + "api/push/");
      ((Request)localObject).setAuth(UAirship.shared().getAirshipConfigOptions().developmentAppKey, paramString1);
      ((Request)localObject).addHeader("Content-Type", "application/json");
      return;
    }
    catch (JSONException paramString1)
    {
      try
      {
        ((Request)localObject).setEntity(new StringEntity(paramString2));
        ((Request)localObject).executeAsync(new AsyncHandler()
        {
          public void onComplete(Response paramAnonymousResponse)
          {
            if (paramAnonymousResponse.status() == 200)
            {
              Logger.info("C2DM Push" + this.val$id + " sent");
              return;
            }
            Logger.error("C2DM Push Failed!  Status: " + paramAnonymousResponse.status());
          }
          
          public void onError(Exception paramAnonymousException)
          {
            Logger.error("Couldn't create C2DM Push!");
          }
        });
        return;
      }
      catch (UnsupportedEncodingException paramString1)
      {
        Logger.error(paramString1);
      }
      paramString1 = paramString1;
      Logger.error("Couldn't serialize JSON for C2DM push!", paramString1);
      return;
    }
  }
  
  public static C2DMPushManager shared()
  {
    return instance;
  }
  
  public static void unregister()
  {
    Context localContext = UAirship.shared().getApplicationContext();
    Intent localIntent = new Intent("com.google.android.c2dm.intent.UNREGISTER");
    localIntent.putExtra("app", PendingIntent.getBroadcast(localContext, 0, new Intent(), 0));
    UAirship.shared().getApplicationContext().startService(localIntent);
  }
  
  public static void usePackageManager(PackageManager paramPackageManager)
  {
    packageManager = paramPackageManager;
  }
}
