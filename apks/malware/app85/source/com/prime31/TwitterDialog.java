package com.prime31;

import android.app.Dialog;
import android.app.ProgressDialog;
import android.content.Context;
import android.graphics.Bitmap;
import android.graphics.Typeface;
import android.os.Bundle;
import android.util.Log;
import android.view.ViewGroup.LayoutParams;
import android.webkit.WebSettings;
import android.webkit.WebView;
import android.webkit.WebViewClient;
import android.widget.FrameLayout;
import android.widget.FrameLayout.LayoutParams;
import android.widget.TextView;

public class TwitterDialog
  extends Dialog
{
  static final float[] DIMENSIONS_LANDSCAPE = { 460.0F, 260.0F };
  static final float[] DIMENSIONS_PORTRAIT = { 280.0F, 420.0F };
  static final FrameLayout.LayoutParams FILL = new FrameLayout.LayoutParams(-1, -1);
  static final int MARGIN = 4;
  static final int PADDING = 2;
  private static final String TAG = "Prime31-TD";
  private FrameLayout _content;
  private DialogListener _listener;
  private ProgressDialog _spinner;
  private TextView _title;
  private String _url;
  private WebView _webView;
  
  public TwitterDialog(Context paramContext, String paramString, DialogListener paramDialogListener)
  {
    super(paramContext);
    this._url = paramString;
    this._listener = paramDialogListener;
  }
  
  private void setUpTitle()
  {
    requestWindowFeature(1);
    this._title = new TextView(getContext());
    this._title.setText("Twitter");
    this._title.setTextColor(-1);
    this._title.setTypeface(Typeface.DEFAULT_BOLD);
    this._title.setBackgroundColor(-4466711);
    this._title.setPadding(6, 4, 4, 4);
    this._title.setCompoundDrawablePadding(6);
    this._content.addView(this._title);
  }
  
  private void setUpWebView()
  {
    this._webView = new WebView(getContext());
    this._webView.setVerticalScrollBarEnabled(false);
    this._webView.setHorizontalScrollBarEnabled(false);
    this._webView.setWebViewClient(new TwitterWebViewClient(null));
    this._webView.getSettings().setJavaScriptEnabled(true);
    this._webView.loadUrl(this._url);
    this._webView.setLayoutParams(FILL);
    this._webView.setVisibility(4);
    this._content.addView(this._webView);
  }
  
  protected void onCreate(Bundle paramBundle)
  {
    super.onCreate(paramBundle);
    this._spinner = new ProgressDialog(getContext());
    this._spinner.requestWindowFeature(1);
    this._spinner.setMessage("Loading...");
    this._content = new FrameLayout(getContext());
    setUpTitle();
    setUpWebView();
    addContentView(this._content, new ViewGroup.LayoutParams(-1, -1));
    this._content.setVisibility(4);
  }
  
  public static abstract interface DialogListener
  {
    public abstract void onComplete(String paramString);
    
    public abstract void onError(String paramString);
  }
  
  private class TwitterWebViewClient
    extends WebViewClient
  {
    private TwitterWebViewClient() {}
    
    public void onPageFinished(WebView paramWebView, String paramString)
    {
      super.onPageFinished(paramWebView, paramString);
      paramWebView = TwitterDialog.this._webView.getTitle();
      if ((paramWebView != null) && (paramWebView.length() > 0)) {
        TwitterDialog.this._title.setText(paramWebView);
      }
      TwitterDialog.this._spinner.dismiss();
      TwitterDialog.this._content.setBackgroundColor(0);
      TwitterDialog.this._content.setVisibility(0);
      TwitterDialog.this._webView.setVisibility(0);
    }
    
    public void onPageStarted(WebView paramWebView, String paramString, Bitmap paramBitmap)
    {
      Log.d("Prime31-TD", "Loading URL: " + paramString);
      super.onPageStarted(paramWebView, paramString, paramBitmap);
      TwitterDialog.this._spinner.show();
      TwitterDialog.this._content.setVisibility(4);
    }
    
    public void onReceivedError(WebView paramWebView, int paramInt, String paramString1, String paramString2)
    {
      super.onReceivedError(paramWebView, paramInt, paramString1, paramString2);
      Log.d("Prime31-TD", "Page error: " + paramString1);
      TwitterDialog.this._listener.onError(paramString1);
      TwitterDialog.this.dismiss();
    }
    
    public boolean shouldOverrideUrlLoading(WebView paramWebView, String paramString)
    {
      Log.d("Prime31-TD", "Redirect URL " + paramString);
      if (paramString.startsWith("twitterplugin"))
      {
        Log.d("Prime31-TD", "found our redirect url. getting out of here and dismissing web view");
        TwitterDialog.this._listener.onComplete(paramString);
        TwitterDialog.this.dismiss();
      }
      while (!paramString.startsWith("authorize")) {
        return true;
      }
      return false;
    }
  }
}
