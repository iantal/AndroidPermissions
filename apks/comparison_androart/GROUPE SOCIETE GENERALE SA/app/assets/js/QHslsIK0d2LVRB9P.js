Class.ns("Bankingapp.functions.receivemoney.splitthebill");$().loadJavaScript("/js/1hyf9OWY93mTBudZ.js");$().loadJavaScript("/js/IKqUtneuHWrtYhbp.js");$().loadJavaScript("/js/CF0WiFs1SjIy0Szl.js");$().loadJavaScript("/js/0A4YRnFx1DbUd3zN.js");Bankingapp.functions.receivemoney.splitthebill.Forecast=Class.extend(Bankingapp.framework.View,{container:null,formData:null,signBlock:null,groupcontainer:null,splitPartners:null,showProgressIndicator:true,progressIndicatorStepCount:3,progressIndicatorCurrentStep:2,dateFormatPattern:resolve("bankingapp_common_dateFormatPattern_per"),layoutRender:function(){this.container=$("<div>",{id:"forecastCt","class":"maincontainer internaltransfer transactiondetails"});if(this.showProgressIndicator){this.container.append(new Bankingapp.ui.ProgressIndicator(this.progressIndicatorStepCount,this.progressIndicatorCurrentStep));}this.groupcontainer=$("<div>",{"class":"paymentdetail groupcontainer"});return this.container;},errorMessageHandler:function(b,a){this.signBlock.remove();this.addSignBlock();Bankingapp.framework.event.ServiceMessageHandler.errorMessageHandler(b,a);},run:function(){Bankingapp.framework.Application.unBind("onErrorMessageReceived");$("body").bind("onErrorMessageReceived",$.proxy(this.errorMessageHandler,this));Bankingapp.framework.event.BrdServiceMessageHandler.handleMessages();var e=getFunctionAttribute(Functions.transferfunds.TransferUtils.SPLITBILL_FORECAST_REPLY);this.formData=getFunctionAttribute(Functions.transferfunds.TransferUtils.SPLITBILL_FORMDATA);debugLog("FormData: "+JSON.stringify(this.formData));this.splitPartners=getFunctionAttribute("splitPartners");debugLog("splitPartners: "+JSON.stringify(this.splitPartners));var d=0;for(var c=0;c<this.splitPartners.length;++c){d+=this.splitPartners[c].amount;}var b="";if(this.splitPartners.length==1){b="bankingapp_brd_function_splitbill_forecast_one_partner_title";}else{b="bankingapp_brd_function_splitbill_forecast_partner_title";}this.container.append(new Bankingapp.functions.util.component.TransactionSummary({summaryData:{titleInfo:resolve("bankingapp_brd_function_requestmoney_please_confirm"),upperTitle:this.formData.transactionItem.customerAccountName+" ("+this.formData.transactionItem.currency+")",upperText:"",amount:d,currency:this.formData.transactionItem.currency,lowerTitle:resolve("bankingapp_brd_function_splitbill_forecast_amount_title",{currency:this.formData.transactionItem.currency,amount:this.formData.transactionItem.amount}),lowerText:(resolve(b,{number:this.splitPartners.length})),creditDebitFlag:"C"}}));for(var c=0;c<this.splitPartners.length;++c){this.groupcontainer.append(new Bankingapp.ui.OutputField(resolve("bankingapp_brd_function_splitbill_forecast_partner",{number:(c+1)}),this.splitPartners[c].partnerName+" ("+this.formData.transactionItem.currency+" "+this.splitPartners[c].amount.toFixed(2)+")"));}this.groupcontainer.append(new Bankingapp.ui.OutputField(resolve("bankingapp_brd_function_requestmoney_partnerselect_description_field"),getFunctionAttribute("SPLITBILL_FORMDATA_DESCRIPTION")));var a=getFunctionAttribute("SPLITBILL_FORMDATA_VALUEDATE")?$().dateParserWithTimezone(getFunctionAttribute("SPLITBILL_FORMDATA_VALUEDATE")):new Date();this.groupcontainer.append(new Bankingapp.ui.OutputField(resolve("bankingapp_function_transferfunds_valuedate"),a.dateFormat(this.dateFormatPattern)));this.container.append(this.groupcontainer);this.addSignBlock();},addSignBlock:function(){this.signBlock=new Bankingapp.ui.BrdSignBlock({signMode:Functions.transferfunds.TransferUtils.SIGNMODE,tokenSubmitResourceKey:"bankingapp_function_transferfunds_signtransaction",submitButtonResourceKey:"bankingapp_function_transferfunds_signtransaction",fingerprintDisabled:true});this.signBlock.bind("formSubmitted",$.proxy(this.submitHandler,this));this.container.append(this.signBlock);},submitHandler:function(){if(this.signBlock.getCredential()==""||this.signBlock.getCredential()==undefined||this.signBlock.getCredential()==null){this.signBlock.remove();this.addSignBlock();}else{setFunctionAttribute(Functions.transferfunds.TransferUtils.SPLITBILL_SIGN_CREDENTIAL,this.signBlock.getCredential());Bankingapp.framework.Application.callService("/splitbilltransfer/perform",{PerformTransactionOperationRequest:{credential:getFunctionAttribute(Functions.transferfunds.TransferUtils.SPLITBILL_SIGN_CREDENTIAL),book:true,sign:true,fingerPrint:this.signBlock.getIsFingerprint()}},$.proxy(this.handleSignResult,this));}},handleSignResult:function(a){setFunctionAttribute(Functions.transferfunds.TransferUtils.SPLITBILL_SIGN_REPLY,a);loadView("view://brd/bankingapp/function/receivemoney/splitthebill/result",null);}});Bankingapp.framework.Application.setView(Bankingapp.functions.receivemoney.splitthebill.Forecast);