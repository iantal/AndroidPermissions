$().loadJavaScript("/js/cNGJpPRjrlEySoCA.js");$().loadJavaScript("/js/1hyf9OWY93mTBudZ.js");Class.ns("Functions.transferfunds.internationaltransfer");Functions.transferfunds.internationaltransfer.TransferDetails=Class.extend(Bankingapp.framework.View,{container:null,containerId:"internationalTransferDetailsMainContainer",containerClass:"internationaltransfer maincontainer",showProgressIndicator:true,progressIndicatorStepCount:Functions.transferfunds.TransferUtils.INTERNATIONALTRANSFER_STEPCOUNT,progressIndicatorCurrentStep:3,showPageInstructions:true,pageInstructionsClass:"pagetitle separator",pageInstructionsResourceKey:"bankingapp_function_transferfunds_detailsinstructions",form:null,formId:"transferDetailsForm",formClass:"transfer-details-form",groupContainer:null,groupContainerClass:"groupcontainer",valueDateButton:null,formData:null,forecastRequest:null,currency:null,amountField:null,descriptionField:null,cuiCnpField:null,referenceField:null,feeType:null,formChecked:false,layoutRender:function(){debugLog("international transfer, transferDetails, layoutRender ...");this.formData=getFunctionAttribute(Functions.transferfunds.TransferUtils.INTERNATIONALTRANSFER_FORMDATA);this.container=$("<div>",{id:this.containerId,"class":this.containerClass});this.container.append(new Bankingapp.ui.ProgressIndicator(this.progressIndicatorStepCount,this.progressIndicatorCurrentStep));this.container.append(new Bankingapp.ui.Label(resolve(this.pageInstructionsResourceKey),{"class":this.pageInstructionsClass}));this.form=new Bankingapp.ui.Form({id:this.formId,submitHandler:$.proxy(this.submitHandler,this),businessValidationHandler:$.proxy(this.businessValidator,this),"class":this.formClass});this.groupContainer1=$("<div>",{"class":this.groupContainerClass});this.groupContainer2=$("<div>",{"class":""});this.groupContainer3=$("<div>",{"class":this.groupContainerClass});this.form.append(this.groupContainer1);this.form.append(this.groupContainer2);this.form.append(this.groupContainer3);this.container.append(this.form);var b=this.getCurrencyData();this.currency=new Bankingapp.ui.InputField({labelText:resolve("bankingapp_function_internationaltransfer_currency"),inputRenderer:Bankingapp.ui.SelectButton,inputConfig:{id:"currencySelect",value:null,emptyString:resolve("bankingapp_function_internationaltransfer_select"),popupName:"Currency",datas:b},baseInputContainerClass:"selectComboContainer combo inputfirst"});this.currency.getInputComponent().bind("afterSelect",$.proxy(this.afterSelectCurrency,this));this.currency.setValue(b[0]);if(b.length==1){this.currency.disable();}this.groupContainer1.append(this.currency);this.amountField=new Bankingapp.ui.InputField(resolve("bankingapp_function_internationaltransfer_amount"),{id:"amount",name:"amount",type:Functions.transferfunds.TransferUtils.getAmountInputFieldType(),value:(this.formData.amount?this.formData.amount:""),inputMaskPattern:/[0-9.,\+\-]/,validation:{whitelist:false,required:true,min:0,max:999999999999,number:true,maxlength:12}});this.groupContainer1.append(this.amountField);debugLog("target account: "+this.formData.targetAccount);var a=this.formData.targetAccount.indexOf("TREZ")!=-1;if(a){this.descriptionField=new Bankingapp.ui.InputField(resolve("bankingapp_function_internationaltransfer_description"),{id:"description",name:"description",type:"text",value:(this.formData.description?this.formData.description:""),validation:{whitelist:false,maxlength:140}});}else{this.descriptionField=new Bankingapp.ui.InputField(resolve("bankingapp_function_internationaltransfer_description"),{id:"description",name:"description",type:"text",value:(this.formData.description?this.formData.description:""),validation:{whitelist:false,maxlength:200}});}this.groupContainer3.append(this.descriptionField);var c=new Date();this.valueDateButton=new Bankingapp.ui.ComplexButton([c.dateFormat(resolve("bankingapp_common_dateFormatPattern_per"))],{id:"valueDateButton","class":"calendar"});this.valueDateButton.bind("buttonClick",$.proxy(this.valueDateButtonClickHandler,this));this.groupContainer3.append(new Bankingapp.ui.LabeledComponent({labelText:resolve("bankingapp_function_transferfunds_valuedate"),valueComponent:this.valueDateButton}));if(Functions.transferfunds.TransferUtils.isCorporateUser()){$.Validation.setResource("whitelist","bankingapp_error_referencenumber_notvalid");$.Validation.setResource("required","bankingapp_error_referencenumber_empty");this.referenceField=new Bankingapp.ui.InputField(resolve("bankingapp_function_internationaltransfer_reference"),{id:"reference",name:"reference",type:"text",value:(this.formData.referenceNumber?this.formData.referenceNumber:""),validation:{whitelist:true,required:true,maxlength:Functions.transferfunds.TransferUtils.REFERENCE_FIELD_MAXLENGTH}});this.groupContainer3.append(this.referenceField);}this.feeType=new Bankingapp.ui.InputField({labelText:resolve("bankingapp_function_internationaltransfer_feetype"),inputRenderer:Bankingapp.ui.SelectButton,inputConfig:{id:"feeTypeSelect",value:null,emptyString:resolve("bankingapp_function_internationaltransfer_select"),popupName:"Commission Fee"},baseInputContainerClass:"selectComboContainer combo inputfirst"});callService({serviceName:"/internationaltransfer/getFeeTypes",request:{GetFeeTypesRequest:{sourceAccountNumber:this.formData.sourceAccount.accountNumber,targetAccountNumber:this.formData.targetAccount,currency:this.currency.val()}},callback:Bankingapp.framework.Application.proxy(this.updateFeeData,this,true)});this.groupContainer3.append(this.feeType);this.rateInfoLabel=new Bankingapp.ui.Label("",{"class":""});this.groupContainer2.append(this.rateInfoLabel);this.submitButton=new Bankingapp.ui.SubmitButton(resolve("bankingapp_function_transferfunds_continue"),{"class":"sumbit"});this.form.append(this.submitButton);return this.container;},afterSelectCurrency:function(b,a){this.currencySelectValue=a.selected;callService({serviceName:"/internationaltransfer/getFeeTypes",request:{GetFeeTypesRequest:{sourceAccountNumber:this.formData.sourceAccount.accountNumber,targetAccountNumber:this.formData.targetAccount,currency:this.currency.val()}},callback:Bankingapp.framework.Application.proxy(this.updateFeeData,this,true)});this.amountChangeCheck();},updateFeeData:function(a){var b=this;this.feeType.getInputComponent().clearValue();if((a!=undefined)&&a!=null){this.fees=[];this.feeList=a;$.each(this.feeList,function(c,d){debugLog("value: "+d.feeTypeKey);if($.inArray(d.feeTypeKey,b.fees)==-1){b.fees.push(resolve(d.feeTypeKey));debugLog("added, "+resolve(d.feeTypeKey));}});}debugLog(this.fees);this.feeType.getInputComponent().setDatas(this.fees);this.feeType.setValue(this.fees[0]);},getCurrencyData:function(){var a=[];if($.inArray(this.formData.sourceAccount.currency,a)==-1){a.push(this.formData.sourceAccount.currency);}if($.inArray(this.formData.targetAccountCurrency,a)==-1){a.push(this.formData.targetAccountCurrency);}return a;},run:function(){if(this.formData.valueDate&&this.valueDateButton){this.displayValueDate(this.formData.valueDate);}else{this.formData.valueDate=new Date();console.log("run valueDate: "+this.formData.valueDate);}this.amountField.bind("keyup",$.proxy(this.amountChangeCheck,this));},valueDateButtonClickHandler:function(b,a){showDatePicker(Bankingapp.framework.Application.proxy(this.datePickerHandler,this,true));},datePickerHandler:function(a){console.log("datepickhandler valueDate: "+a);this.formData.valueDate=a;this.displayValueDate(a);},displayValueDate:function(a){$("#valueDateButton").find(".row0").text(a.dateFormat(resolve("bankingapp_common_dateFormatPattern")));},submitHandler:function(){debugLog("submitHandler ...");var b=this;this.forecastRequest=this.formData.forecastRequest;if(!this.formChecked){var a={GetTargetPerSourceRateRequest:{SourceCurrency:this.formData.sourceAccount.currency,TargetCurrency:this.forecastRequest.targetAccountCurrency,Currency:this.currency.val(),Amount:this.amountField.val()}};Bankingapp.framework.Application.callService("/internationaltransfer/transfer",a,$.proxy(this.handleCheckAmountResponse,this));}else{this.forecastRequest.description=this.descriptionField.val();this.forecastRequest.amount=this.amountField.val();if(Functions.transferfunds.TransferUtils.isCorporateUser()){this.forecastRequest.referenceNumber=this.referenceField.val();}this.forecastRequest.currency=this.currency.val();this.forecastRequest.feeType=null;$.each(this.feeList,function(c,d){debugLog("value: "+d.feeTypeKey+", selected feetype: "+b.feeType.val());if(resolve(d.feeTypeKey)==b.feeType.val()){debugLog("found code: "+d.feeTypeCode);b.forecastRequest.feeType=d.feeTypeCode;}});debugLog("feeType: "+this.forecastRequest.feeType);if(this.formData.valueDate){if(jQuery.type(this.formData.valueDate)==="date"){this.forecastRequest.valueDate=$().formatDateForRequest(this.formData.valueDate);}else{this.forecastRequest.valueDate=this.formData.valueDate;}}$.extend(this.formData,{description:this.forecastRequest.description,amount:this.forecastRequest.amount,valueDate:this.forecastRequest.valueDate,currency:this.forecastRequest.currency,referenceNumber:this.forecastRequest.referenceNumber,feeType:this.forecastRequest.feeType});setFunctionAttribute(Functions.transferfunds.TransferUtils.INTERNATIONALTRANSFER_FORMDATA,this.formData);setFunctionAttribute(Functions.transferfunds.TransferUtils.INTERNATIONALTRANSFER_FORECAST_REQUEST,this.forecastRequest);callService({serviceName:"/internationaltransfer/forecast",request:{InternationalTransferRequest:getFunctionAttribute(Functions.transferfunds.TransferUtils.INTERNATIONALTRANSFER_FORECAST_REQUEST)},callback:Bankingapp.framework.Application.proxy(this.handleForecastRequest,this,true)});}},handleForecastRequest:function(a){setFunctionAttribute(Functions.transferfunds.TransferUtils.INTERNATIONALTRANSFER_FORECAST_REPLY,a);loadView("view://brd/bankingapp/function/transferfunds/internationaltransfer/sign",null);},businessValidator:function(){var d=getFunctionAttribute(Functions.transferfunds.TransferUtils.PAYMENT_VALUEDATE_MAXDAYS);if(d>0){var b=new Date();var f=new Date();f.setDate(b.getDate()+d);if(f<this.formData.valueDate){showError(resolve("bankingapp_function_internationaltransfer_dateerror")+d+resolve("bankingapp_function_internationaltransfer_dateerror2"));return false;}}var e=this.formData.valueDate;var c=new Date();c=c.setHours(0,0,0,0);if(e<c){console.log("date validation: ");console.log("valuedate: "+e+" yesterday: "+c);showError(resolve("bankingapp_function_internationaltransfer_date_past_error"));return false;}var a=this.currency.val();if(a==null||a==""){showError(resolve("bankingapp_function_internationaltransfer_currencyerror"));return false;}if(this.currency.val()&&Functions.transferfunds.TransferUtils.isFeeTypeShown(this.currency.val(),this.formData.targetAccount)&&!this.feeType.val()){showError(resolve("bankingapp_function_internationaltransfer_feetypeerror"));return false;}return true;},amountChangeCheck:function(){this.forecastRequest=this.formData.forecastRequest;if(this.formData.sourceAccount.currency!=this.forecastRequest.targetAccountCurrency){this.formChecked=false;this.submitButton.setValue(resolve("bankingapp_function_transferfunds_check"));this.rateInfoLabel.html("");}else{this.formChecked=true;this.submitButton.setValue(resolve("bankingapp_function_transferfunds_continue"));}},handleCheckAmountResponse:function(a){debugLog("handleCheckAmountResponse ...");if(a&&a.rateInfoString){this.formChecked=true;this.submitButton.setValue(resolve("bankingapp_function_transferfunds_continue"));this.rateInfoLabel.html(resolve("bankingapp_function_internationaltransfer_amount_in_source_currency")+" "+a.rateInfoString);}else{showError(resolve("bankingapp_function_internationaltransfer_no_interest_rate"));}}});Bankingapp.framework.Application.setView(Functions.transferfunds.internationaltransfer.TransferDetails);