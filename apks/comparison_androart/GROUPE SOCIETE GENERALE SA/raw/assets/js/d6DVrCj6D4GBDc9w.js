$().loadJavaScript("/js/IULobCvIYvlRD7Ub.js");Class.ns("Bankingapp.functions.fxrates");Bankingapp.functions.fxrates.FxRates=Class.extend(Bankingapp.framework.View,{tabSet:null,valueDateString:null,container:null,currencyName:null,rateType:null,rateTypeArray:null,location:null,localCurrency:null,locationCurrency:null,layoutRender:function(){this.container=$("<div>",{id:"fxratesMainContainer"});Bankingapp.framework.Application.unBind("onContextMenuItemPressed");$("body").bind("onContextMenuItemPressed",$.proxy(this.onDefaultContextMenuItemPressedHandler,this));return this.container;},render:function(){var b=[];debugLog(this.rateTypeArray);for(var a in this.rateTypeArray){b.push({contentRenderer:Bankingapp.functions.fxrates.FxRatesContent,itemData:this.rateTypeArray[a]});}this.tabSet=new Bankingapp.ui.TabSet(b,{itemConfig:{getLabel:function(c){return c.resolvedText;}},defaultSelected:0,selectedClass:"tabSelected"});this.tabSet.bind("tabItemClick",$.proxy(this.itemClickHandler,this));this.container.append(this.tabSet);},itemClickHandler:function(c,b){this.rateType=this.tabSet.getSelected().itemData;setFunctionAttribute("SELECTED_RATE_TYPE",this.rateType);if(!this.tabSet.isTabContentRendered()){var a=getFunctionAttribute("FXRATE_LIST_"+this.rateType.typeCode);if(a){this.handleListResult(a);}else{this.setValueDateString(new Date());callService({serviceName:"/fxrate/getrates",request:{data:{rateType:this.rateType.typeCode,valueDate:this.valueDateString,sourceCurrency:this.localCurrency}},callback:Bankingapp.framework.Application.proxy(this.handleListResult,this,true)});}}else{this.tabSet.showContent();}},run:function(){getGeolocationCoordinates(Bankingapp.framework.Application.proxy(this.getGeolocationCoordinatesResult,this,true));},getGeolocationCoordinatesResult:function(a){if(a!=null){reverseGeocoding(a,Bankingapp.framework.Application.proxy(this.reverseGeocodingResult,this,true));}else{this.reverseGeocodingResult(null);}},reverseGeocodingResult:function(a){if(a){for(var c=0;c<a.results.length;c++){if(($.inArray("locality",a.results[c].types)!=-1)&&($.inArray("political",a.results[c].types)!=-1)){var d=a.results[c].address_components;for(var b=0;b<d.length;b++){if(($.inArray("country",d[b].types)!=-1)&&($.inArray("political",d[b].types)!=-1)){this.location=d[b].short_name;setFunctionAttribute("LOCATION_COUNTRY_CODE",this.location);}}}}}this.getExchangeRateParams();},getExchangeRateParams:function(){var a={GetExchangeRatesParamsRequest:{CountryCode:this.location}};Bankingapp.framework.Application.callService("/fxrate/getratesparams",a,$.proxy(this.handleExchangeRateParams,this));},handleExchangeRateParams:function(a){this.localCurrency=a.localCurrency;this.locationCurrency=a.locationCurrency;setFunctionAttribute("LOCATION_COUNTRY_CODE",this.location);setFunctionAttribute("LOCAL_CURRENCY",this.localCurrency);setFunctionAttribute("LOCATION_CURRENCY",this.locationCurrency);this.getRateType();},getRateType:function(){callService({serviceName:"/component/dictionary",request:{DictionaryRequest:{TypeName:"pegasus.exchangerate.dictionary:RateType",Locale:getLocale()}},callback:Bankingapp.framework.Application.proxy(this.handleRateTypeResult,this,true)});},handleRateTypeResult:function(a){this.rateTypeArray=a.dictionaryEntry;this.sortDic();setFunctionAttribute("RATE_TYPE_LIST",this.rateTypeArray);this.render();callService({serviceName:"/component/dictionary",request:{DictionaryRequest:{TypeName:"pegasus.exchangerate.dictionary:Currency",Locale:getLocale()}},callback:Bankingapp.framework.Application.proxy(this.handleCurrencyNameResult,this,true)});},sortDic:function(){var a=this.rateTypeArray;a.sort(function(d,c){return d.typeCode-c.typeCode;});},handleCurrencyNameResult:function(b){var c={};for(var a in b.dictionaryEntry){c[b.dictionaryEntry[a].typeCode]=b.dictionaryEntry[a];}this.currencyName=c;callService({serviceName:"/currency/getCurrencyList",request:{GetCurrencyList:{Resolution:$.fn.getResolution()}},callback:Bankingapp.framework.Application.proxy(this.handleCurrencyListResult,this,true)});},handleCurrencyListResult:function(c){if(c!=null){var d={};for(var b in c){var a=c[b].currency;c[b].name=this.currencyName[a]?this.currencyName[a].resolvedText:null;d[a]=c[b];}setFunctionAttribute("CURRENCY_MAP",d);setFunctionAttribute("CURRENCY_LIST",c);this.tabSet.renderDefault();}},setValueDateString:function(b){var a=b;a.setHours(0,0,0,0);this.valueDateString=$().dateTimeFormatter(a,null);},handleListResult:function(a){setFunctionAttribute("FXRATE_LIST_"+this.rateType.typeCode,a);if(a!=null){if(a){var b=$().dateParserWithoutTime(a[0].fixingTimestamp);this.tabSet.showContent({rateList:a,cacheData:b.dateFormat(resolve("bankingapp_common_timeFormatPattern"))});}}},onDefaultContextMenuItemPressedHandler:function(b,a){if(a=="fxrate_calculator"){if(!this.localCurrency!=this.locationCurrency){if(this.locationCurrency){setFunctionAttribute("SELECTED_CURRENCY",this.locationCurrency);}}setFunctionAttribute("CALCULATOR_START_MODE","L");if(!getFunctionAttribute("SELECTED_CURRENCY")){setFunctionAttribute("SELECTED_CURRENCY",this.localCurrency);}if(!getFunctionAttribute("SELECTED_CURRENCY")){setFunctionAttribute("SELECTED_CURRENCY","RON");}loadView("view://bankingapp/function/fxrates/fxcalculator",null);debugLog("selected currency : "+getFunctionAttribute("SELECTED_CURRENCY"));}else{Bankingapp.framework.event.ContextMenuHandler.onDefaultContextMenuItemPressedHandler(b,a);}}});Bankingapp.framework.Application.setView(Bankingapp.functions.fxrates.FxRates);