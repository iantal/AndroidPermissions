Class.ns("Bankingapp.functions.receivemoney.splitthebill");$().loadJavaScript("/js/1hyf9OWY93mTBudZ.js");Bankingapp.functions.receivemoney.splitthebill.PartnerSelect=Class.extend(Bankingapp.framework.View,{container:null,containerLabel:null,amountField:null,groupContainer:null,partners:null,transactionItem:null,remainingAmount:null,validPhoneNumberPrefixes:null,phonenumberListResourceKey:"bankingapp_function_payment2phone_phone_numberlist",showProgressIndicator:true,progressIndicatorStepCount:3,progressIndicatorCurrentStep:1,layoutRender:function(){Bankingapp.framework.event.BrdServiceMessageHandler.handleMessages();this.container=$("<div>",{id:"partnerSelectMainContainer","class":"maincontainer"});if(this.showProgressIndicator){this.container.append(new Bankingapp.ui.ProgressIndicator(this.progressIndicatorStepCount,this.progressIndicatorCurrentStep));}this.containerLabel=$("<div>",{id:"labelContainer","class":"list maincontainer"});this.splitPartnerLabel=new Bankingapp.ui.Label(resolve("bankingapp_brd_function_splitbill_partnerselect_label"),{"class":"pagetitle separator"});this.containerLabel.append(this.splitPartnerLabel);this.container.append(this.containerLabel);this.containerButton=$("<div>",{id:"selectContactButtonContainer","class":"buttonholdercontainer"});this.selectContactButton=new Bankingapp.ui.ComplexButton(resolve("bankingapp_brd_function_splitbill_partnerselect_selectcontact_button"),{id:"selectContactButton","class":"selectContactButton"});this.selectContactButton.bind("buttonClick",$.proxy(this.selectContactHandler,this));this.containerButton.append(this.selectContactButton);this.container.append(this.containerButton);this.groupContainer=$("<div>",{"class":"groupcontainer"});var b=getFunctionAttribute("selectedPartner");this.beneficiaryField=new Bankingapp.ui.InputField(resolve("bankingapp_brd_function_splitbill_partnerselect_beneficiaryname_field"),{id:"beneficiaryName",name:"beneficiaryName",type:"text",value:(b?b.partnerName:""),validation:{required:true,maxlength:150}});this.groupContainer.append(this.beneficiaryField);this.phoneNumber=new Bankingapp.ui.InputField(resolve("bankingapp_brd_function_splitbill_partnerselect_phonenumber_field"),{id:"phoneNumber",name:"phoneNumber",type:"text",value:(b?b.phoneNumber:""),inputMaskPattern:/[+\d]/,validation:{required:true,maxlength:200,whitelist:false}});this.groupContainer.append(this.phoneNumber);this.partners=getFunctionAttribute("splitPartners");this.transactionItem=getFunctionAttribute(Functions.transferfunds.TransferUtils.SPLITBILL_FORMDATA).transactionItem;var a=0;if(getFunctionAttribute("remainingAmount")==null||getFunctionAttribute("remainingAmount")==undefined){if(this.partners!=undefined&&this.partners!=null){for(var c=0;c<this.partners.length;++c){a+=this.roundDecimal(parseFloat(this.partners[c].amount),2);}}this.remainingAmount=this.roundDecimal(parseFloat(this.transactionItem.amount)-a,2);}else{this.remainingAmount=getFunctionAttribute("remainingAmount");}this.amountField=new Bankingapp.ui.InputField(resolve("bankingapp_brd_function_splitbill_partnerselect_amount_field"),{id:"amount",name:"amount",type:Functions.transferfunds.TransferUtils.getAmountInputFieldType(),value:(b?b.amount:this.roundDecimal(this.remainingAmount/2,2)),inputMaskPattern:/[0-9.,]/,validation:{whitelist:false,required:true,min:0,max:999999999999,number:true,maxlength:12}});this.groupContainer.append(this.amountField);this.containerButton=$("<div>",{id:"addContactButtonContainer","class":"buttonholdercontainer"});this.form=new Bankingapp.ui.Form({id:"partnerSelectForm",submitHandler:$.proxy(this.submitHandler,this),businessValidationHandler:$.proxy(this.businessValidator,this),"class":"partner-select-form"});this.form.append(this.groupContainer);var d;if(getFunctionAttribute("partnerFunction")=="add"){d=resolve("bankingapp_brd_function_splitbill_partnerselect_add_button");}else{this.beneficiaryField.disable();this.phoneNumber.disable();this.amountField.disable();d=resolve("bankingapp_brd_function_splitbill_partnerselect_remove_button");}this.form.append(new Bankingapp.ui.SubmitButton(d,{"class":"submit"}));this.container.append(this.form);return this.container;},run:function(){},removeContactHandler:function(){for(var a=0;a<this.partners.length;++a){if(this.partners[a].partnerName==this.beneficiaryField.val()&&this.partners[a].amount==this.amountField.val()&&this.partners[a].phoneNumber==this.phoneNumber.val()){this.partners.splice(a,1);setFunctionAttribute("remainingAmount",parseFloat(this.remainingAmount)+parseFloat(this.amountField.val()));}}setFunctionAttribute("splitPartners",this.partners);loadView("view://brd/bankingapp/function/receivemoney/splitthebill/splitsumm",null);},businessValidator:function(){if(getFunctionAttribute("partnerFunction")=="add"){var f=false;this.validPhoneNumberPrefixes=getFunctionAttribute("phoneNumberPrefix");if(this.validPhoneNumberPrefixes){var g=this.validPhoneNumberPrefixes.split(",");var c=this.phoneNumber.val();var b=null;var a=null;if(c.indexOf("+")==0){if(c.length==12&&c.substring(1,3)=="40"){b=c.substring(3,5);a=c.substring(5,12);f=true;}}else{if(c.indexOf("00")==0){if(c.length==13&&c.substring(2,4)=="40"){b=c.substring(4,6);a=c.substring(6,13);f=true;}}else{if(c.indexOf("0")==0){if(c.length==10){b=c.substring(1,3);a=c.substring(3,10);f=true;}}}}if(f){f=false;for(var e=0;e<g.length;e++){var d=g[e];if(d==b){f=true;break;}}}if(!f){showError(resolve("bankingapp_brd_function_splitbill_partnerselect_phone_validation"));return false;}this.phoneNumber.setValue("+40"+b+a);}if(this.partners!=undefined&&this.partners!=null){for(var e=0;e<this.partners.length;++e){if(this.partners[e].phoneNumber==this.phoneNumber.val()){showError(resolve("bankingapp_brd_function_splitbill_partnerselect_partner_exist_error"));return false;}}}if(parseFloat(this.amountField.val())<=0){showError(resolve("bankingapp_brd_function_splitbill_partnerselect_amount_min_error"));return false;}if(parseFloat(this.amountField.val())>this.remainingAmount){showError(resolve("bankingapp_brd_function_splitbill_partnerselect_amount_max_error",{maxamount:this.remainingAmount}));return false;}}return true;},handlePartnerRequest:function(b){if(b.isValidPartner){var a={partnerName:this.beneficiaryField.val(),amount:this.roundDecimal(parseFloat(this.amountField.val()),2),phoneNumber:this.phoneNumber.val(),splitPartnerCurrency:this.transactionItem.currency};if(this.partners!=undefined&&this.partners!=null){this.partners.push(a);setFunctionAttribute("splitPartners",this.partners);}else{setFunctionAttribute("splitPartners",[a]);}setFunctionAttribute("remainingAmount",(parseFloat(this.remainingAmount)-parseFloat(this.amountField.val())).toFixed(2));loadView("view://brd/bankingapp/function/receivemoney/splitthebill/splitsumm",null);}},submitHandler:function(){if(getFunctionAttribute("partnerFunction")=="add"){this.addContactHandler();}else{if(getFunctionAttribute("partnerFunction")=="remove"){this.removeContactHandler();}}},addContactHandler:function(){var a={phoneNumber:this.phoneNumber.val(),partnerAmount:parseFloat(this.amountField.val()),totalAmount:this.transactionItem.amount,remainingAmount:this.remainingAmount,};Bankingapp.framework.Application.callService("/splitbilltransfer/validatePartner",{ValidatePartnerRequest:a},$.proxy(this.handlePartnerRequest,this));},selectContactHandler:function(){showContactPicker(Bankingapp.framework.Application.proxy(this.showContactPickerCallback,this,true));},showContactPickerCallback:function(a){this.beneficiaryField.setValue(this.joinNames(a.name));if(a.phoneNumbers.length>1){var c=[];for(var b=0;b<a.phoneNumbers.length;b++){var d=this.formPhoneNumber(a.phoneNumbers[b].phoneNumber);if(d){c.push(d);}}showListPicker(resolve(this.phonenumberListResourceKey),c,Bankingapp.framework.Application.proxy(this.showListPickerCallback,this,true));}else{var d=this.formPhoneNumber(a.phoneNumbers[0].phoneNumber);if(d){this.phoneNumber.setValue(d);}}},showListPickerCallback:function(a){this.phoneNumber.setValue(a);},formPhoneNumber:function(a){var b=undefined;if(a){b=a.replace(/-/g,"").replace(/\//g,"").replace(/\s/g,"");if(b.indexOf("(072)")==0){b=b.replace("(072)","+4072");}b=b.replace("(","").replace(")","");}return b;},joinNames:function(b){var a=(b.prefix?b.prefix+" ":"")+(b.firstName?b.firstName+" ":"")+(b.middleName?b.middleName+" ":"")+(b.lastName?b.lastName+" ":"")+(b.suffix?b.suffix+" ":"");return a.trim();},roundDecimal:function(b,a){return Math.round(b*Math.pow(10,a))/Math.pow(10,a);}});Bankingapp.framework.Application.setView(Bankingapp.functions.receivemoney.splitthebill.PartnerSelect);